<!DOCTYPE html>
<html lang="en">
<head>
  <style>body{opacity:1!important;visibility:visible!important}</style>
  <meta charset="UTF-8" />
  <title>Admin • Disputes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="assets/styles.css">
  <link rel="stylesheet" href="assets/styles/admin.css">
  <script type="module" src="assets/scripts/auth.js"></script>

  <style>
    :root{ --ink:#1a2230; --muted:#5c6b7a; --line:#e8edf3; --card:#fff; --bg:#faf7f3; --accent:#b4975a; --ok:#2e7d32; --bad:#b00020; --warn:#b26a00; }
    @media (prefers-color-scheme: dark){ :root{ --bg:#0f141b; --card:#121a23; --ink:#e8edf3; --muted:#8ea0b5; --line:#203040; } }

    body{ margin:0; background:var(--bg); color:var(--ink); font:15px/1.55 Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,sans-serif; }

    header[role="banner"]{ padding:12px 18px; border-bottom:1px solid var(--line); position:sticky; top:0; z-index:20; background:color-mix(in srgb, var(--bg) 88%, transparent); backdrop-filter:saturate(120%) blur(6px); }
    header nav a{ color:var(--muted); text-decoration:none; margin-right:14px; padding:6px 10px; border-radius:10px; }
    header nav a.active{ color:var(--ink); background:color-mix(in srgb, var(--line) 55%, transparent); }

    main{ max-width:1100px; margin:0 auto; padding:18px; }
    h1{ margin:18px 0; font-weight:600; }

    .toolbar{ display:grid; grid-template-columns: 1fr auto auto auto; gap:10px; align-items:center; padding:12px; background:var(--card); border:1px solid var(--line); border-radius:14px; box-shadow: 0 1px 0 rgba(0,0,0,.03); position:sticky; top:64px; z-index:10; }
    .toolbar input[type="search"], .toolbar select{ appearance:none; font:inherit; color:var(--ink); background:var(--card); border:1px solid var(--line); border-radius:10px; padding:10px 12px; outline:none; transition:border-color .15s ease, box-shadow .15s ease; }
    .toolbar input[type="search"]:focus, .toolbar select:focus{ border-color:var(--accent); box-shadow:0 0 0 3px color-mix(in srgb, var(--accent) 28%, transparent); }
    .toolbar .group{ display:flex; gap:8px; justify-content:flex-end; align-items:center; }
    .switch{ display:inline-flex; gap:8px; align-items:center; color:var(--muted); }

    .btn{ border:1px solid var(--line); background:var(--card); color:var(--ink); padding:9px 12px; border-radius:10px; cursor:pointer; transition:transform .08s ease, background .18s ease, border-color .18s ease; }
    .btn:hover{ background:color-mix(in srgb, var(--line) 40%, transparent); }
    .btn:active{ transform:translateY(1px); }
    .btn.primary{ background:linear-gradient(180deg, color-mix(in srgb, var(--accent) 14%, var(--card)), var(--card)); border-color:color-mix(in srgb, var(--accent) 55%, var(--line)); }
    .btn.ok{ border-color:color-mix(in srgb, var(--ok) 55%, var(--line)); }
    .btn.bad{ border-color:color-mix(in srgb, var(--bad) 55%, var(--line)); }

    .list{ display:grid; grid-template-columns: repeat(auto-fill,minmax(360px,1fr)); gap:14px; margin-top:14px; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:14px; padding:12px; display:flex; flex-direction:column; gap:10px; box-shadow:0 1px 1px rgba(0,0,0,.03); }
    .title{ font-weight:600; letter-spacing:.2px; }
    .meta{ display:flex; flex-wrap:wrap; gap:8px; }
    .badge{ font-size:12px; padding:6px 8px; border:1px solid var(--line); border-radius:999px; color:var(--muted); background:color-mix(in srgb, var(--line) 30%, transparent); }
    .message{ white-space:pre-wrap; line-height:1.45; border:1px dashed var(--line); border-radius:10px; padding:8px; background:color-mix(in srgb, var(--line) 20%, transparent); }
    .actions{ display:flex; flex-wrap:wrap; gap:8px; }

    .skeleton{ height:136px; border-radius:14px; background:linear-gradient(90deg, rgba(0,0,0,.05), rgba(0,0,0,.08), rgba(0,0,0,.05)); background-size:200% 100%; animation: shimmer 1.1s ease-in-out infinite; border:1px solid var(--line); }
    @keyframes shimmer{ from{ background-position:200% 0 } to{ background-position:-200% 0 } }
    @media (prefers-reduced-motion: reduce){ .skeleton{ animation:none } .btn,.card{ transition:none } }

    #count{ margin:10px 2px; color:var(--muted); }
    .small{ color:var(--muted); font-size:.9rem; }

    .toast{ position:fixed; left:50%; bottom:22px; transform:translateX(-50%) translateY(20px); background:#111827; color:#fff; padding:10px 14px; border-radius:12px; opacity:0; pointer-events:none; transition:opacity .2s ease, transform .2s ease; }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(0); }
    .toast.err{ background:var(--bad); }
  </style>
</head>
<body>
  <header role="banner">
    <nav aria-label="Primary">
      <a href="index.html">Home</a>
      <a href="admin-dashboard.html">Admin</a>
      <a href="admin-cases.html">Cases</a>
      <a href="admin-disputes.html" class="active" aria-current="page">Disputes</a>
      <a href="login.html">Login</a>
    </nav>
  </header>

  <main role="main">
    <h1>Disputes</h1>

    <div class="toolbar" role="region" aria-label="Filters">
      <input id="q" type="search" placeholder="Search case title, message, or email…" aria-label="Search disputes" />
      <select id="statusF" aria-label="Status filter">
        <option value="open">Open</option>
        <option value="resolved">Resolved</option>
        <option value="rejected">Rejected</option>
      </select>
      <select id="sortF" aria-label="Sort">
        <option value="-createdAt">Newest first</option>
        <option value="createdAt">Oldest first</option>
        <option value="caseId.title">Case title (A–Z)</option>
      </select>
      <div class="group">
        <label class="switch" for="autoRefresh" title="Refresh every 30s">
          <input type="checkbox" id="autoRefresh" /> Auto-refresh
        </label>
        <button id="refresh" class="btn primary" type="button">Refresh</button>
      </div>
    </div>

    <div id="count" class="small" aria-live="polite"></div>

    <div id="list" class="list" aria-live="polite" aria-busy="true">
      <div class="skeleton"></div><div class="skeleton"></div>
    </div>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite">Saved</div>

  <script type="module">
    import { secureFetch, fetchCSRF } from './assets/scripts/auth.js';

    const API_BASE = '/api';

    const listEl   = document.getElementById('list');
    const q        = document.getElementById('q');
    const statusF  = document.getElementById('statusF');
    const sortF    = document.getElementById('sortF');
    const countEl  = document.getElementById('count');
    const toastEl  = document.getElementById('toast');
    const refreshB = document.getElementById('refresh');
    const autoRefresh = document.getElementById('autoRefresh');

    let all = [];
    let timer = null;

    // ---------- utils ----------
    const esc = (s) => String(s ?? '').replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
    const by  = (o,p,fb='') => p.split('.').reduce((a,k)=>a?.[k],o) ?? fb;
    const fmt = (s) => s ? new Date(s).toLocaleString() : '';
    const toast = (m, t='ok') => { toastEl.textContent = m; toastEl.className = 'toast show ' + (t === 'err' ? 'err' : 'ok'); setTimeout(() => toastEl.classList.remove('show'), 1500); };
    const debounce = (fn, ms=250) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };
    const setBusy = (on) => listEl.setAttribute('aria-busy', on ? 'true' : 'false');

    // persist filters locally
    const KEY='adminDisputesFilters:v1';
    const saveFilters=()=>{ try{ localStorage.setItem(KEY, JSON.stringify({ q:q.value||'', st:statusF.value||'open', sort:sortF.value||'-createdAt', auto:autoRefresh.checked||false })); }catch{} };
    const loadFilters=()=>{ try{ const s=JSON.parse(localStorage.getItem(KEY)||'{}'); if(s.q!=null) q.value=s.q; if(s.st!=null) statusF.value=s.st; if(s.sort!=null) sortF.value=s.sort; if(typeof s.auto==='boolean') autoRefresh.checked=s.auto; }catch{} };

    function applySort(arr){
      const key = sortF.value || '-createdAt';
      const dir = key.startsWith('-') ? -1 : 1; const field = key.replace(/^-/,'');
      const collator = new Intl.Collator(undefined, { numeric:true, sensitivity:'base' });
      return [...arr].sort((a,b)=>{
        const av = by(a, field); const bv = by(b, field);
        if (field === 'createdAt') return dir * ( (new Date(av||0)) - (new Date(bv||0)) );
        if (typeof av === 'string' && typeof bv === 'string') return dir * collator.compare(av, bv);
        return dir * ((av>bv)-(av<bv));
      });
    }

    async function ensureAdmin() {
      try {
        const r = await fetch(`${API_BASE}/auth/me`, { credentials: 'include' });
        if (!r.ok) throw new Error('not authed');
        const { user } = await r.json();
        if (!user || user.role !== 'admin') throw new Error('not admin');
        return user;
      } catch {
        location.href = 'login.html';
        throw new Error('redirecting');
      }
    }

    // ---------- data ----------
    async function fetchDisputes() {
      setBusy(true);
      listEl.innerHTML = `<div class="skeleton"></div><div class="skeleton"></div>`;
      try {
        // status filter drives endpoint: open vs all
        const endpoint = statusF.value === 'open' ? `${API_BASE}/disputes/open` : `${API_BASE}/disputes`;
        const r = await fetch(endpoint, { credentials: 'include' });
        let data = r.ok ? await r.json() : [];
        if (!Array.isArray(data)) data = [];
        all = data;
        render();
      } catch {
        listEl.innerHTML = `<div class="small">Failed to load disputes.</div>`;
      } finally { setBusy(false); }
    }

    function filtered() {
      const term = (q.value || '').trim().toLowerCase();
      const st = statusF.value;
      return all.filter(d => {
        if (st && d.status !== st && st !== 'open') return false; // when 'open', endpoint already filtered
        if (!term) return true;
        const hay = [ String(by(d,'caseId.title','')).toLowerCase(), String(by(d,'raisedBy.email','')).toLowerCase(), String(d.message||'').toLowerCase(), String(d._id||'').toLowerCase() ].join(' ');
        return hay.includes(term);
      });
    }

    function render() {
      saveFilters();
      const items = applySort( filtered() );
      countEl.textContent = items.length ? `${items.length} ${statusF.value || ''}`.trim() : `No ${statusF.value || ''} disputes.`.trim();
      if (!items.length) { listEl.innerHTML = `<div class="small">Nothing to review.</div>`; return; }

      listEl.innerHTML = items.map(d => {
        const id     = esc(d._id);
        const title  = esc(by(d,'caseId.title') || '(Deleted case)');
        const email  = esc(by(d,'raisedBy.email') || 'Unknown');
        const when   = d.createdAt ? esc(fmt(d.createdAt)) : '';
        const status = esc(d.status || 'open');
        const msg    = esc(d.message || '');
        return `
          <div class="card" data-id="${id}" tabindex="0" role="group" aria-label="Dispute ${id}">
            <div class="title">${title}</div>
            <div class="meta">
              <span class="badge">From: ${email}</span>
              ${when ? `<span class="badge">Created: ${when}</span>` : ''}
              <span class="badge">Status: ${status}</span>
            </div>
            <div class="message">${msg}</div>
            <div class="actions" role="group" aria-label="Actions">
              ${status!== 'resolved' ? `<button class="btn ok"  data-action="resolve" aria-label="Mark resolved">Mark Resolved</button>` : ''}
              ${status!== 'rejected' ? `<button class="btn bad" data-action="reject"  aria-label="Reject">Reject</button>` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    async function act(id, action) {
      const url = action === 'resolve'
        ? `${API_BASE}/disputes/${encodeURIComponent(id)}/resolve`
        : `${API_BASE}/disputes/${encodeURIComponent(id)}/reject`;
      try {
        await fetchCSRF();
        const r = await secureFetch(url, { method: 'POST' });
        if (!r.ok) throw new Error('Action failed');
        // Update local list depending on active filter
        if (statusF.value === 'open') all = all.filter(x => x._id !== id);
        else {
          const i = all.findIndex(x=>x._id===id); if(i>-1) all[i] = { ...all[i], status: action==='resolve' ? 'resolved' : 'rejected' };
        }
        render();
        toast(action === 'resolve' ? 'Marked resolved' : 'Rejected');
      } catch (e) { toast(e?.message || 'Error', 'err'); }
    }

    // ---------- events ----------
    document.addEventListener('click', (e) => {
      const card = e.target.closest('.card'); if (!card) return;
      if (e.target.dataset.action === 'resolve') act(card.dataset.id, 'resolve');
      if (e.target.dataset.action === 'reject')  act(card.dataset.id, 'reject');
    });

    refreshB?.addEventListener('click', fetchDisputes);
    q.addEventListener('input', debounce(render, 180));
    statusF.addEventListener('change', () => { fetchDisputes(); });
    sortF.addEventListener('change', render);
    autoRefresh.addEventListener('change', () => { clearInterval(timer); if (autoRefresh.checked) timer = setInterval(fetchDisputes, 30000); saveFilters(); });

    // improve keyboard UX
    q.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); render(); }});

    document.addEventListener('DOMContentLoaded', () => document.body.classList.add('loaded'));

    // ---------- boot ----------
    (async function boot() {
      loadFilters();
      await ensureAdmin();
      await fetchDisputes();
      if (autoRefresh.checked) timer = setInterval(fetchDisputes, 30000);
    })();
  </script>
</body>
</html>
