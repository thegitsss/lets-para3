<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta name="theme-color" content="#0B2A4A">
  <style>body{opacity:1!important;visibility:visible!important}</style>
  <meta charset="UTF-8" />
  <title>Admin • Cases</title>
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png" />
  <link rel="manifest" href="site.webmanifest" />
  <link rel="mask-icon" href="maskable-icon.png" color="#0B2A4A" />

  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="assets/styles/styles.css">
  <link rel="stylesheet" href="assets/styles/admin.css">
  <script type="module" src="assets/scripts/auth.js"></script>

  <!-- Local, page‑scoped polish without touching global bundles -->
  <style>
    :root{
      --ink:#1a2230; --muted:#5c6b7a; --gold:#b4975a; --line:#e8edf3; --card:#fff; --bg:#faf7f3; --navy:#27394d;
      --ok:#2e7d32; --bad:#b00020; --warn:#b26a00; --info:#1e88e5;
    }
    @media (prefers-color-scheme: dark){
      :root{ --bg:#0f141b; --card:#121a23; --ink:#e8edf3; --muted:#8ea0b5; --line:#203040; }
    }
    /* layout */
    body{ margin:0; background:var(--bg); color:var(--ink); font:15px/1.55 Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,sans-serif; }
    header.container{ padding:12px 18px; border-bottom:1px solid var(--line); backdrop-filter:saturate(120%) blur(6px); position:sticky; top:0; z-index:20; background:color-mix(in srgb, var(--bg) 88%, transparent); }
    header nav a{ color:var(--muted); text-decoration:none; margin-right:14px; padding:6px 10px; border-radius:10px; transition:background .2s ease, color .2s ease; }
    header nav a:hover{ background:color-mix(in srgb, var(--line) 35%, transparent); color:var(--ink); }
    header nav a.active{ color:var(--ink); background:color-mix(in srgb, var(--line) 55%, transparent); }

    main.container{ max-width:1100px; margin:0 auto; padding:18px; }
    h1{ margin:18px 0; font-weight:600; letter-spacing:.2px; }

    /* toolbar */
    .toolbar{ display:grid; grid-template-columns: 1fr auto auto auto; gap:10px; align-items:center; padding:12px; background:var(--card); border:1px solid var(--line); border-radius:14px; box-shadow: 0 1px 0 rgba(0,0,0,.03); position:sticky; top:64px; z-index:10; }
    .toolbar input[type="search"], .toolbar select{ appearance:none; -webkit-appearance:none; font:inherit; color:var(--ink); background:var(--card); border:1px solid var(--line); border-radius:10px; padding:10px 12px; outline:none; transition:border-color .15s ease, box-shadow .15s ease, background-color .2s ease; }
    .toolbar input[type="search"]:focus, .toolbar select:focus{ border-color:var(--gold); box-shadow:0 0 0 3px color-mix(in srgb, var(--gold) 28%, transparent); }
    .toolbar .switch{ display:inline-flex; gap:8px; align-items:center; color:var(--muted); cursor:pointer; user-select:none; }
    .toolbar .switch input{ margin-right:4px; }
    .toolbar .btn{ height:38px; }
    @media (max-width: 720px){ .toolbar{ grid-template-columns:1fr; position:static; } }

    /* buttons */
    .btn{ border:1px solid var(--line); background:var(--card); color:var(--ink); padding:9px 12px; border-radius:10px; cursor:pointer; transition:transform .08s ease, background .18s ease, border-color .18s ease; }
    .btn:hover{ background:color-mix(in srgb, var(--line) 40%, transparent); }
    .btn:active{ transform:translateY(1px); }
    .btn.primary{ background:linear-gradient(180deg, color-mix(in srgb, var(--gold) 22%, var(--card)), var(--card)); border-color:color-mix(in srgb, var(--gold) 65%, var(--line)); }
    .btn.primary:hover{ background:linear-gradient(180deg, color-mix(in srgb, var(--gold) 35%, var(--card)), var(--card)); }
    .btn.ok{ border-color:color-mix(in srgb, var(--ok) 55%, var(--line)); }
    .btn.bad{ border-color:color-mix(in srgb, var(--bad) 55%, var(--line)); }

    /* list + card */
    .list{ display:grid; grid-template-columns: repeat(auto-fill,minmax(320px,1fr)); gap:14px; margin-top:14px; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:14px; padding:12px; display:flex; flex-direction:column; gap:10px; box-shadow:0 1px 1px rgba(0,0,0,.03); transition: box-shadow .2s ease, transform .08s ease, border-color .2s ease; }
    .card:hover{ border-color:color-mix(in srgb, var(--gold) 45%, var(--line)); box-shadow:0 6px 18px rgba(0,0,0,.06); }
    .card:focus-within{ outline:none; box-shadow:0 0 0 3px color-mix(in srgb, var(--gold) 30%, transparent); }
    .head{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .title{ font-weight:600; letter-spacing:.2px; }
    .meta{ display:flex; flex-wrap:wrap; gap:8px; }
    .badge{ font-size:12px; padding:6px 8px; border:1px solid var(--line); border-radius:999px; color:var(--muted); background:color-mix(in srgb, var(--line) 30%, transparent); }
    .badge.status{ color:#fff; border-color:transparent; }
    .s-open{ background:linear-gradient(180deg, color-mix(in srgb, var(--info) 65%, black 10%), var(--info)); }
    .s-assigned{ background:linear-gradient(180deg, color-mix(in srgb, var(--gold) 65%, black 10%), var(--gold)); }
    .s-active{ background:linear-gradient(180deg, color-mix(in srgb, var(--ok) 70%, black 5%), var(--ok)); }
    .s-awaiting_documents{ background:linear-gradient(180deg, color-mix(in srgb, var(--warn) 70%, black 5%), var(--warn)); }
    .s-reviewing{ background:linear-gradient(180deg, color-mix(in srgb, var(--info) 55%, var(--gold)), var(--info)); }
    .s-in_progress{ background:linear-gradient(180deg, color-mix(in srgb, var(--info) 80%, black 5%), var(--info)); }
    .s-completed{ background:linear-gradient(180deg, color-mix(in srgb, var(--ok) 85%, black 5%), var(--ok)); }
    .s-disputed{ background:linear-gradient(180deg, color-mix(in srgb, var(--bad) 70%, black 5%), var(--bad)); }
    .s-cancelled{ background:linear-gradient(180deg, color-mix(in srgb, var(--muted) 70%, black 10%), var(--muted)); }
    .s-closed{ background:linear-gradient(180deg, color-mix(in srgb, var(--muted) 65%, black 10%), var(--muted)); }

    .actions{ display:flex; flex-wrap:wrap; gap:8px; margin-top:2px; }

    /* skeleton */
    .skeleton{ height:122px; border-radius:14px; background:linear-gradient(90deg, rgba(0,0,0,.05), rgba(0,0,0,.08), rgba(0,0,0,.05)); background-size: 200% 100%; animation: shimmer 1.15s ease-in-out infinite; border:1px solid var(--line); }
    @keyframes shimmer{ from{ background-position:200% 0 } to{ background-position: -200% 0 } }
    @media (prefers-reduced-motion: reduce){ .skeleton{ animation: none; } .btn, .card{ transition:none } }

    /* count + toast */
    #count{ margin:10px 2px; color:var(--muted); }
    .small{ color:var(--muted); font-size:13px; }
    .toast{ position:fixed; left:50%; bottom:22px; transform:translateX(-50%) translateY(20px); background:var(--ink); color:#fff; padding:10px 14px; border-radius:12px; opacity:0; pointer-events:none; transition:opacity .2s ease, transform .2s ease; }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(0); }
    .toast.err{ background:var(--bad); }

    /* sort dropdown (added) */
    .toolbar .group{ display:flex; gap:10px; align-items:center; justify-content:flex-end; }
  </style>
</head>
<body>
  <header role="banner" class="container">
    <nav aria-label="Primary">
      <a href="index.html">Home</a>
      <a href="index.html#admin-pending-users">Admin</a>
      <a href="admin-cases.html" class="active" aria-current="page">Cases</a>
      <a href="admin-disputes.html">Disputes</a>
      <a href="login.html">Login</a>
    </nav>
  </header>

  <main class="container" role="main">
    <h1>Cases</h1>

    <div class="toolbar" role="region" aria-label="Filters">
      <input id="q" type="search" placeholder="Search title, ID, creator email/name…" aria-label="Search cases"/>
      <select id="statusF" aria-label="Filter by status">
        <option value="">All statuses</option>
        <option value="open">Open</option>
        <option value="assigned">Assigned</option>
        <option value="active">Active</option>
        <option value="awaiting_documents">Awaiting Documents</option>
        <option value="reviewing">Reviewing</option>
        <option value="in_progress">In Progress</option>
        <option value="completed">Completed</option>
        <option value="disputed">Disputed</option>
        <option value="cancelled">Cancelled</option>
        <option value="closed">Closed</option>
      </select>
      <select id="sortF" aria-label="Sort cases">
        <option value="-createdAt">Newest first</option>
        <option value="createdAt">Oldest first</option>
        <option value="title">Title (A–Z)</option>
        <option value="status">Status</option>
      </select>
      <div class="group">
        <label class="switch" for="autoRefresh" title="Refresh every 30s">
          <input type="checkbox" id="autoRefresh" />
          <span>Auto‑refresh</span>
        </label>
        <button id="refresh" class="btn primary" type="button" title="Reload cases">Refresh</button>
      </div>
    </div>

    <div id="count" class="small" aria-live="polite"></div>

    <div id="list" class="list" aria-live="polite" aria-busy="true">
      <div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div>
    </div>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite">Saved</div>

  <script type="module">
    import { secureFetch, fetchCSRF } from './assets/scripts/auth.js';

    const API_BASE = '/api';
    const listEl = document.getElementById('list');
    const q = document.getElementById('q');
    const statusF = document.getElementById('statusF');
    const sortF = document.getElementById('sortF');
    const countEl = document.getElementById('count');
    const toastEl = document.getElementById('toast');
    const autoRefresh = document.getElementById('autoRefresh');
    const refreshBtn = document.getElementById('refresh');

    let allCases = [];
    let pollTimer = null;

    // --- utils -------------------------------------------------------
    const toast = (m, t='ok') => {
      toastEl.textContent = m;
      toastEl.className = 'toast show ' + (t === 'err' ? 'err' : 'ok');
      setTimeout(() => toastEl.classList.remove('show'), 1600);
    };
    const by = (o,p,fb='') => p.split('.').reduce((a,k)=>a?.[k],o) ?? fb;
    const safe = (v,f='') => (v ?? f);
    const fmt = s => s ? new Date(s).toLocaleString() : '';
    const esc = s => String(s ?? '').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
    const setBusy = (on) => listEl?.setAttribute('aria-busy', on ? 'true' : 'false');
    const debounce = (fn, ms=250) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; };
    const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));
    const STATUS_ORDER = ["open","assigned","active","awaiting_documents","reviewing","in_progress","completed","disputed","cancelled","closed"];
    const STATUS_LABELS = {
      open: "Open",
      assigned: "Assigned",
      active: "Active",
      awaiting_documents: "Awaiting Documents",
      reviewing: "Reviewing",
      in_progress: "In Progress",
      completed: "Completed",
      disputed: "Disputed",
      cancelled: "Cancelled",
      closed: "Closed",
    };
    const statusLabel = (s) => STATUS_LABELS[s] || (String(s || "").replace(/_/g, " ").replace(/\b\w/g, ch => ch.toUpperCase()) || "Unknown");
    const statusClass = (s = "") => (STATUS_ORDER.includes(s) ? `s-${s}` : "s-open");
    const userLabel = (person, fallback = "Unassigned") => {
      if (!person) return fallback;
      const name = `${person.firstName || ""} ${person.lastName || ""}`.trim();
      return name || person.email || fallback;
    };

    // persist filters per admin
    const KEY = 'adminCasesFilters:v1';
    const saveFilters = () => {
      const state = { q:q.value||'', status:statusF.value||'', sort:sortF.value||'', auto:autoRefresh.checked||false };
      try{ localStorage.setItem(KEY, JSON.stringify(state)); }catch{}
    };
    const loadFilters = () => {
      try{
        const s = JSON.parse(localStorage.getItem(KEY)||'{}');
        if (s.q!=null) q.value = s.q; if (s.status!=null) statusF.value = s.status; if (s.sort!=null) sortF.value = s.sort; if (typeof s.auto==='boolean') autoRefresh.checked = s.auto;
      }catch{}
    };

    // --- auth gate: must be admin -----------------------------------
    async function ensureAdmin() {
      try {
        const r = await secureFetch(`${API_BASE}/auth/me`);
        if (!r.ok) throw new Error('not authed');
        const { user } = await r.json();
        if (!user || user.role !== 'admin') throw new Error('not admin');
        return user;
      } catch {
        location.href = 'login.html';
        throw new Error('redirecting');
      }
    }

    // --- data --------------------------------------------------------
    async function fetchCases() {
      setBusy(true);
      listEl.innerHTML = `
        <div class="skeleton"></div>
        <div class="skeleton"></div>
        <div class="skeleton"></div>`;
      try {
        const r = await secureFetch(`${API_BASE}/admin/cases`);
        const data = r.ok ? await r.json() : {};
        allCases = Array.isArray(data?.cases) ? data.cases : [];
        render();
      } catch {
        listEl.innerHTML = `<div class="small">Failed to load cases.</div>`;
      } finally {
        setBusy(false);
      }
    }

    function applySort(arr){
      const key = sortF.value || '-createdAt';
      const dir = key.startsWith('-') ? -1 : 1; const field = key.replace(/^-/,'');
      const collator = new Intl.Collator(undefined, { numeric:true, sensitivity:'base' });
      return [...arr].sort((a,b)=>{
        const av = by(a, field); const bv = by(b, field);
        if (field === 'createdAt') return dir * ( (new Date(av||0)) - (new Date(bv||0)) );
        if (typeof av === 'string' && typeof bv === 'string') return dir * collator.compare(av, bv);
        return dir * ((av>bv)-(av<bv));
      });
    }

    function filtered() {
      const term = (q.value || '').trim().toLowerCase();
      const st = statusF.value;
      return allCases.filter(c => {
        if (st && c.status !== st) return false;
        if (!term) return true;
        const attorney = userLabel(c.attorney, "");
        const paralegal = userLabel(c.paralegal, "");
        const hay = [
          safe(c.title),
          safe(c.practiceArea),
          safe(c.details),
          safe(c.status),
          safe(c._id),
          attorney,
          paralegal,
        ].join(" ").toLowerCase();
        return hay.includes(term);
      });
    }

    function render() {
      saveFilters();
      const items = applySort( filtered() );
      const total = allCases.length;
      countEl.textContent = total ? `${items.length} matching • ${total} total` : 'No cases yet.';
      if (!items.length) {
        listEl.innerHTML = `<div class="small">Nothing to show.</div>`;
        return;
      }

      listEl.innerHTML = items.map(c => {
        const id = esc(c._id || c.id);
        const title = esc(c.title || 'Untitled Case');
        const attorney = esc(userLabel(c.attorney, 'Unknown'));
        const paralegal = esc(userLabel(c.paralegal, 'Unassigned'));
        const createdAt = fmt(c.createdAt);
        const updatedAt = fmt(c.updatedAt);
        const practice = c.practiceArea ? `<span class="badge">Practice: ${esc(c.practiceArea)}</span>` : '';
        const preview = (c.details || '').trim();
        const statusText = esc(statusLabel(c.status));

        return `
          <div class="card" data-id="${id}" tabindex="0" role="group" aria-label="Case ${id}">
            <div class="head">
              <div class="title">${title}</div>
              <div class="small">#${id}</div>
            </div>
            ${preview ? `<p class="small" style="margin:4px 0 6px; color:var(--muted);">${esc(preview.slice(0, 220))}${preview.length > 220 ? "&hellip;" : ""}</p>` : ""}
            <div class="meta" aria-label="Case metadata">
              <span class="badge">Attorney: ${attorney}</span>
              <span class="badge">Paralegal: ${paralegal}</span>
              ${practice}
              <span class="badge status ${statusClass(c.status)}">${statusText}</span>
              ${createdAt ? `<span class="badge">Created: ${esc(createdAt)}</span>` : ''}
              ${updatedAt ? `<span class="badge">Updated: ${esc(updatedAt)}</span>` : ''}
            </div>
            <div class="actions" role="group" aria-label="Actions for ${id}">
              <label class="small" style="display:flex;align-items:center;gap:6px;">
                <span>Update status</span>
                <select data-status-select>
                  ${STATUS_ORDER.map(s => `<option value="${s}" ${s === c.status ? 'selected' : ''}>${statusLabel(s)}</option>`).join('')}
                </select>
              </label>
              <button class="btn primary" data-action="set-status" title="Apply status">Save</button>
            </div>
          </div>
        `;
      }).join('');
    }

    async function updateCase(id, status) {
      try {
        await fetchCSRF();
        const res = await secureFetch(`${API_BASE}/admin/cases/${encodeURIComponent(id)}/status`, {
          method: 'PATCH',
          body: { status }
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data?.msg || data?.error || 'Update failed');

        const idx = allCases.findIndex(x => x._id === id);
        if (idx >= 0) allCases[idx] = data.case || { ...allCases[idx], status };
        render();
        toast('Case updated');
      } catch (e) {
        toast(e?.message || 'Error', 'err');
      }
    }

    // --- events ------------------------------------------------------
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-action="set-status"]');
      if (!btn) return;
      const card = btn.closest('.card'); if (!card) return;
      const select = card.querySelector('[data-status-select]');
      const id = card.dataset.id;
      const next = select?.value;
      if (!id || !next) return;
      updateCase(id, next);
    });

    refreshBtn?.addEventListener('click', fetchCases);
    q.addEventListener('input', debounce(render, 180));
    statusF.addEventListener('change', render);
    sortF.addEventListener('change', render);

    autoRefresh.addEventListener('change', () => {
      clearInterval(pollTimer);
      if (autoRefresh.checked) pollTimer = setInterval(fetchCases, 30000);
      saveFilters();
    });

    // keyboard: Enter in search triggers immediate render
    q.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); render(); }});

    document.addEventListener('DOMContentLoaded', () => document.body.classList.add('loaded'));

    // --- boot --------------------------------------------------------
    (async function boot(){
      loadFilters();
      await ensureAdmin();
      await fetchCases();
      if (autoRefresh.checked) pollTimer = setInterval(fetchCases, 30000);
    })();
  </script>
</body>
</html>
