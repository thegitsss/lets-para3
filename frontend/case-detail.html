<link rel="stylesheet" href="assets/styles/global.css">
<script src="https://www.google.com/recaptcha/api.js" async defer></script>
<script type="module" src="assets/scripts/auth.js"></script>
<!DOCTYPE html>
<html lang="en">
<head>
<input type="text" id="search" placeholder="Search cases/disputes..." style="width:100%;margin-bottom:1rem;padding:0.8rem;font-size:1rem;" />

  <meta charset="UTF-8">
  <title>Case Details</title>
  <style>
    /* Color & Animation */
    :root { --brand-brown:#8c7864;--bg-cream:#f5f2ed;--text-dark:#5c4e3a;--navy:#27394d;--white:#ffffff;--light-gray:#e9eef2; }
    body { font-family:Georgia,serif;background:var(--bg-cream);color:var(--text-dark);padding:2rem;animation:fadeIn .8s ease; }
    h1, h2 { color: var(--navy); }
    .card { background:var(--white); padding:1rem; margin-bottom:1rem; border-left:4px solid var(--brand-brown); box-shadow:0 2px 4px rgba(0,0,0,0.1); }
    .disputes { margin-top:2rem;}
    .dispute { background: var(--light-gray); padding: 0.8rem; margin-bottom: 0.5rem; border-left: 4px solid var(--navy); }
    button { background:var(--navy);color:var(--white);border:none;padding:0.5rem 1rem;border-radius:4px;cursor:pointer;transition:opacity .3s ease; }
    button:hover { opacity:0.8; }
    textarea { width:100%; padding:0.8rem; margin-bottom:1rem; border:1px solid var(--light-gray); border-radius:4px;}
    @keyframes fadeIn { from { opacity:0; transform:translateY(10px);} to { opacity:1; transform:translateY(0);} }
  </style>
</head>
<body>
  <button onclick="history.back()">‚Üê Back</button>
  <h1 id="title">Loading...</h1>
  <div id="info" class="card"></div>
  <h2>Disputes</h2>
  <div id="disputes" class="disputes"></div>
  <textarea id="msgInput" placeholder="Raise a dispute..."></textarea>
  <button id="raiseBtn">Raise Dispute</button>

  <script>
    const token = window.token || localStorage.getItem('token');
window.token = token; // store globally so it's not redeclared

    const id = localStorage.getItem('openCaseId');
    if (!token || !id) location.href = 'my-cases.html';

    const info = document.getElementById('info');
    const disputesDiv = document.getElementById('disputes');
    const titleEl = document.getElementById('title');
    const msgInput = document.getElementById('msgInput');
    document.getElementById('search').addEventListener('input', (e) => {
  const term = e.target.value.toLowerCase();
  async function loadMessages() {
  const res = await fetch(`http://localhost:5000/api/messages/${id}`, {
    headers: { Authorization: `Bearer ${token}` }
  });
  const msgs = await res.json();
  const out = msgs.map(m => `
    <p><strong>${m.sender.fullName}:</strong> ${m.content}<br/><small>${new Date(m.sentAt).toLocaleTimeString()}</small></p>
  `).join('');
  document.getElementById('chatMessages').innerHTML = out;
  const box = document.getElementById('chatMessages');
  box.scrollTop = box.scrollHeight;
}

async function sendMessage() {
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if (!text) return;

  await fetch(`http://localhost:5000/api/messages/${id}/send`, {
    method: 'POST',
    headers: {
      Authorization: `Bearer ${token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ content: text })
  });

  input.value = '';
  loadMessages();
}

setInterval(loadMessages, 3000); // Auto-poll every 3s
loadMessages();

  /* Filter case cards or disputes accordingly */
});

    async function loadCase() {
      const res = await fetch(`http://localhost:5000/api/cases/${id}`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      const c = await res.json();
      titleEl.textContent = c.title;
      info.innerHTML = `<p>${c.description || ''}</p><p><strong>Status:</strong> ${c.status}</p><p><strong>Assigned To:</strong> ${c.assignedTo?.email || 'N/A'}</p>`;
      disputesDiv.innerHTML = c.disputes.map(d => `
        <div class="dispute">
          <p><strong>${d.raisedBy.email}</strong> [${new Date(d.createdAt).toLocaleString()}]</p>
          <p>${d.message}</p>
          <p><em>Status: ${d.status}</em></p>
          ${token && token.includes('admin') && d.status === 'open' ? `
            <button onclick="resolve('${d._id}','resolve')">‚úÖ Resolve</button>
            <button onclick="resolve('${d._id}','reject')">‚ùå Reject</button>
          ` : ''}
        </div>
      `).join('');
    }

    async function raiseDispute() {
      const msg = msgInput.value.trim();
      if (!msg) return alert('Enter dispute message');
      await fetch(`http://localhost:5000/api/cases/${id}/dispute`, {
        method: 'POST',
        headers: { 
          'Content-Type':'application/json',
          Authorization: `Bearer ${token}`
        },
        body: JSON.stringify({ message: msg })
      });
      msgInput.value = '';
      loadCase();
    }

    async function resolve(disputeId, action) {
      await fetch(`http://localhost:5000/api/cases/${id}/dispute/${disputeId}`, {
        method: 'POST',
        headers: {
          'Content-Type':'application/json',
          Authorization: `Bearer ${token}`
        },
        body: JSON.stringify({ action })
      });
      loadCase();
    }
    <div id="completionArea"></div>
    if (role === 'attorney') {
  document.getElementById('completionArea').innerHTML = `
    <button onclick="markComplete()">‚úÖ Mark as Complete</button>
    <input type="url" id="zoomURL" placeholder="Paste Zoom link..." />
    <button onclick="saveZoom()">üí¨ Save Zoom Link</button>
  `;
}
<div id="chatBox" style="border-top:1px solid #ccc; margin-top:2rem; padding-top:1rem;">
  <h3>üí¨ Case Chat</h3>
  <div id="chatMessages" style="height:250px; overflow-y:auto; background:#fff; padding:1rem; border:1px solid #ddd;"></div>
  <textarea id="chatInput" rows="2" style="width:100%; margin-top:0.5rem;"></textarea>
  <button onclick="sendMessage()">Send</button>
</div>


async function markComplete() {
  const res = await fetch(`http://localhost:5000/api/cases/${id}/complete`, {
    method: 'POST',
    headers: { Authorization: `Bearer ${token}` }
  });
  const data = await res.json();
  alert(data.msg);
  loadCase();
}

async function saveZoom() {
  const link = document.getElementById('zoomURL').value.trim();
  if (!link.startsWith('http')) return alert('Valid Zoom URL required.');
  const res = await fetch(`http://localhost:5000/api/cases/${id}/zoom-link`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      Authorization: `Bearer ${token}`
    },
    body: JSON.stringify({ link })
  });
  const data = await res.json();
  alert(data.msg);
  loadCase();
}

    if (role === "paralegal") {
  const applyBtn = document.createElement("button");
  applyBtn.textContent = "Apply to this Case";
  applyBtn.onclick = async () => {
    const res = await fetch(`http://localhost:5000/api/cases/${id}/apply`, {
      method: 'POST',
      headers: { Authorization: `Bearer ${token}` }
    });
    const data = await res.json();
    alert(data.msg);
  };
  document.body.appendChild(applyBtn);
}

    document.getElementById('raiseBtn').onclick = raiseDispute;
    loadCase();
  </script>
  <section class="zoom-scheduler">
  <h3>üìÖ Zoom Meeting</h3>
  <div id="zoomStatus"></div>

  <form id="zoomForm">
    <input type="url" id="zoomLink" placeholder="Paste Zoom link here..." required />
    <button type="submit">Add / Update Link</button>
  </form>
</section>
<script>
const caseId = new URLSearchParams(window.location.search).get('id');

// üí¨ MESSAGES
async function fetchMessages() {
  const res = await fetch(`/api/messages/${caseId}`, {
    headers: { 'Authorization': 'Bearer ' + token }
  });
  const data = await res.json();
  const container = document.getElementById('messages-container');
  container.innerHTML = '';

  data.forEach(msg => {
    const div = document.createElement('div');
    div.classList.add('msg');
    div.innerHTML = `
      <span>${msg.sender.fullName} (${msg.sender.role}) ‚Äî ${new Date(msg.sentAt).toLocaleString()}</span>
      ${msg.content}
    `;
    container.appendChild(div);
  });
}

document.getElementById('messageForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const content = document.getElementById('messageInput').value.trim();
  if (!content) return;

  await fetch(`/api/messages/${caseId}/send`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + token
    },
    body: JSON.stringify({ content })
  });

  document.getElementById('messageInput').value = '';
  fetchMessages();
});

fetchMessages();
setInterval(fetchMessages, 5000); // refresh every 5s


// üìÖ ZOOM LINK
const zoomStatus = document.getElementById('zoomStatus');
const zoomForm = document.getElementById('zoomForm');
const zoomInput = document.getElementById('zoomLink');

fetch(`/api/cases/${caseId}`, {
  headers: { Authorization: 'Bearer ' + token }
})
  .then(res => res.json())
  .then(data => {
    if (data.zoomLink) {
      zoomStatus.innerHTML = `<a href="${data.zoomLink}" target="_blank">üîó Join Zoom Meeting</a>`;
      zoomInput.value = data.zoomLink;
    }
  });

zoomForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  const zoomLink = zoomInput.value;

  const res = await fetch(`/api/cases/${caseId}/zoom`, {
    method: 'PATCH',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + token
    },
    body: JSON.stringify({ zoomLink })
  });

  const result = await res.json();
  zoomStatus.innerHTML = `<a href="${result.zoomLink}" target="_blank">üîó Join Zoom Meeting</a>`;
});
</script>
</body>
</html>
