<!DOCTYPE html>
<html lang="en">
<head>
  <style>body{opacity:1!important;visibility:visible!important}</style>
  <meta charset="UTF-8" />
  <title>Case Details</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="assets/styles.css" />
  <script type="module" src="assets/scripts/auth.js"></script>
  <script src="https://js.stripe.com/v3"></script>

  <style>
    :root { --brand-brown:#8c7864; --bg-cream:#f5f2ed; --text-dark:#5c4e3a; --navy:#27394d; --line:#e8edf3; }
    body { background:var(--bg-cream); color:var(--text-dark); font-family: Georgia, serif; }
    header { display:flex; gap:10px; align-items:center; padding:14px 16px; background:#fff; border-bottom:1px solid var(--line); }
    header a { color:var(--navy); text-decoration:none; }
    main { max-width:1100px; margin:20px auto; padding:0 14px; }
    h1 { color:var(--navy); margin:0 0 10px; }
    .grid { display:grid; grid-template-columns: 1.1fr 1fr; gap:18px; }
    @media (max-width:900px){ .grid { grid-template-columns:1fr; } }

    .card { background:#fff; border:1px solid var(--line); border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,.04); padding:14px; }
    .card h2 { margin:0 0 10px; color:var(--navy); font-size:1.2rem; }
    .muted { color:#64748b; }
    .pill { display:inline-block; padding:4px 10px; border-radius:999px; font-size:.85rem; background:#f7f7fb; border:1px solid var(--line); color:#384656; }
    .row { display:flex; gap:8px; flex-wrap:wrap; }
    .field { display:grid; gap:6px; margin:8px 0; }
    .field input, .field textarea { width:100%; padding:.6rem; border:1px solid var(--line); border-radius:10px; font:inherit; background:#fff; }
    .btn { border:0; border-radius:10px; padding:.55rem .9rem; cursor:pointer; font-weight:600; }
    .btn.primary { background:#27394d; color:#fff; }
    .btn.secondary { background:#fff; color:#1f2937; border:1px solid var(--line); }
    .btn.affirm { background:#1f7a4a; color:#fff; }
    .btn.danger { background:#b04747; color:#fff; }

    /* Disputes */
    .dispute { border-left:4px solid var(--navy); background:#f7f8fb; padding:.7rem .8rem; border-radius:8px; margin:.6rem 0; }
    .dispute .meta { font-size:.9rem; color:#475569; margin-bottom:4px; }

    /* Chat */
    .chat-box { display:grid; gap:8px; }
    .chat-messages { height:280px; overflow-y:auto; border:1px solid var(--line); background:#fff; border-radius:10px; padding:10px; }
    .msg { margin:.35rem 0; }
    .msg .stamp { color:#94a3b8; font-size:.85rem; }
    .me { background:#f0f5ff; border:1px solid #e6eefc; padding:.45rem .6rem; border-radius:10px; display:inline-block; }
    .them { background:#fff; border:1px solid var(--line); padding:.45rem .6rem; border-radius:10px; display:inline-block; }

    /* Applicants */
    .applicant { display:flex; align-items:center; justify-content:space-between; border:1px solid var(--line); border-radius:10px; padding:.6rem .8rem; margin:.4rem 0; background:#fff; }

    /* Payment block */
    #paymentWrap { display:none; gap:8px; align-items:center; }
  </style>
</head>
<body>
  <header>
    <a href="my-cases.html" aria-label="Back to My Cases">← Back</a>
    <span class="muted" aria-hidden="true">Case Detail</span>
  </header>

  <main>
    <h1 id="caseTitle" aria-live="polite">Loading…</h1>
    <div class="grid">
      <!-- Left column -->
      <section class="card" aria-labelledby="summary-h">
        <h2 id="summary-h">Summary</h2>
        <div id="caseSummary" class="muted">Loading…</div>

        <div class="row" style="margin-top:10px;">
          <span id="statusPill" class="pill" aria-live="polite">—</span>
          <span id="assigneePill" class="pill">Assigned: —</span>
          <span id="createdPill" class="pill">Created: —</span>
        </div>

        <hr style="border:none; border-top:1px solid var(--line); margin:14px 0;" />

        <h2>Zoom</h2>
        <div id="zoomStatus" class="muted" style="margin-bottom:8px;">No link set.</div>
        <form id="zoomForm" class="row" autocomplete="off">
          <input id="zoomLink" type="url" placeholder="Paste Zoom link…" aria-label="Zoom link" style="flex:1; min-width:240px;" />
          <button class="btn secondary" type="submit">Save</button>
        </form>

        <hr style="border:none; border-top:1px solid var(--line); margin:14px 0;" />

        <div id="ownerActions" class="row" style="display:none;">
          <button id="completeBtn" class="btn affirm">Mark Complete</button>
        </div>

        <!-- Payment (escrow) -->
        <hr style="border:none; border-top:1px solid var(--line); margin:14px 0;" />
        <h2>Fund Escrow</h2>
        <div id="paymentWrap" class="row">
          <div id="payment-element" style="flex:1;"></div>
          <button id="payBtn" class="btn primary">Pay</button>
        </div>
        <div id="paymentInfo" class="muted" style="margin-top:6px;"></div>

        <div id="applicantsBlock" style="display:none; margin-top:12px;">
          <h2>Applicants</h2>
          <div id="applicantsList" class="muted">Loading…</div>
        </div>
      </section>

      <!-- Right column -->
      <section class="card" aria-labelledby="disputes-h">
        <h2 id="disputes-h">Disputes</h2>
        <div id="disputesList" class="muted">Loading…</div>

        <div id="raiseWrap" class="field" style="margin-top:10px;">
          <label for="disputeMsg">Raise a dispute</label>
          <textarea id="disputeMsg" rows="3" placeholder="Describe the issue…"></textarea>
          <div class="row">
            <button id="raiseBtn" class="btn primary">Submit</button>
          </div>
        </div>

        <hr style="border:none; border-top:1px solid var(--line); margin:14px 0;" />

        <h2>Case Chat</h2>
        <div class="chat-box">
          <div id="chatMessages" class="chat-messages" aria-live="polite">Loading…</div>
          <div class="row">
            <input id="chatInput" placeholder="Write a message…" aria-label="Chat message"/>
            <button id="chatSend" class="btn primary">Send</button>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- Payments + page logic -->
  <script type="module">
    import { ensureIntent, createElements, mountPaymentElement, confirmPayment } from './assets/scripts/payments.js';
    import { secureFetch, fetchCSRF } from './assets/scripts/auth.js';

    (async function () {
      const API_BASE = '/api';

      // --------- session guard ---------
      async function requireSession() {
        try {
          const r = await fetch(`${API_BASE}/auth/me`, { credentials: 'include' });
          if (!r.ok) throw new Error();
          const { user } = await r.json();
          if (!user?.id) throw new Error();
          return user;
        } catch {
          location.href = 'login.html';
          throw new Error('redirect');
        }
      }

      const me = await requireSession();
      await fetchCSRF().catch(() => {});

      // --------- DOM refs ---------
      const H = (id) => document.getElementById(id);
      const caseTitle = H('caseTitle');
      const caseSummary = H('caseSummary');
      const statusPill = H('statusPill');
      const assigneePill = H('assigneePill');
      const createdPill = H('createdPill');
      const ownerActions = H('ownerActions');
      const applicantsBlock = H('applicantsBlock');
      const applicantsList = H('applicantsList');

      const disputesList = H('disputesList');
      const disputeMsg = H('disputeMsg');
      const raiseBtn = H('raiseBtn');

      const zoomStatus = H('zoomStatus');
      const zoomForm = H('zoomForm');
      const zoomInput = H('zoomLink');

      const chatMessages = H('chatMessages');
      const chatInput = H('chatInput');
      const chatSend = H('chatSend');

      const paymentWrap = H('paymentWrap');
      const paymentInfo = H('paymentInfo');
      const payBtn = H('payBtn');
      const paymentHost = H('payment-element');

      // --------- utils ---------
      const esc = (s) => String(s ?? '').replace(/[&<>"]/g, (c) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;' }[c]));
      const qp = new URLSearchParams(location.search);
      const caseId = qp.get('id') || localStorage.getItem('openCaseId');
      if (!caseId) { alert('Missing case id'); location.href = 'my-cases.html'; return; }

      let currentCase = null;
      let elements = null;

      // --------- data loaders ---------
      async function loadCase() {
        const r = await fetch(`${API_BASE}/cases/${encodeURIComponent(caseId)}`, { credentials: 'include' });
        if (!r.ok) { alert('Could not load case'); location.href='my-cases.html'; return; }
        const c = await r.json();
        currentCase = c;

        // Summary
        caseTitle.textContent = c.title || 'Case';
        caseSummary.innerHTML = `
          <p>${esc(c.details || c.description || '') || '<span class="muted">No details provided.</span>'}</p>
          <p class="muted" style="margin-top:6px;">ID: ${esc(c._id || c.id || caseId)}</p>
        `;

        statusPill.textContent = (c.status || 'open');
        assigneePill.textContent = 'Assigned: ' + (c.assignedTo?.email || c.acceptedParalegal?.email || '—');
        createdPill.textContent = 'Created: ' + (c.createdAt ? new Date(c.createdAt).toLocaleString() : '—');

        // Zoom
        if (c.zoomLink) {
          zoomStatus.innerHTML = `<a href="${esc(c.zoomLink)}" target="_blank" rel="noopener">Join Zoom</a>`;
          zoomInput.value = c.zoomLink;
        } else {
          zoomStatus.textContent = 'No link set.';
          zoomInput.value = '';
        }

        // Applicants (only for owner/admin)
        const isOwner = c.createdBy && String(c.createdBy._id || c.createdBy) === String(me.id);
        if (isOwner || me.role === 'admin') {
          ownerActions.style.display = '';
          loadApplicants();
        } else {
          ownerActions.style.display = 'none';
          applicantsBlock.style.display = 'none';
        }

        // Disputes
        renderDisputes(c.disputes || []);

        // Payment (escrow) visibility hint
        if (c.budget?.amount && c.budget?.currency) {
          paymentInfo.textContent = `Amount: ${c.budget.amount} ${c.budget.currency.toUpperCase()}`;
          await setupPayment();
        } else {
          paymentInfo.textContent = 'No budget set yet.';
          paymentWrap.style.display = 'none';
        }
      }

      async function loadApplicants() {
        try {
          const r = await fetch(`${API_BASE}/cases/${encodeURIComponent(caseId)}/applicants`, { credentials:'include' });
          if (!r.ok) throw new Error();
          const apps = await r.json();
          applicantsBlock.style.display = '';
          if (!apps.length) { applicantsList.innerHTML = '<div class="muted">No applicants yet.</div>'; return; }
          applicantsList.innerHTML = apps.map(a => `
            <div class="applicant">
              <div>
                <div><strong>${esc(a.paralegalId?.name || 'Paralegal')}</strong> — ${esc(a.status || 'pending')}</div>
                <div class="muted">${esc(a.paralegalId?.email || '')}</div>
              </div>
              <div class="row">
                <button class="btn primary" data-accept="${a.paralegalId?._id || a.paralegalId}">Accept</button>
              </div>
            </div>
          `).join('');
        } catch {
          applicantsBlock.style.display = 'none';
        }
      }

      function renderDisputes(list) {
        if (!list.length) { disputesList.innerHTML = '<div class="muted">No disputes.</div>'; return; }
        disputesList.innerHTML = list.map(d => {
          const by = d.raisedBy?.email || d.raisedBy?.name || 'User';
          const when = d.createdAt ? new Date(d.createdAt).toLocaleString() : '';
          const comments = (d.comments || []).map(cm => `
            <div class="muted" style="margin:.3rem 0 0 0.6rem;">• ${esc(cm.text || '')} — ${cm.by?.name || cm.by?.email || 'User'} (${new Date(cm.createdAt || Date.now()).toLocaleString()})</div>
          `).join('');
          const adminBtns = (me.role === 'admin' && d.status === 'open')
            ? `<div class="row" style="margin-top:6px;">
                 <button class="btn affirm" data-dispute-act="resolved" data-id="${d._id}">Resolve</button>
                 <button class="btn danger"  data-dispute-act="rejected" data-id="${d._id}">Reject</button>
               </div>`
            : '';
          return `
            <div class="dispute">
              <div class="meta">${esc(by)} — ${when} &nbsp; <span class="pill">${esc(d.status)}</span></div>
              <div>${esc(d.message || '')}</div>
              ${comments}
              ${adminBtns}
            </div>
          `;
        }).join('');
      }

      // --------- actions ---------
      // Disputes raise/update
      async function raiseDispute() {
        const msg = disputeMsg.value.trim();
        if (!msg) return;
        await fetchCSRF().catch(()=>{});
        const r = await secureFetch(`${API_BASE}/cases/${encodeURIComponent(caseId)}/dispute`, {
          method: 'POST', body: { message: msg }
        });
        if (!r.ok) { alert('Could not submit dispute'); return; }
        disputeMsg.value = '';
        await loadCase();
      }
      raiseBtn.addEventListener('click', raiseDispute);

      disputesList.addEventListener('click', async (e) => {
        const act = e.target?.dataset?.disputeAct;
        const id = e.target?.dataset?.id;
        if (!act || !id) return;
        await fetchCSRF().catch(()=>{});
        const r = await secureFetch(`${API_BASE}/cases/${encodeURIComponent(caseId)}/dispute/${encodeURIComponent(id)}`, {
          method: 'POST', body: { action: act }
        });
        if (!r.ok) { alert('Failed to update dispute'); return; }
        loadCase();
      });

      // Applicants accept
      applicantsList.addEventListener('click', async (e) => {
        const pid = e.target?.dataset?.accept;
        if (!pid) return;
        await fetchCSRF().catch(()=>{});
        const r = await secureFetch(`${API_BASE}/cases/${encodeURIComponent(caseId)}/accept/${encodeURIComponent(pid)}`, { method: 'POST' });
        if (!r.ok) { alert('Could not accept'); return; }
        await loadCase();
      });

      // Owner complete
      H('completeBtn').addEventListener('click', async () => {
        await fetchCSRF().catch(()=>{});
        const r = await secureFetch(`${API_BASE}/cases/${encodeURIComponent(caseId)}/complete`, { method: 'POST' });
        const data = await r.json().catch(() => ({}));
        if (!r.ok) { alert(data.msg || 'Failed to complete'); return; }
        alert(data.msg || 'Case completed');
        loadCase();
      });

      // Zoom save
      zoomForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const link = zoomInput.value.trim();
        if (!/^https?:\/\//i.test(link)) { alert('Please enter a valid URL'); return; }
        await fetchCSRF().catch(()=>{});
        const r = await secureFetch(`${API_BASE}/cases/${encodeURIComponent(caseId)}/zoom`, {
          method: 'PATCH', body: { zoomLink: link }
        });
        const data = await r.json().catch(() => ({}));
        if (!r.ok) { alert(data.msg || 'Failed to save'); return; }
        zoomStatus.innerHTML = `<a href="${esc(data.zoomLink)}" target="_blank" rel="noopener">Join Zoom</a>`;
      });

      // Chat
      const threadId = `case-${caseId}`;
      async function loadChat() {
        try {
          const r = await fetch(`${API_BASE}/messages/${encodeURIComponent(threadId)}`, { credentials: 'include' });
          const data = r.ok ? await r.json() : { messages: [] };
          const list = data.messages || [];
          chatMessages.innerHTML = list.map(m => {
            const who = m.from === 'me' ? 'me' : 'them';
            const when = new Date(m.createdAt || Date.now()).toLocaleString();
            const txt = esc(m.text || (m.transcript || ''));
            return `<div class="msg"><div class="${who}">${txt}</div><div class="stamp">${when}</div></div>`;
          }).join('') || '<div class="muted">No messages yet.</div>';
          chatMessages.scrollTop = chatMessages.scrollHeight;
        } catch {
          chatMessages.innerHTML = '<div class="muted">Unable to load chat.</div>';
        }
      }

      async function sendChat() {
        const text = chatInput.value.trim();
        if (!text) return;
        await fetchCSRF().catch(()=>{});
        const r = await secureFetch(`${API_BASE}/messages/${encodeURIComponent(threadId)}`, {
          method: 'POST', body: { text }
        });
        if (!r.ok) { alert('Failed to send'); return; }
        chatInput.value = '';
        const data = await r.json().catch(() => ({ messages: [] }));
        const list = data.messages || [];
        chatMessages.innerHTML = list.map(m => {
          const who = m.from === 'me' ? 'me' : 'them';
          const when = new Date(m.createdAt || Date.now()).toLocaleString();
          const txt = esc(m.text || (m.transcript || ''));
          return `<div class="msg"><div class="${who}">${txt}</div><div class="stamp">${when}</div></div>`;
        }).join('');
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      chatSend.addEventListener('click', sendChat);
      chatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChat(); }
      });

      // --------- payments (Stripe escrow) ---------
      async function setupPayment() {
        try {
          const clientSecret = await ensureIntent(caseId, secureFetch);
          elements = await createElements(clientSecret);
          mountPaymentElement(elements, paymentHost);
          paymentWrap.style.display = 'flex';
        } catch (e) {
          paymentInfo.textContent = e?.message || 'Unable to initialize payment.';
          paymentWrap.style.display = 'none';
        }
      }

      payBtn.addEventListener('click', async () => {
        if (!elements) { alert('Payment not ready'); return; }
        const { error, paymentIntent } = await confirmPayment(elements);
        if (error) {
          alert(error.message || 'Payment failed');
          return;
        }
        if (paymentIntent?.status === 'succeeded') {
          alert('Escrow funded!');
          await loadCase();
        } else {
          alert(`Payment status: ${paymentIntent?.status || 'processing'}`);
        }
      });
// Inside your existing JS boot block, after loadCase() and before or after loadChat()

function toggleChatVisibility() {
  const chatBox = document.querySelector('.chat-box');
  const chatRow = document.querySelector('.chat-box .row');
  const chatInput = document.getElementById('chatInput');
  const chatSend = document.getElementById('chatSend');

  if (!currentCase || !chatBox || !chatInput || !chatSend) return;

  const active = currentCase.status === 'in_progress';
  const readonly = currentCase.status === 'complete' || currentCase.status === 'disputed';

  if (active) {
    chatRow.style.display = 'flex';
    chatInput.disabled = false;
    chatSend.disabled = false;
  } else {
    chatRow.style.display = 'none';
    const disabledMsg = document.createElement('div');
    disabledMsg.className = 'muted';
    disabledMsg.style.marginTop = '10px';
    disabledMsg.textContent = readonly
      ? 'This case is closed. Chat is read-only.'
      : 'Chat is disabled until a paralegal is hired.';
    chatBox.appendChild(disabledMsg);
  }
}
// --------- boot ---------
await loadCase();
toggleChatVisibility();
await loadChat();
setInterval(loadChat, 5000);
    })();
  </script>
</body>
</html>
