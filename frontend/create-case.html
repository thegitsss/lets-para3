<!DOCTYPE html>
<html lang="en">
<head>

  <link rel="stylesheet" href="assets/styles/fonts.css" />
  <link rel="preload" as="image" href="hero-mountain.jpg" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta name="theme-color" content="#0B2A4A">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Create Case – Let’s-ParaConnect</title>
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png" />
  <link rel="icon" href="/favicon.ico" />
  <link rel="shortcut icon" href="/favicon.ico" />
  <link rel="manifest" href="site.webmanifest" />
  <link rel="mask-icon" href="maskable-icon.png" color="#0B2A4A" />

  <script src="assets/scripts/utils/session.js"></script>
  <style>
    .skip-link {
      position: absolute;
      left: 12px;
      top: -40px;
      background: #1a2230;
      color: #ffffff;
      padding: 8px 12px;
      border-radius: 6px;
      text-decoration: none;
      z-index: 10000;
      font-size: 14px;
    }

    .skip-link:focus {
      top: 12px;
    }

    .gold{color:#b4975a;}
    :root {
      --bg:#ffffff;
      --sidebar-bg:#f5f5f5e6;
      --accent:#b6a47a;
      --ink:#1a1a1a;
      --muted:#8a8a8a;
      --line:rgba(0,0,0,0.08);
      --panel:#fcfcfc;
      --sidebar-text:#1a1a1a;
      --radius:14px;
      --font-serif:'Cormorant Garamond',serif;
      --font-sans:'Sarabun',sans-serif;
    }
    body.theme-dark{
      --bg:#0f172a;
      --sidebar-bg:#1c2333;
      --panel:#151b29;
      --ink:#f5f6fb;
      --muted:#9aa7c4;
      --line:rgba(255,255,255,0.08);
      --sidebar-text:#f8fbff;
    }
    body.theme-mountain{
      --bg:#f8f6f1;
      --panel:#ffffff;
      --muted:#7a736a;
      --sidebar-text:#ffffff;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:var(--font-sans);
      background:var(--bg);
      color:var(--ink);
      display:flex;
      height:100vh;
      overflow:hidden;
      font-weight:200;
    }
    strong{
      font-family:var(--font-serif);
      font-weight:400;
    }

    /* Sidebar */
    .sidebar{
      width:240px;
      background:var(--sidebar-bg);
      display:flex;
      flex-direction:column;
      border-right:1px solid var(--line);
      padding:24px 16px;
      color:var(--sidebar-text);
      position:relative;
    }
    .sidebar::before{
      content:"";
      position:absolute;
      inset:0;
      background:transparent;
      pointer-events:none;
      transition:background .3s ease;
    }
    body.theme-mountain .sidebar,
    body.theme-mountain-dark .sidebar{
      background:var(--bg) url('hero-mountain.jpg') center/cover no-repeat;
    }
    body.theme-mountain .sidebar::before,
    body.theme-mountain-dark .sidebar::before{
      background:rgba(0,0,0,0.45);
    }
    body.theme-mountain .sidebar > *,
    body.theme-mountain-dark .sidebar > *{
      position:relative;
      z-index:1;
    }
    .logo{
      font-family:var(--font-serif);
      font-size:1.6rem;
      font-weight:300;
      text-align:center;
      margin-bottom:36px;
    }
    nav{display:flex;flex-direction:column;gap:14px;}
    nav a{
      text-decoration:none;
      color:var(--sidebar-text);
      font-size:0.95rem;
      padding:10px 14px;
      border-radius:var(--radius);
      transition:background .3s;
    }
    nav a.active,nav a:hover{background:rgba(0,0,0,0.04);}
    body.theme-dark nav a.active,
    body.theme-dark nav a:hover{background:rgba(255,255,255,0.12);}
    body.theme-mountain nav a.active,
    body.theme-mountain nav a:hover,
    body.theme-mountain-dark nav a.active,
    body.theme-mountain-dark nav a:hover{background:rgba(255,255,255,0.18);}
    body.theme-mountain nav a,
    body.theme-mountain-dark nav a{color:#fff;}
    .sidebar-link{
      margin-top:1.5rem;
      width:100%;
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:0.6rem 1rem;
      background:transparent;
      font-size:0.9rem;
      font-family:var(--font-serif);
      font-weight:300;
      color:var(--sidebar-text);
      cursor:pointer;
      transition:background .2s,color .2s;
    }
    .sidebar-link:hover,
    .sidebar-link:focus{
      background:rgba(0,0,0,0.05);
      color:var(--accent);
      outline:none;
    }
    body.theme-dark .sidebar-link:hover,
    body.theme-dark .sidebar-link:focus,
    body.theme-mountain .sidebar-link:hover,
    body.theme-mountain .sidebar-link:focus,
    body.theme-mountain-dark .sidebar-link:hover,
    body.theme-mountain-dark .sidebar-link:focus{
      color:#fff;
    }
    body.theme-mountain .sidebar-link,
    body.theme-mountain-dark .sidebar-link{color:#fff;}
    .sidebar-bottom{
      margin-top:auto;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .sidebar-footer{
      font-size:0.7rem;
      color:var(--muted);
      text-align:center;
    }
    /* uniform style for step bubbles across all create-case pages */
.steps {
  display: flex;
  justify-content: space-between;
  align-items: center;
  max-width: 700px;
  margin: 0 auto 2.5rem;
  position: relative;
}

.steps::before {
  content: "";
  position: absolute;
  top: 14px;
  left: 0;
  right: 0;
  height: 3px;
  background: var(--line);
}

.step {
  text-align: center;
  flex: 1;
  position: relative;
}

.circle {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  border: 2px solid var(--line);
  background: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 8px;
  font-size: 0.8rem;
  color: var(--muted);
  transition: all 0.3s ease;
}

.step.active .circle {
  background: var(--accent);
  border-color: var(--accent);
  color: #fff;
}

.step span {
  font-size: 0.85rem;
  color: var(--muted);
}

    /* Main */
    .main{flex:1;padding:40px;overflow-y:auto;overflow-x:hidden;scrollbar-gutter:stable;}
    .topbar{display:flex;justify-content:flex-end;align-items:flex-start;margin-bottom:2rem;gap:1.5rem;position:relative;min-height:72px;}
    .notification-icon{width:46px;height:46px;border-radius:50%;border:1px solid var(--line);display:flex;justify-content:center;align-items:center;background:#fff;cursor:pointer;position:relative;transition:border-color .2s ease, transform .2s ease;}
    .notification-icon:hover{border-color:var(--accent);transform:translateY(-1px);}
    .notification-icon svg{width:22px;height:22px;color:var(--ink);}
    .notification-badge{position:absolute;top:-4px;right:-4px;background:#c0392b;color:#fff;border-radius:999px;font-size:.75rem;padding:2px 6px;line-height:1;display:none;font-weight:200;}
    .notification-badge.show{display:inline-flex;}
    .user-profile{display:flex;align-items:center;gap:12px;padding:8px 12px;border-radius:999px;background:rgba(255,255,255,0.6);border:1px solid rgba(255,255,255,0.4);backdrop-filter:blur(14px);-webkit-backdrop-filter:blur(14px);transition:border-color 0.2s ease,box-shadow .2s ease;cursor:pointer;position:relative;}
    .user-profile img{width:44px;height:44px;border-radius:50%;border:2px solid #fff;box-shadow:0 4px 16px rgba(0,0,0,0.08);object-fit:cover;}
    .user-profile strong{display:block;font-weight:300;color:var(--ink);}
    .user-profile span{font-size:0.85rem;color:var(--muted);}
    body.theme-dark .user-profile{background:rgba(15,23,42,0.4);border-color:rgba(255,255,255,0.15);box-shadow:0 10px 25px rgba(0,0,0,0.35);}
    body.theme-dark .user-profile strong{color:#fff;}
    body.theme-dark .user-profile span{color:rgba(255,255,255,0.8);}
    body.theme-mountain .user-profile{background:rgba(255,255,255,0.65);border-color:rgba(255,255,255,0.42);box-shadow:0 18px 34px rgba(17,22,26,0.2);}
    body.theme-mountain .user-profile strong{color:#fff;}
    body.theme-mountain .user-profile span{color:rgba(255,255,255,0.85);}

    header h1{
      font-family:var(--font-serif);
      font-weight:300;
      font-size:2rem;
      margin-bottom:1rem;
    }
    header p{font-weight:200;color:var(--muted);margin-bottom:2rem;}

    /* Wizard steps */
    .steps{
      display:flex;
      justify-content:space-between;
      align-items:center;
      max-width:700px;
      margin:0 auto 2.5rem;
      position:relative;
    }
    .step{
      text-align:center;
      flex:1;
      position:relative;
    }
    .circle{
      position:relative;
      z-index:1;
      width:28px;
      height:28px;
      border-radius:50%;
      background:#fff;
      border:2px solid var(--line);
      margin:0 auto 8px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:0.8rem;
    }
    .active .circle{
      background:var(--accent);
      border-color:var(--accent);
      color:#fff;
    }
    .step span{font-size:0.85rem;color:var(--muted);}

    /* Form */
    .input-error{
      border-color:#c0392b !important;
      background:rgba(192,57,43,0.05);
    }
    button.input-error{
      border-color:#c0392b !important;
      box-shadow:0 0 0 1px rgba(192,57,43,0.2);
    }
    .field-error{
      color:#b91c1c;
      font-size:0.8rem;
      margin-top:6px;
    }

    form{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:2rem;
      max-width:800px;
      margin:0 auto;
      box-shadow:0 2px 6px rgba(0,0,0,0.03);
    }
    .field{margin-bottom:1.25rem;}
    .field label{
      display:block;
      margin-bottom:6px;
      font-size:0.9rem;
      color:var(--ink);
    }
    button{
      font-family:var(--font-serif);
      font-weight:300;
    }
    input,select,textarea{
      width:100%;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:6px;
      font-family:inherit;
      font-weight:200;
      font-size:0.9rem;
      transition:border-color .2s,box-shadow .2s;
    }
    input:focus,select:focus,textarea:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 3px rgba(182,164,122,0.15);
      outline:none;
    }
    .task-input-row{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .task-input-row input{flex:1;}
    .task-list{
      list-style:none;
      padding-left:0;
      margin:10px 0 0;
      display:grid;
      gap:8px;
    }
    .task-list li{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:6px;
      background:#fff;
      font-size:0.9rem;
    }
    .task-list .task-empty{
      border:none;
      background:transparent;
      color:var(--muted);
      padding:0;
      justify-content:flex-start;
    }
    .task-remove{
      border:none;
      background:transparent;
      color:var(--muted);
      cursor:pointer;
      font-size:0.85rem;
    }
    .task-remove:hover{color:var(--accent);}
    .task-helper{
      font-size:0.85rem;
      color:var(--muted);
      margin-top:6px;
    }

    .btn{
      border:none;
      border-radius:6px;
      padding:0.6rem 1.1rem;
      font-size:0.9rem;
      font-family:var(--font-serif);
      font-weight:300;
      cursor:pointer;
      transition:all .2s;
    }
    .btn.secondary{background:#fff;border:1px solid var(--line);color:var(--ink);}
    .btn.secondary:hover{border-color:var(--accent);color:var(--accent);}
    .btn.primary{background:var(--accent);color:#fff;}
    .btn.primary:hover{background:#a0854d;}
.comp-wrapper {
  display: flex;
  align-items: center;
  gap: 8px;
  position: relative;
}

.lock-note{font-size:0.9rem;margin-top:6px;color:var(--muted);}

.dollar-sign {
  position: absolute;
  left: 12px;
  color: var(--muted);
  font-size: 0.9rem;
}

#comp {
  padding-left: 24px;
  width: 120px;
  border: 1px solid var(--line);
  border-radius: 6px;
  padding: 0.5rem 0.6rem 0.5rem 1.4rem;
  font-family: inherit;
  font-size: 0.9rem;
}

#comp:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(182,164,122,0.15);
  outline: none;
}

#comp:disabled {
  background: #f4f1e8;
  color: #7a6f5a;
  border-color: #e0d7c4;
  cursor: not-allowed;
}

.comp-wrapper.is-locked .dollar-sign {
  color: #b1a58a;
}

.comp-type {
  display: flex;
  gap: 6px;
}

.type-btn {
  background: #fff;
  border: 1px solid var(--line);
  border-radius: 6px;
  padding: 0.4rem 0.8rem;
  font-size: 0.85rem;
  cursor: pointer;
  transition: all 0.2s;
}

.type-btn.active {
  background: var(--accent);
  color: #fff;
  border-color: var(--accent);
}

.type-btn:hover:not(.active) {
  border-color: var(--accent);
  color: var(--accent);
}
.select-field .select-wrapper {
  position: relative;
}
.select-field select {
  width: 100%;
  border: 1px solid var(--line);
  border-radius: 10px;
  padding: 0.65rem 2.6rem 0.65rem 0.85rem;
  font-size: 0.95rem;
  font-family: inherit;
  background: #fff;
  appearance: none;
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
}
.select-field select:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(182,164,122,0.18);
  outline: none;
}
.select-field .select-arrow {
  position: absolute;
  right: 14px;
  top: 50%;
  transform: translateY(-50%);
  pointer-events: none;
  color: var(--muted);
  font-size: 0.8rem;
}
.select-field .select-wrapper {
  position: relative;
}
.select-field select {
  width: 100%;
  border: 1px solid var(--line);
  border-radius: 10px;
  padding: 0.65rem 2.8rem 0.65rem 0.9rem;
  font-size: 0.95rem;
  font-family: inherit;
  background: #fff;
  appearance: none;
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
}
.select-field select:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(182,164,122,0.18);
  outline: none;
}
.select-field .select-arrow {
  position: absolute;
  right: 14px;
  top: 50%;
  transform: translateY(-50%);
  pointer-events: none;
  color: var(--muted);
  font-size: 0.8rem;
}
.steps a {
  text-decoration: none;
  color: inherit;
  display: flex;
  flex-direction: column;
  align-items: center;
  flex: 1;
}

.steps a:hover .circle {
  background: var(--accent);
  color: #fff;
  border-color: var(--accent);
}

.steps a:hover span {
  color: var(--accent);
}

    .step-panel[hidden] {
      display: none !important;
    }

    .step-panel form{
      max-width:1000px;
      margin:0 auto;
      width:100%;
    }

    .form-wrapper{
      max-width:1000px;
      margin:0 auto;
      display:flex;
      flex-direction:column;
      gap:1.5rem;
    }

    #create-step-description .form-wrapper form{
      width:100%;
    }

    #create-step-description .form-wrapper .tips{
      width:100%;
    }

    .tips{
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:1.5rem;
      background:var(--panel);
      font-size:0.9rem;
      color:var(--muted);
    }
    .tips h3{
      font-family:var(--font-serif);
      font-size:1.15rem;
      font-weight:300;
      margin-bottom:0.75rem;
      color:var(--ink);
    }
    .tips ul{
      margin:0 0 0.75rem 1.1rem;
      padding:0;
      display:flex;
      flex-direction:column;
      gap:0.35rem;
    }

    .case-title-preview{
      border:1px solid rgba(182,164,122,0.4);
      border-radius:var(--radius);
      background:#fffbe8;
      padding:1rem 1.2rem;
      margin-bottom:1rem;
      font-size:0.95rem;
    }

    .char-count{
      text-align:right;
      font-size:0.8rem;
      color:var(--muted);
      margin-top:6px;
    }

    .summary{
      max-width:1000px;
      margin:0 auto;
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:2.6rem 3rem;
      box-shadow:0 2px 6px rgba(0,0,0,0.03);
      display:flex;
      flex-direction:column;
      gap:1.1rem;
      line-height:1.6;
    }
    .summary h2{
      font-family:'Cormorant Garamond',serif;
      font-weight:300;
      font-size:1.5rem;
      margin-bottom:1.25rem;
    }
    .summary p{margin:0;color:var(--ink);}
    .summary small{color:var(--muted);}

    .auto-note{margin-top:1rem;font-size:0.9rem;color:var(--muted);}
    .actions{display:flex;justify-content:flex-end;gap:10px;margin-top:2rem;}
    .step-panel .actions{
      max-width:1000px;
      margin:2rem auto 0;
      width:100%;
      padding:0 2rem;
      justify-content:flex-end;
    }
    .btn{border:none;border-radius:6px;padding:0.6rem 1.1rem;font-size:0.9rem;font-family:var(--font-serif);font-weight:300;cursor:pointer;transition:all .2s;}
    .btn.secondary{background:#fff;border:1px solid var(--line);color:var(--ink);}
    .btn.secondary:hover{border-color:var(--accent);color:var(--accent);}
    .btn.primary{background:var(--accent);color:#fff;}
    .btn.primary:hover{background:#a0854d;}

    .modal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.35);
      backdrop-filter:blur(6px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:80;
    }
    .modal.active{display:flex;}
    .modal-content{
      background:#fff;
      width:min(700px,90vw);
      border-radius:18px;
      padding:2.5rem 2.75rem;
      box-shadow:0 15px 50px rgba(0,0,0,0.15);
      border:1px solid #e9e6df;
      font-family:'Sarabun',sans-serif;
      color:var(--ink);
      line-height:1.6;
    }
    .modal-content h3{
      font-family:'Cormorant Garamond',serif;
      font-weight:300;
      font-size:1.9rem;
      color:#1a1a1a;
      margin-bottom:2rem;
      text-align:center;
      letter-spacing:0.3px;
    }
    .modal-content hr{
      border:none;
      border-top:1px solid #e0ded8;
      margin:1.5rem 0;
    }
    .modal-content p{
      margin:0.35rem 0;
      color:#2a2a2a;
      font-size:0.95rem;
      display:flex;
      align-items:baseline;
      gap:6px;
    }
    .modal-content strong{
      font-family:'Cormorant Garamond',serif;
      font-weight:300;
      font-size:1rem;
      color:#111;
      min-width:130px;
      display:inline-block;
    }
    .close-btn{
      display:block;
      margin:2rem auto 0;
      background:#faf9f6;
      border:1px solid #d8d3c9;
      padding:0.55rem 1.2rem;
      border-radius:8px;
      font-size:0.9rem;
      cursor:pointer;
      color:#333;
      transition:all 0.2s ease;
      font-family:'Cormorant Garamond',serif;
    }
    .close-btn:hover{
      background:var(--accent);
      border-color:var(--accent);
      color:#fff;
    }
    body.modal-open{overflow:hidden;}
    .toast.inline-toast{
      position:fixed;
      bottom:-120px;
      right:32px;
      max-width:320px;
      background:rgba(182,164,122,0.95);
      color:#fff;
      padding:0.85rem 1.1rem;
      border-radius:10px;
      font-size:0.9rem;
      box-shadow:0 4px 18px rgba(0,0,0,0.18);
      gap:0.65rem;
      display:flex;
      align-items:center;
      transition:bottom .35s ease;
      z-index:85;
    }
    .toast.inline-toast.show{bottom:34px;}
    .toast.inline-toast.error{background:#c0392b;}
    .toast.inline-toast a{color:#fff;text-decoration:underline;margin-left:10px;}

  </style>
</head>
<body>
  <script>
    (function applyStoredTheme() {
      try {
        const raw = localStorage.getItem("lpc_user");
        if (!raw) return;
        const stored = JSON.parse(raw);
        const theme = String(stored?.preferences?.theme || "").toLowerCase();
        const allowed = new Set(["light", "dark", "mountain", "mountain-dark"]);
        if (allowed.has(theme)) {
          const classes = theme === "mountain-dark" ? ["theme-mountain-dark", "theme-dark"] : [`theme-${theme}`];
          classes.forEach((cls) => document.body.classList.add(cls));
        }
        const fontKey = String(stored?.preferences?.fontSize || "").toLowerCase();
        const sizeMap = { xs: "14px", sm: "15px", md: "16px", lg: "17px", xl: "20px" };
        if (sizeMap[fontKey]) {
          document.documentElement.style.fontSize = sizeMap[fontKey];
        }
      } catch {
        /* ignore */
      }
    })();
  </script>
  <a class="skip-link" href="#main">Skip to main content</a>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo">Dashboard</div>
    <nav>
      <a href="dashboard-attorney.html">Home</a>
      <a href="dashboard-attorney.html#cases">Cases &amp; Files</a>
      <a href="dashboard-attorney.html#billing">Escrow</a>
      <a href="help.html">Help</a>
    </nav>
    <div class="sidebar-bottom">
      <button type="button" class="sidebar-link" id="logoutBtn">Log Out</button>
      <div class="sidebar-footer"><a href="index.html" style="color:inherit;text-decoration:none;">© Let’s-ParaConnect 2025</a></div>
    </div>
  </aside>

  <!-- Main -->
  <main id="main" tabindex="-1" class="main">
    <div class="topbar" data-attorney-header></div>

    <section class="step-panel" data-step="details" id="create-step-details">
      <header>
        <h1>Create a New Case</h1>
        <p>Provide details to post your case and invite paralegals to apply.</p>
      </header>

      <div class="steps">
        <a href="#details" class="step active" data-step-link="details">
          <div class="circle">1</div><span>Case details</span>
        </a>
        <a href="#description" class="step" data-step-link="description">
          <div class="circle">2</div><span>Description</span>
        </a>
        <a href="#review" class="step" data-step-link="review">
          <div class="circle">3</div><span>Review &amp; Post</span>
        </a>
      </div>

      <form>
        <div class="field">
          <label for="caseTitleInput">Case Title</label>
          <input id="caseTitleInput" type="text" placeholder="e.g., Draft asset purchase agreement" />
        </div>
      <div class="field">
        <label for="specialty">Field of Law</label>
        <select id="specialty">
              <option value="">Select…</option>
    <option>Administrative Law</option>
    <option>Admiralty & Maritime Law</option>
    <option>Antitrust Law</option>
    <option>Appellate Law</option>
    <option>Banking Law</option>
    <option>Bankruptcy Law</option>
    <option>Business / Corporate Law</option>
    <option>Civil Rights Law</option>
    <option>Class Action Law</option>
    <option>Commercial Law</option>
    <option>Communications Law</option>
    <option>Construction Law</option>
    <option>Consumer Protection Law</option>
    <option>Contract Law</option>
    <option>Criminal Defense Law</option>
    <option>Education Law</option>
    <option>Elder Law</option>
    <option>Election Law</option>
    <option>Employment & Labor Law</option>
    <option>Energy Law</option>
    <option>Entertainment Law</option>
    <option>Environmental Law</option>
    <option>Estate Planning & Probate</option>
    <option>Family Law</option>
    <option>Franchise Law</option>
    <option>Government Contracts Law</option>
    <option>Health Care Law</option>
    <option>Immigration Law</option>
    <option>Insurance Law</option>
    <option>Intellectual Property (IP) Law</option>
    <option>International Law</option>
    <option>Land Use & Zoning Law</option>
    <option>Litigation</option>
    <option>Media Law</option>
    <option>Medical Malpractice</option>
    <option>Military Law</option>
    <option>Municipal Law</option>
    <option>Personal Injury Law</option>
    <option>Product Liability Law</option>
    <option>Real Estate Law</option>
    <option>Securities Law</option>
    <option>Social Security / Disability Law</option>
    <option>Sports Law</option>
    <option>Tax Law</option>
    <option>Technology Law</option>
    <option>Telecommunications Law</option>
    <option>Torts</option>
    <option>Transportation Law</option>
    <option>Trusts & Estates</option>
    <option>White Collar Crime</option>
    <option>Workers’ Compensation</option>
  </select>
</div>

      <div class="field">
  <label for="state">Location (State)</label>
  <select id="state">
    <option value="">Select…</option>
    <option>Alabama</option>
    <option>Alaska</option>
    <option>Arizona</option>
    <option>Arkansas</option>
    <option>California</option>
    <option>Colorado</option>
    <option>Connecticut</option>
    <option>Delaware</option>
    <option>District of Columbia</option>
    <option>Florida</option>
    <option>Georgia</option>
    <option>Hawaii</option>
    <option>Idaho</option>
    <option>Illinois</option>
    <option>Indiana</option>
    <option>Iowa</option>
    <option>Kansas</option>
    <option>Kentucky</option>
    <option>Louisiana</option>
    <option>Maine</option>
    <option>Maryland</option>
    <option>Massachusetts</option>
    <option>Michigan</option>
    <option>Minnesota</option>
    <option>Mississippi</option>
    <option>Missouri</option>
    <option>Montana</option>
    <option>Nebraska</option>
    <option>Nevada</option>
    <option>New Hampshire</option>
    <option>New Jersey</option>
    <option>New Mexico</option>
    <option>New York</option>
    <option>North Carolina</option>
    <option>North Dakota</option>
    <option>Ohio</option>
    <option>Oklahoma</option>
    <option>Oregon</option>
    <option>Pennsylvania</option>
    <option>Rhode Island</option>
    <option>South Carolina</option>
    <option>South Dakota</option>
    <option>Tennessee</option>
    <option>Texas</option>
    <option>Utah</option>
    <option>Vermont</option>
    <option>Virginia</option>
    <option>Washington</option>
    <option>West Virginia</option>
    <option>Wisconsin</option>
    <option>Wyoming</option>
  </select>
</div>

  <div class="field">
  <label for="comp">Compensation</label>
  <div class="comp-wrapper">
    <span class="dollar-sign">$</span>
    <input id="comp" type="number" min="0" placeholder="Amount" />
  </div>
  <p class="muted lock-note" id="compLockNotice">You may edit the case amount until the first invitation is sent or a paralegal applies. After that point, the amount is automatically locked.</p>
</div>

      <div class="field select-field">
        <label for="experience">Preferred Experience (Optional)</label>
        <div class="select-wrapper">
          <select id="experience">
            <option value="">No preference</option>
            <option value="1–3 years (Early Career)">1–3 years (Early Career)</option>
            <option value="3–7 years (Intermediate)">3–7 years (Intermediate)</option>
            <option value="7–12 years (Experienced)">7–12 years (Experienced)</option>
            <option value="12+ years (Advanced)">12+ years (Advanced)</option>
          </select>
          <span class="select-arrow">▾</span>
        </div>
      </div>

      </form>

      <div class="actions">
        <button type="button" class="btn secondary" data-nav="cancel" data-target="dashboard-attorney.html">Cancel</button>
        <button type="button" class="btn primary" data-step-switch="description" id="detailsNextBtn">Next Step</button>
      </div>
    </section>

    <section class="step-panel" data-step="description" id="create-step-description" hidden>
      <header>
        <h1>Create a New Case</h1>
        <p>Step 2: Add a detailed description for your case posting.</p>
      </header>

      <div class="steps">
        <a href="#details" class="step" data-step-link="details">
          <div class="circle">1</div><span>Case details</span>
        </a>
        <a href="#description" class="step active" data-step-link="description">
          <div class="circle">2</div><span>Description</span>
        </a>
        <a href="#review" class="step" data-step-link="review">
          <div class="circle">3</div><span>Review &amp; Post</span>
        </a>
      </div>

      <div class="form-wrapper">
        <form>
          <div class="case-title-preview" id="caseTitlePreview">
            <strong>Case Title:</strong> <span id="caseTitlePreviewText">Untitled Case</span>
          </div>
          <div class="field">
            <label for="caseDescription">Case Description</label>
            <textarea id="caseDescription" placeholder="Describe your case, goals, and expectations for the paralegal..." maxlength="4000"></textarea>
            <div class="char-count" id="descriptionCharCount">0 / 4000</div>
          </div>
          <div class="field" id="caseTasksField">
            <label for="caseTaskInput">Tasks (optional)</label>
            <div class="task-input-row">
              <input id="caseTaskInput" type="text" placeholder="e.g., Draft initial motion" />
              <button type="button" class="btn secondary" id="addCaseTaskBtn">Add</button>
            </div>
            <p class="task-helper" id="caseTaskHelper">Tasks describe the overall scope of work, not every individual step. Additional work requires a new case.</p>
            <ul class="task-list" id="caseTaskList"></ul>
          </div>
          <div class="field">
            <label for="caseDeadline">Deadline (optional)</label>
            <input id="caseDeadline" type="date" placeholder="YYYY-MM-DD" />
            <small style="color:var(--muted);">You can type a date or use the picker.</small>
          </div>
        </form>

        <div class="tips">
          <h3>Tips for a Great Description</h3>
          <ul>
            <li>Be clear, well-written, and detailed about your case needs.</li>
            <li>Include the scope of work, deliverables, and deadlines.</li>
            <li>Avoid sensitive or identifying details in the posting.</li>
          </ul>
          <p>For examples of effective job descriptions, <a href="help.html">read our help article</a>.</p>
        </div>

        <div class="actions">
          <button type="button" class="btn secondary" data-step-switch="details">Back</button>
          <button type="button" class="btn secondary" data-nav="cancel" data-target="dashboard-attorney.html#cases:draft" data-save-draft="true">Save and Exit</button>
          <button type="button" class="btn primary" data-step-switch="review">Next Step</button>
        </div>
      </div>
    </section>
    <section class="step-panel" data-step="review" id="create-step-review" hidden>
      <header>
        <h1>Review &amp; Post Your Case</h1>
        <p>Step 3: Confirm details before posting your case publicly.</p>
      </header>

      <div class="steps">
        <a href="#details" class="step" data-step-link="details">
          <div class="circle">1</div><span>Case details</span>
        </a>
        <a href="#description" class="step" data-step-link="description">
          <div class="circle">2</div><span>Description</span>
        </a>
        <a href="#review" class="step active" data-step-link="review">
          <div class="circle">3</div><span>Review &amp; Post</span>
        </a>
      </div>

      <section class="summary" id="reviewSummary">
        <p>Gathering your case details…</p>
      </section>

      <div class="actions">
        <button type="button" class="btn secondary" data-step-switch="description">Back</button>
        <button type="button" class="btn secondary" data-nav="cancel" data-target="dashboard-attorney.html#cases:draft" data-save-draft="true">Save &amp; Exit</button>
        <button type="button" class="btn secondary" id="previewBtn">Preview Listing</button>
        <button type="button" class="btn primary" id="postBtn">Post Case</button>
      </div>
    </section>
  </main>
  <div id="toastBanner" class="toast" role="status" aria-live="polite"></div>
  <div class="modal" id="previewModal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="previewTitle">
      <h3 id="previewTitle"></h3>
      <p><strong>Field of Law:</strong> <span id="previewField">—</span></p>
      <p><strong>Location:</strong> <span id="previewState">—</span></p>
      <p><strong>Compensation:</strong> <span id="previewComp">—</span></p>
      <p><strong>Experience:</strong> <span id="previewExperience">—</span></p>
      <hr>
      <p id="previewDescription"></p>
      <div class="preview-tasks" id="previewTasks"></div>
      <p class="auto-note" id="previewAutoNote"></p>
      <button type="button" class="close-btn" id="closePreview">Close Preview</button>
    </div>
  </div>
  <div class="toast inline-toast" id="toast">
    ✅ Your case has been successfully posted.
    <a href="dashboard-attorney.html#cases">View Posted Case</a>
  </div>
  <script src="assets/scripts/utils/toast.js"></script>
  <script>
    window.__ATTORNEY_PAGE__ = "create-case";
    window.__SKIP_NOTIFICATIONS__ = true;
  </script>
  <script type="module" src="assets/scripts/attorney-tabs.js"></script>

  <script>
  (function () {
    const params = new URLSearchParams(window.location.search);
    const editingCaseId = params.get("caseId");
    const isEditing = Boolean(editingCaseId);

    const stepPanels = new Map();
    document.querySelectorAll(".step-panel").forEach((panel) => {
      const key = panel.dataset.step;
      if (key) stepPanels.set(key, panel);
    });
    let currentStep = null;

    const fields = {
      title: document.getElementById("caseTitleInput"),
      specialty: document.getElementById("specialty"),
      state: document.getElementById("state"),
      comp: document.getElementById("comp"),
      experience: document.getElementById("experience"),
      deadline: document.getElementById("caseDeadline"),
    };
    const taskInput = document.getElementById("caseTaskInput");
    const taskAddBtn = document.getElementById("addCaseTaskBtn");
    const taskList = document.getElementById("caseTaskList");
    const taskHelper = document.getElementById("caseTaskHelper");
    const compLockNotice = document.getElementById("compLockNotice");
    const compWrapper = fields.comp?.closest(".comp-wrapper");
    const titlePreview = document.getElementById("caseTitlePreviewText");
    const descriptionInput = document.getElementById("caseDescription");
    const descriptionCount = document.getElementById("descriptionCharCount");
    const toastHelper = window.toastUtils;
    const reviewSummary = document.getElementById("reviewSummary");
    const previewBtn = document.getElementById("previewBtn");
    const postBtn = document.getElementById("postBtn");
    const previewModal = document.getElementById("previewModal");
    const closePreviewBtn = document.getElementById("closePreview");
    const toastEl = document.getElementById("toast");
    const previewFields = {
      title: document.getElementById("previewTitle"),
      field: document.getElementById("previewField"),
      state: document.getElementById("previewState"),
      comp: document.getElementById("previewComp"),
      experience: document.getElementById("previewExperience"),
      description: document.getElementById("previewDescription"),
      tasks: document.getElementById("previewTasks"),
    };
    const previewAutoNote = document.getElementById("previewAutoNote");
    const autoNoteCopy = "Applicants automatically include their résumé, cover letter (if available), and LinkedIn profile.";
    let latestCaseData = null;
    let csrfToken = "";
    const tasksState = {
      items: [],
      locked: false,
    };

    const validators = [
      {
        field: fields.title,
        check: (value) => value.trim().length >= 3,
        message: "Add a descriptive case title.",
      },
      {
        field: fields.specialty,
        check: (value) => Boolean(value.trim()),
        message: "Select the primary practice area.",
      },
      {
        field: fields.state,
        check: (value) => Boolean(value.trim()),
        message: "Select the state or jurisdiction.",
      },
      {
        field: fields.comp,
        check: (value) => Number(value) > 0,
        message: "Enter the compensation amount.",
      },
    ];

    function updateTitlePreview(value = "") {
      if (!titlePreview) return;
      const safe = value.trim();
      titlePreview.textContent = safe || "Untitled Case";
    }

    function updateDescriptionCount() {
      if (!descriptionInput || !descriptionCount) return;
      descriptionCount.textContent = `${descriptionInput.value.length} / 4000`;
    }

    const STORAGE_PARSE_LIMIT = 50000;
    const MAX_REVIEW_DESCRIPTION = 1200;
    const MAX_REVIEW_TASKS = 25;

    function normalizeTaskTitle(value) {
      return String(value || "")
        .replace(/[\u0000-\u001F\u007F]/g, "")
        .trim()
        .slice(0, 200);
    }

    function readStoredTasks() {
      try {
        const raw = localStorage.getItem("caseTasks") || localStorage.getItem("case_tasks") || "";
        if (raw.length > STORAGE_PARSE_LIMIT) return [];
        const parsed = JSON.parse(raw || "[]");
        if (Array.isArray(parsed)) {
          return parsed
            .map((entry) => {
              const title = normalizeTaskTitle(typeof entry === "string" ? entry : entry?.title);
              return title ? { title } : null;
            })
            .filter(Boolean);
        }
      } catch {}
      return [];
    }

    function persistTasks() {
      const payload = tasksState.items.map((task) => ({ title: task.title }));
      localStorage.setItem("caseTasks", JSON.stringify(payload));
      localStorage.setItem("case_tasks", JSON.stringify(payload));
    }

    function renderTasks() {
      if (!taskList) return;
      taskList.innerHTML = "";
      if (!tasksState.items.length) {
        const empty = document.createElement("li");
        empty.className = "task-empty";
        empty.textContent = "No tasks added yet.";
        taskList.appendChild(empty);
        return;
      }
      tasksState.items.forEach((task, idx) => {
        const row = document.createElement("li");
        const label = document.createElement("span");
        label.textContent = task.title;
        row.appendChild(label);
        if (!tasksState.locked) {
          const removeBtn = document.createElement("button");
          removeBtn.type = "button";
          removeBtn.className = "task-remove";
          removeBtn.textContent = "Remove";
          removeBtn.addEventListener("click", () => {
            tasksState.items.splice(idx, 1);
            persistTasks();
            renderTasks();
          });
          row.appendChild(removeBtn);
        }
        taskList.appendChild(row);
      });
    }

    function setTasksLocked(locked) {
      tasksState.locked = !!locked;
      if (taskInput) taskInput.disabled = tasksState.locked;
      if (taskAddBtn) taskAddBtn.disabled = tasksState.locked;
      if (taskHelper) taskHelper.style.display = tasksState.locked ? "none" : "";
      renderTasks();
    }

    function hydrateDeadline() {
      if (!fields.deadline) return;
      const stored = getStoredValue("caseDeadline", "case_deadline");
      if (stored) fields.deadline.value = stored;
    }

    function showStep(step, { updateHash = true } = {}) {
      if (!stepPanels.has(step)) return;
      stepPanels.forEach((panel, key) => {
        if (!panel) return;
        panel.hidden = key !== step;
      });
      currentStep = step;
      if (updateHash) {
        history.replaceState(null, "", `#${step}`);
      }
    }

    function attemptStepChange(targetStep) {
      if (!targetStep || targetStep === currentStep) return;
      if (targetStep === "description" && currentStep !== "description") {
        if (!validateDetails()) return;
        persistDraft();
      }
      if (targetStep === "review") {
        if (!ensureReviewReady()) return;
        persistDraft();
        hydrateReviewSummary();
      }
      showStep(targetStep);
    }

    document.querySelectorAll("[data-step-link]").forEach((link) => {
      link.addEventListener("click", (event) => {
        const target = link.dataset.stepLink;
        if (!target) return;
        event.preventDefault();
        attemptStepChange(target);
      });
    });
    document.querySelectorAll("[data-step-switch]").forEach((btn) => {
      btn.addEventListener("click", () => {
        const target = btn.dataset.stepSwitch;
        if (!target) return;
        attemptStepChange(target);
      });
    });

    const initialHash = (window.location.hash || "").replace("#", "");
    if (initialHash && stepPanels.has(initialHash)) {
      if (initialHash === "description") {
        showStep("details", { updateHash: false });
        attemptStepChange("description");
      } else if (initialHash === "review") {
        showStep("details", { updateHash: false });
        attemptStepChange("description");
        attemptStepChange("review");
      } else {
        showStep(initialHash, { updateHash: false });
      }
    } else {
      showStep("details", { updateHash: false });
    }

    window.addEventListener("hashchange", () => {
      const hashed = (window.location.hash || "").replace("#", "");
      if (!hashed || hashed === currentStep) return;
      if (!stepPanels.has(hashed)) return;
      if (hashed === "description" || hashed === "review") {
        attemptStepChange(hashed);
      } else {
        showStep(hashed, { updateHash: false });
      }
    });

    Object.entries(fields).forEach(([key, field]) => {
      if (!field) return;
      const eventName = field.tagName === "SELECT" ? "change" : "input";
      field.addEventListener(eventName, () => clearFieldError(field));
      const storageKeyCamel = `case${key.charAt(0).toUpperCase() + key.slice(1)}`;
      const storedValue = isEditing ? "" : localStorage.getItem(storageKeyCamel) || localStorage.getItem(`case_${key}`) || "";
      if (storedValue && field.value !== storedValue) {
        field.value = storedValue;
      }
      if (key === "title") {
        updateTitlePreview(field.value || storedValue || "");
      }
      field.addEventListener(eventName, () => {
        const value = field.value || "";
        localStorage.setItem(storageKeyCamel, value);
        localStorage.setItem(`case_${key}`, value);
        if (key === "title") {
          updateTitlePreview(value);
        }
      });
    });

    if (descriptionInput) {
      const storedDescription = isEditing
        ? ""
        : localStorage.getItem("caseDescription") || localStorage.getItem("case_description") || "";
      if (storedDescription) {
        descriptionInput.value = storedDescription.slice(0, 4000);
      }
      updateDescriptionCount();
      hydrateDeadline();
      descriptionInput.addEventListener("input", () => {
        if (descriptionInput.value.length > 4000) {
          descriptionInput.value = descriptionInput.value.slice(0, 4000);
        }
        try {
          localStorage.setItem("caseDescription", descriptionInput.value);
          localStorage.setItem("case_description", descriptionInput.value);
        } catch {}
        updateDescriptionCount();
      });
    }

    tasksState.items = isEditing ? [] : readStoredTasks();
    renderTasks();
    if (taskAddBtn && taskInput) {
      taskAddBtn.addEventListener("click", () => {
        if (tasksState.locked) return;
        const title = normalizeTaskTitle(taskInput.value);
        if (!title) return;
        tasksState.items.push({ title });
        taskInput.value = "";
        persistTasks();
        renderTasks();
      });
      taskInput.addEventListener("keydown", (event) => {
        if (event.key !== "Enter") return;
        event.preventDefault();
        taskAddBtn.click();
      });
    }

    function validateDetails() {
      let hasErrors = false;
      validators.forEach(({ field, check, message }) => {
        clearFieldError(field);
        if (!field) return;
        if (!check(field.value || "")) {
          showFieldError(field, message);
          hasErrors = true;
        }
      });
      if (hasErrors) {
        return false;
      }
      return true;
    }

    function persistDraft() {
      localStorage.setItem("caseTitle", fields.title?.value?.trim() || "");
      localStorage.setItem("caseSpecialty", fields.specialty?.value || "");
      localStorage.setItem("caseState", fields.state?.value || "");
      localStorage.setItem("caseComp", fields.comp?.value || "");
      localStorage.setItem("caseCompAmount", fields.comp?.value || "");
      localStorage.setItem("caseExperience", fields.experience?.value || "");
      localStorage.setItem("caseDeadline", fields.deadline?.value || "");
    }

    function showFieldError(field, message) {
      if (!field) return;
      clearFieldError(field);
      field.classList.add("input-error");
      field.setAttribute("aria-invalid", "true");
      const error = document.createElement("div");
      error.className = "field-error";
      error.textContent = message;
      const wrapper = field.closest(".field") || field.closest("[data-field-wrapper]");
      if (wrapper) wrapper.appendChild(error);
      else field.insertAdjacentElement("afterend", error);
    }

    function clearFieldError(field) {
      if (!field) return;
      field.classList.remove("input-error");
      field.removeAttribute("aria-invalid");
      const wrapper = field.closest(".field") || field.closest("[data-field-wrapper]");
      if (wrapper) {
        const existing = wrapper.querySelector(".field-error");
        if (existing) existing.remove();
        return;
      }
      const next = field.nextElementSibling;
      if (next?.classList.contains("field-error")) {
        next.remove();
      }
    }

    function getStoredValue(primaryKey, legacyKey) {
      const value = localStorage.getItem(primaryKey) || localStorage.getItem(legacyKey) || "";
      if (primaryKey === "caseDescription" || legacyKey === "case_description") {
        return value.slice(0, 4000);
      }
      return value;
    }

    function formatComp(amount) {
      if (!amount) return "—";
      const numeric = Number(amount);
      if (!Number.isFinite(numeric)) return `$${amount}`;
      return numeric.toLocaleString("en-US", { style: "currency", currency: "USD", maximumFractionDigits: 0 });
    }

    function escapeHTML(value) {
      return String(value ?? "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function collectCaseData() {
      const title = (fields.title?.value || "").trim() || getStoredValue("caseTitle", "case_title");
      const field = fields.specialty?.value || getStoredValue("caseSpecialty", "case_specialty");
      const state = fields.state?.value || getStoredValue("caseState", "case_state");
      const compRaw = fields.comp?.value || getStoredValue("caseCompAmount", "case_comp_amount");
      const experience = fields.experience?.value || getStoredValue("caseExperience", "case_experience");
      const deadline = fields.deadline?.value || getStoredValue("caseDeadline", "case_deadline");
      let description = (descriptionInput?.value || "").trim() || getStoredValue("caseDescription", "case_description").trim();
      if (description.length > 4000) {
        description = description.slice(0, 4000);
      }
      const tasks = tasksState.items.length ? tasksState.items : readStoredTasks();
      return {
        title: title || "",
        field: field || "",
        state: state || "",
        compAmount: compRaw || "",
        comp: formatComp(compRaw),
        experience: experience || "",
        deadline: deadline || "",
        description: description || "",
        tasks,
      };
    }

    function setCompLocked(locked) {
      if (!fields.comp) return;
      fields.comp.disabled = !!locked;
      fields.comp.setAttribute("aria-disabled", locked ? "true" : "false");
      compWrapper?.classList.toggle("is-locked", !!locked);
    }

    function hasDescription() {
      if ((descriptionInput?.value || "").trim()) return true;
      return Boolean(getStoredValue("caseDescription", "case_description").trim());
    }

    function ensureReviewReady() {
      if (!validateDetails()) return false;
      if (!hasDescription()) {
        return false;
      }
      if (fields.deadline && fields.deadline.value) {
        const parsed = new Date(fields.deadline.value);
        if (Number.isNaN(parsed.getTime())) {
          showToastBanner("Enter a valid deadline date (YYYY-MM-DD).", "error");
          return false;
        }
      }
      return true;
    }

    function hydrateReviewSummary() {
      if (!reviewSummary) return;
      const data = collectCaseData();
      latestCaseData = data;
      const deadlineText = data.deadline
        ? new Date(data.deadline).toLocaleDateString() || data.deadline
        : "No deadline set";
      const tasks = Array.isArray(data.tasks) ? data.tasks : [];
      const visibleTasks = tasks.slice(0, MAX_REVIEW_TASKS);
      const extraTasks = tasks.length - visibleTasks.length;
      const tasksMarkup = visibleTasks.length
        ? `<ul class="task-list">${visibleTasks
            .map((task) => `<li>${escapeHTML(task.title)}</li>`)
            .join("")}</ul>`
        : `<p><strong>Tasks:</strong> Not provided</p>`;
      const safeTitle = escapeHTML(data.title || "(Untitled Case)");
      const safeField = escapeHTML(data.field || "Practice area pending");
      const safeState = escapeHTML(data.state || "Location pending");
      const safeComp = escapeHTML(data.comp || "—");
      const safeExperience = escapeHTML(data.experience || "Not specified");
      const safeDeadline = escapeHTML(deadlineText);
      const rawDescription = data.description || "No description provided yet.";
      const safeDescription = escapeHTML(rawDescription);
      const truncated =
        safeDescription.length > MAX_REVIEW_DESCRIPTION
          ? `${safeDescription.slice(0, MAX_REVIEW_DESCRIPTION)}…`
          : safeDescription;
      const displayDescription = truncated.replace(/\n/g, "<br>");
      reviewSummary.innerHTML = `
        <h2>${safeTitle}</h2>
        <p><small>${safeField} • ${safeState}</small></p>
        <p><strong>Compensation:</strong> ${safeComp}</p>
        <p><strong>Experience:</strong> ${safeExperience}</p>
        <p><strong>Deadline:</strong> ${safeDeadline}</p>
        <hr>
        <p>${displayDescription}</p>
        <div style="margin-top:12px;">
          <div class="description-label" style="margin-bottom:6px;">TASKS</div>
          ${tasksMarkup}
        </div>
        ${extraTasks > 0 ? `<p class="auto-note">+${extraTasks} more tasks will be included when you post.</p>` : ""}
        <p class="auto-note">${autoNoteCopy}</p>
      `;
    }

    function openPreviewModal() {
      if (!previewModal) return;
      const data = latestCaseData || collectCaseData();
      if (!data.title || !data.description) {
        showToastBanner("Add a case title and description before previewing.", "error");
        return;
      }
      const tasks = Array.isArray(data.tasks) ? data.tasks : [];
      const visibleTasks = tasks.slice(0, MAX_REVIEW_TASKS);
      const extraTasks = tasks.length - visibleTasks.length;
      const tasksMarkup = visibleTasks.length
        ? `<div class="description-label" style="margin-bottom:6px;">TASKS</div>
           <ul class="task-list">${visibleTasks
             .map((task) => `<li>${escapeHTML(task.title)}</li>`)
             .join("")}</ul>${extraTasks > 0 ? `<p class="auto-note">+${extraTasks} more tasks will be included when you post.</p>` : ""}`
        : `<p><strong>Tasks:</strong> Not provided</p>`;
      previewFields.title && (previewFields.title.textContent = data.title);
      previewFields.field && (previewFields.field.textContent = data.field || "—");
      previewFields.state && (previewFields.state.textContent = data.state || "—");
      previewFields.comp && (previewFields.comp.textContent = data.comp || "—");
      previewFields.experience && (previewFields.experience.textContent = data.experience || "—");
      previewFields.description && (previewFields.description.textContent = data.description || "No description provided yet.");
      previewFields.tasks && (previewFields.tasks.innerHTML = tasksMarkup);
      if (data.deadline) {
        const deadlineText = new Date(data.deadline).toLocaleDateString() || data.deadline;
        previewFields.description.insertAdjacentHTML("beforebegin", `<p><strong>Deadline:</strong> ${deadlineText}</p>`);
      }
      if (previewAutoNote) previewAutoNote.textContent = autoNoteCopy;
      previewModal.classList.add("active");
      document.body.classList.add("modal-open");
    }

    function closePreviewModal() {
      if (!previewModal) return;
      previewModal.classList.remove("active");
      document.body.classList.remove("modal-open");
    }

    function clearDraft() {
      [
        "caseTitle",
        "caseSpecialty",
        "caseState",
        "caseComp",
        "caseCompAmount",
        "caseExperience",
        "caseDescription",
        "caseTasks",
        "case_tasks",
      ].forEach((key) => localStorage.removeItem(key));
    }

    function showToast(message, href, isError = false) {
      if (!toastEl) return;
      const linkHtml = href ? ` <a href="${href}">View Case</a>` : "";
      toastEl.innerHTML = `${isError ? "⚠️" : "✅"} ${message}${linkHtml}`;
      toastEl.classList.toggle("error", Boolean(isError));
      toastEl.classList.add("show");
      setTimeout(() => toastEl.classList.remove("show"), 5000);
    }

    async function fetchCsrfToken() {
      if (csrfToken) return csrfToken;
      try {
        const res = await fetch("/api/csrf", { credentials: "include" });
        const json = await res.json().catch(() => ({}));
        csrfToken = json?.csrfToken || "";
      } catch (err) {
        console.warn("Unable to fetch CSRF token", err);
      }
      return csrfToken;
    }

    async function readResponsePayload(res) {
      const text = await res.text().catch(() => "");
      if (!text) return { data: {}, text: "" };
      try {
        return { data: JSON.parse(text), text };
      } catch {
        return { data: {}, text };
      }
    }

    async function submitCase(payload) {
      const token = (window.getSessionToken && window.getSessionToken()) || "";
      if (!token) {
        window.checkSession?.("attorney");
        throw new Error("Please log in again before posting.");
      }
      await fetchCsrfToken();
      const res = await fetch("/api/cases", {
        method: "POST",
        credentials: "include",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
          "X-CSRF-Token": csrfToken || "",
          Accept: "application/json",
        },
        body: JSON.stringify(payload),
      });
      const { data, text } = await readResponsePayload(res);
      if (!res.ok) {
        const message = data?.error || data?.msg || data?.message || (text && !text.includes("<") ? text : "");
        const statusNote = res.status ? ` (HTTP ${res.status})` : "";
        throw new Error(message || `Unable to post this case right now.${statusNote}`);
      }
      return data;
    }

    function mapPracticeArea(area = "") {
      // Must align exactly with backend PRACTICE_AREAS (lowercase)
      const allowed = [
        "administrative law",
        "bankruptcy",
        "business law",
        "civil litigation",
        "commercial litigation",
        "contract law",
        "corporate law",
        "criminal defense",
        "employment law",
        "estate planning",
        "family law",
        "immigration",
        "intellectual property",
        "labor law",
        "personal injury",
        "real estate",
        "tax law",
        "technology",
        "trusts & estates",
      ];
      const aliases = {
        "admiralty & maritime law": "civil litigation",
        "antitrust law": "commercial litigation",
        "appellate law": "civil litigation",
        "banking law": "business law",
        "bankruptcy law": "bankruptcy",
        "business / corporate law": "business law",
        "civil rights law": "civil litigation",
        "class action law": "civil litigation",
        "commercial law": "commercial litigation",
        "communications law": "technology",
        "construction law": "civil litigation",
        "consumer protection law": "civil litigation",
        "corporate law": "corporate law",
        "criminal defense law": "criminal defense",
        "education law": "administrative law",
        "elder law": "estate planning",
        "election law": "administrative law",
        "employment & labor law": "employment law",
        "energy law": "technology",
        "entertainment law": "technology",
        "environmental law": "civil litigation",
        "estate planning & probate": "estate planning",
        "franchise law": "business law",
        "government contracts law": "contract law",
        "health care law": "employment law",
        "immigration law": "immigration",
        "insurance law": "business law",
        "intellectual property (ip) law": "intellectual property",
        "international law": "business law",
        "land use & zoning law": "real estate",
        "litigation": "civil litigation",
        "media law": "technology",
        "medical malpractice": "personal injury",
        "military law": "administrative law",
        "municipal law": "administrative law",
        "personal injury law": "personal injury",
        "product liability law": "personal injury",
        "real estate law": "real estate",
        "securities law": "business law",
        "social security / disability law": "administrative law",
        "sports law": "business law",
        "technology law": "technology",
        "telecommunications law": "technology",
        "torts": "civil litigation",
        "transportation law": "business law",
        "trusts & estates": "trusts & estates",
        "white collar crime": "criminal defense",
        "workers’ compensation": "employment law",
      };

      const cleaned = area.trim().replace(/[’']/g, "'").toLowerCase();
      if (allowed.includes(cleaned)) return cleaned;
      if (aliases[cleaned]) return aliases[cleaned];
      const ampCandidate = cleaned.replace(/\band\b/g, "&").replace(/\s*&\s*/g, " & ");
      if (allowed.includes(ampCandidate)) return ampCandidate;
      if (aliases[ampCandidate]) return aliases[ampCandidate];

      // Broad keyword fallbacks
      if (cleaned.includes("contract")) return "contract law";
      if (cleaned.includes("family")) return "family law";
      if (cleaned.includes("immigration")) return "immigration";
      if (cleaned.includes("real estate") || cleaned.includes("zoning") || cleaned.includes("land use"))
        return "real estate";
      if (cleaned.includes("employment") || cleaned.includes("labor")) return "employment law";
      if (cleaned.includes("corporate") || cleaned.includes("business")) return "business law";
      if (cleaned.includes("tax")) return "tax law";
      if (cleaned.includes("technology") || cleaned.includes("telecom") || cleaned.includes("media"))
        return "technology";
      if (cleaned.includes("ip") || cleaned.includes("intellectual")) return "intellectual property";
      if (cleaned.includes("injury") || cleaned.includes("liability") || cleaned.includes("malpractice"))
        return "personal injury";
      if (cleaned.includes("estate")) return "estate planning";
      if (cleaned.includes("trust")) return "trusts & estates";
      if (cleaned.includes("criminal") || cleaned.includes("white collar")) return "criminal defense";
      if (cleaned.includes("bankruptcy")) return "bankruptcy";
      // Default to a safe allowed value
      return "civil litigation";
    }

    function padDescription(text = "") {
      if (text.length >= 50) return text;
      const filler = " Additional details will be provided to qualified applicants.";
      let result = text.trim();
      while (result.length < 50) {
        result += filler;
      }
      return result;
    }

    function buildPayload(data) {
      const description = data.description || "Additional details will be provided once the case is accepted.";
      const practiceArea = mapPracticeArea(data.field);
      const deadline = data.deadline || "";
      const payload = {
        title: data.title,
        practiceArea,
        state: data.state,
        compensationAmount: data.compAmount,
        experience: data.experience,
        details: description,
        deadline,
      };
      if (!tasksState.locked) {
        payload.tasks = Array.isArray(data.tasks) ? data.tasks : [];
      }
      return payload;
    }

    const LOCAL_DRAFTS_KEY = "attorneyLocalDraftCases";
    let currentDraftId = localStorage.getItem("currentDraftId") || "";
    if (isEditing) {
      currentDraftId = editingCaseId;
    }

    function readLocalDrafts() {
      try {
        const raw = localStorage.getItem(LOCAL_DRAFTS_KEY);
        const parsed = JSON.parse(raw || "[]");
        return Array.isArray(parsed) ? parsed : [];
      } catch {
        return [];
      }
    }

    function writeLocalDrafts(list) {
      localStorage.setItem(LOCAL_DRAFTS_KEY, JSON.stringify(list || []));
    }

    function upsertLocalDraft(draft) {
      if (!draft?.id) return;
      const list = readLocalDrafts().filter((d) => d && d.id !== draft.id);
      list.unshift(draft);
      writeLocalDrafts(list);
    }

    function removeLocalDraft(draftId) {
      if (!draftId) return;
      const list = readLocalDrafts().filter((d) => d && d.id !== draftId);
      writeLocalDrafts(list);
    }

    function saveDraftToLocalList() {
      const data = latestCaseData || collectCaseData();
      if (!currentDraftId) {
        currentDraftId = `draft-${Date.now()}`;
        localStorage.setItem("currentDraftId", currentDraftId);
      }
      persistDraft();
      const now = new Date().toISOString();
      upsertLocalDraft({
        id: currentDraftId,
        title: data.title || "Untitled Case",
        practiceArea: data.field || "",
        details: data.description || "",
        state: data.state || "",
        status: "draft",
        createdAt: now,
        updatedAt: now,
        localDraft: true,
      });
    }

    function clearCurrentDraftId() {
      if (currentDraftId) {
        removeLocalDraft(currentDraftId);
      }
      currentDraftId = "";
      localStorage.removeItem("currentDraftId");
    }

    window.saveDraftAndExit = function (targetHref) {
      saveDraftToLocalList();
      if (targetHref) {
        window.location.href = targetHref;
      }
    };

    async function handlePost() {
      if (!ensureReviewReady()) {
        showToastBanner("Finish the required fields before posting.", "error");
        return;
      }
      const data = latestCaseData || collectCaseData();
      if (!data.title || !data.description) {
        showToastBanner("Add a case title and description before posting.", "error");
        return;
      }
      if (postBtn) postBtn.disabled = true;
      try {
        const payload = buildPayload(data);
        const created = isEditing && editingCaseId
          ? await updateCase(editingCaseId, payload)
          : await submitCase(payload);
        clearDraft();
        clearCurrentDraftId();
        const caseId = created?.id || created?._id || editingCaseId;
        // Jobs are now mirrored automatically when a case is created on the backend.
        const href = caseId
          ? isEditing
            ? `case-detail.html?caseId=${encodeURIComponent(caseId)}`
            : `dashboard-attorney.html?previewCaseId=${encodeURIComponent(caseId)}#cases`
          : "dashboard-attorney.html#cases";
        showToast(
          isEditing ? "Your changes have been saved." : "Your case has been posted and is now open to applications.",
          href
        );
      } catch (err) {
        console.error(err);
        showToast(err?.message || "Unable to post this case right now.", null, true);
        if (postBtn) postBtn.disabled = false;
      }
    }

    function showToastBanner(message, type = "info") {
      if (toastHelper?.show) {
        toastHelper.show(message, { targetId: "toastBanner", type });
      } else {
        alert(message);
      }
    }

    previewBtn?.addEventListener("click", openPreviewModal);
    closePreviewBtn?.addEventListener("click", closePreviewModal);
    previewModal?.addEventListener("click", (event) => {
      if (event.target === previewModal) closePreviewModal();
    });
    postBtn?.addEventListener("click", handlePost);

    function applyEditingCopy() {
      document.title = "Edit Case – Let’s-ParaConnect";
      const detailsHeader = document.querySelector('#create-step-details header h1');
      const detailsSub = document.querySelector('#create-step-details header p');
      const descHeader = document.querySelector('#create-step-description header h1');
      const descSub = document.querySelector('#create-step-description header p');
      const reviewHeader = document.querySelector('#create-step-review header h1');
      const reviewSub = document.querySelector('#create-step-review header p');
      const labelDetails = document.querySelectorAll('[data-step-link="details"] span');
      const labelDesc = document.querySelectorAll('[data-step-link="description"] span');
      const labelReview = document.querySelectorAll('[data-step-link="review"] span');
      detailsHeader && (detailsHeader.textContent = "Edit Case");
      detailsSub && (detailsSub.textContent = "Step 1: Update your case basics.");
      descHeader && (descHeader.textContent = "Edit Case");
      descSub && (descSub.textContent = "Step 2: Update the case description.");
      reviewHeader && (reviewHeader.textContent = "Review & Save Changes");
      reviewSub && (reviewSub.textContent = "Step 3: Confirm updates before saving.");
      labelDetails.forEach((el) => (el.textContent = "Case details"));
      labelDesc.forEach((el) => (el.textContent = "Description"));
      labelReview.forEach((el) => (el.textContent = "Review & Save"));
      if (postBtn) postBtn.textContent = "Save Changes";
      if (previewBtn) previewBtn.textContent = "Preview Updates";
    }

    function setSelectValue(select, value) {
      if (!select || !value) return;
      const target = value.toString().toLowerCase();
      const match = Array.from(select.options).find(
        (opt) => opt.value.toLowerCase() === target || opt.textContent.toLowerCase() === target
      );
      if (match) select.value = match.value;
    }

    function applyCaseDataToForm(caseData = {}) {
      if (fields.title) {
        fields.title.value = caseData.title || "";
        updateTitlePreview(fields.title.value);
      }
      setSelectValue(fields.specialty, caseData.practiceArea || caseData.field);
      setSelectValue(fields.state, caseData.locationState || caseData.state);
      const amountCents = Number.isFinite(caseData.lockedTotalAmount)
        ? caseData.lockedTotalAmount
        : Number(caseData.totalAmount) || 0;
      if (fields.comp) {
        fields.comp.value = amountCents ? Math.round(amountCents / 100) : "";
      }
      const hasParalegal = !!(caseData.paralegal || caseData.paralegalId);
      const hasPendingInvites = Array.isArray(caseData.invites)
        ? caseData.invites.some((invite) => String(invite?.status || "pending").toLowerCase() === "pending")
        : false;
      const hasPendingParalegal = !!(caseData.pendingParalegal || caseData.pendingParalegalId);
      const isLocked =
        caseData.lockedTotalAmount != null || hasParalegal || hasPendingInvites || hasPendingParalegal;
      setCompLocked(isLocked);
      if (fields.experience && caseData.experience) {
        setSelectValue(fields.experience, caseData.experience);
      }
      const details = caseData.details || caseData.description || "";
      if (descriptionInput) {
        descriptionInput.value = details;
        updateDescriptionCount();
      }
      if (fields.deadline && caseData.deadline) {
        const iso = new Date(caseData.deadline).toISOString().slice(0, 10);
        fields.deadline.value = iso;
      }
      const incomingTasks = Array.isArray(caseData.tasks) ? caseData.tasks : [];
      tasksState.items = incomingTasks
        .map((task) => ({
          title: normalizeTaskTitle(typeof task === "string" ? task : task?.title),
        }))
        .filter((task) => task.title);
      const lockTasks = Boolean(caseData.tasksLocked || caseData.paralegal || caseData.paralegalId || caseData.hiredAt);
      setTasksLocked(lockTasks);
      latestCaseData = collectCaseData();
      hydrateReviewSummary();
    }

    async function loadExistingCase() {
      if (!editingCaseId) return;
      try {
        const token = (window.getSessionToken && window.getSessionToken()) || "";
        const res = await fetch(`/api/cases/${encodeURIComponent(editingCaseId)}`, {
          headers: Object.assign({ Accept: "application/json" }, token ? { Authorization: `Bearer ${token}` } : {}),
          credentials: "include",
        });
        const { data, text } = await readResponsePayload(res);
        if (!res.ok) {
          const message = data?.error || data?.msg || data?.message || (text && !text.includes("<") ? text : "");
          const statusNote = res.status ? ` (HTTP ${res.status})` : "";
          throw new Error(message || `Unable to load this case for editing.${statusNote}`);
        }
        applyCaseDataToForm(data);
      } catch (err) {
        console.warn("Edit case load failed", err);
        showToastBanner(err?.message || "Unable to load this case for editing.", "error");
      }
    }

    async function updateCase(caseId, payload) {
      const token = (window.getSessionToken && window.getSessionToken()) || "";
      if (!token) {
        window.checkSession?.("attorney");
        throw new Error("Please log in again before saving changes.");
      }
      await fetchCsrfToken();
      const res = await fetch(`/api/cases/${encodeURIComponent(caseId)}`, {
        method: "PATCH",
        credentials: "include",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
          "X-CSRF-Token": csrfToken || "",
          Accept: "application/json",
        },
        body: JSON.stringify(payload),
      });
      const { data, text } = await readResponsePayload(res);
      if (!res.ok) {
        const message = data?.error || data?.msg || data?.message || (text && !text.includes("<") ? text : "");
        const statusNote = res.status ? ` (HTTP ${res.status})` : "";
        throw new Error(message || `Unable to save changes to this case.${statusNote}`);
      }
      return data;
    }

    if (isEditing) {
      clearDraft();
      applyEditingCopy();
      void loadExistingCase();
    }
  })();
  </script>
<script>
const compInput = document.getElementById('comp');
if (compInput) {
  compInput.addEventListener('input', () => {
    localStorage.setItem('caseCompAmount', compInput.value);
  });
}
</script>
<script src="assets/scripts/create-case-nav.js"></script>
</body>
</html>
