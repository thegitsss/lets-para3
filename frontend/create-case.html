<!DOCTYPE html>
<html lang="en">
<head>
  <script>
    (function applyEarlyTheme() {
      try {
        const raw = localStorage.getItem("lpc_user");
        if (!raw) return;
        const stored = JSON.parse(raw);
        const theme = String(stored?.preferences?.theme || "").toLowerCase();
        if (!theme) return;
        const classes = theme === "mountain-dark" ? ["theme-mountain-dark", "theme-dark"] : [`theme-${theme}`];
        classes.forEach((cls) => document.documentElement.classList.add(cls));
      } catch (_) {}
    })();
  </script>

  <link rel="stylesheet" href="assets/styles/fonts.css" />
  <link rel="stylesheet" href="assets/styles/notifications-dashboard.css" />
  <link rel="preload" as="image" href="hero-mountain.jpg" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta name="theme-color" content="#0B2A4A">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Create Case – Let’s-ParaConnect</title>
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png" />
  <link rel="icon" href="/favicon.ico" />
  <link rel="shortcut icon" href="/favicon.ico" />
  <link rel="manifest" href="site.webmanifest" />
  <link rel="mask-icon" href="maskable-icon.png" color="#0B2A4A" />

  <script src="assets/scripts/utils/session.js"></script>
  <style>
    .skip-link {
      position: absolute;
      left: 12px;
      top: -40px;
      background: #1a2230;
      color: #ffffff;
      padding: 8px 12px;
      border-radius: 6px;
      text-decoration: none;
      z-index: 10000;
      font-size: 14px;
    }

    .skip-link:focus {
      top: 12px;
    }

    .gold{color:#b4975a;}
    :root {
      --bg:#ffffff;
      --sidebar-bg:#f5f5f5e6;
      --accent:#b6a47a;
      --ink:#1a1a1a;
      --muted:#8a8a8a;
      --line:rgba(0,0,0,0.08);
      --panel:#fcfcfc;
      --sidebar-text:#1a1a1a;
      --radius:14px;
      --font-serif:'Cormorant Garamond',serif;
      --font-sans:'Sarabun',sans-serif;
    }
    body.theme-dark{
      --bg:#0f172a;
      --sidebar-bg:#1c2333;
      --panel:#151b29;
      --ink:#f5f6fb;
      --muted:#9aa7c4;
      --line:rgba(255,255,255,0.08);
      --sidebar-text:#f8fbff;
    }
    body.theme-mountain{
      --bg:#f8f6f1;
      --panel:#ffffff;
      --muted:#7a736a;
      --sidebar-text:#ffffff;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:var(--font-sans);
      background:var(--bg);
      color:var(--ink);
      display:flex;
      height:100vh;
      overflow:hidden;
      font-weight:200;
    }
    strong{
      font-family:var(--font-serif);
      font-weight:400;
    }

    /* Sidebar */
    .sidebar{
      width:240px;
      background:var(--sidebar-bg);
      display:flex;
      flex-direction:column;
      border-right:1px solid var(--line);
      padding:24px 16px;
      color:var(--sidebar-text);
      position:relative;
    }
    .sidebar::before{
      content:"";
      position:absolute;
      inset:0;
      background:transparent;
      pointer-events:none;
      transition:background .3s ease;
    }
    body.theme-mountain .sidebar,
    body.theme-mountain-dark .sidebar{
      background:var(--bg) url('hero-mountain.jpg') center/cover no-repeat;
    }
    body.theme-mountain .sidebar::before,
    body.theme-mountain-dark .sidebar::before{
      background:rgba(0,0,0,0.45);
    }
    body.theme-mountain .sidebar > *,
    body.theme-mountain-dark .sidebar > *{
      position:relative;
      z-index:1;
    }
    .logo{
      font-family:var(--font-serif);
      font-size:1.6rem;
      font-weight:300;
      text-align:center;
      margin-bottom:36px;
    }
    nav{display:flex;flex-direction:column;gap:14px;}
    nav a{
      text-decoration:none;
      color:var(--sidebar-text);
      font-size:0.95rem;
      padding:10px 14px;
      border-radius:var(--radius);
      transition:background .3s;
    }
    nav a.active,nav a:hover{background:rgba(0,0,0,0.04);}
    body.theme-dark nav a.active,
    body.theme-dark nav a:hover{background:rgba(255,255,255,0.12);}
    body.theme-mountain nav a.active,
    body.theme-mountain nav a:hover,
    body.theme-mountain-dark nav a.active,
    body.theme-mountain-dark nav a:hover{background:rgba(255,255,255,0.18);}
    body.theme-mountain nav a,
    body.theme-mountain-dark nav a{color:#fff;}
    .sidebar-link{
      margin-top:1.5rem;
      width:100%;
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:0.6rem 1rem;
      background:transparent;
      font-size:0.9rem;
      font-family:var(--font-serif);
      font-weight:300;
      color:var(--sidebar-text);
      cursor:pointer;
      transition:background .2s,color .2s;
    }
    .sidebar-link:hover,
    .sidebar-link:focus{
      background:rgba(0,0,0,0.05);
      color:var(--accent);
      outline:none;
    }
    body.theme-dark .sidebar-link:hover,
    body.theme-dark .sidebar-link:focus,
    body.theme-mountain .sidebar-link:hover,
    body.theme-mountain .sidebar-link:focus,
    body.theme-mountain-dark .sidebar-link:hover,
    body.theme-mountain-dark .sidebar-link:focus{
      color:#fff;
    }
    body.theme-mountain .sidebar-link,
    body.theme-mountain-dark .sidebar-link{color:#fff;}
    .sidebar-bottom{
      margin-top:auto;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .sidebar-footer{
      font-size:0.7rem;
      color:var(--muted);
      text-align:center;
    }
    .sidebar-toggle {
      display: none;
      align-items: center;
      justify-content: center;
      width: 42px;
      height: 42px;
      border-radius: 12px;
      border: none;
      background: transparent;
      padding: 0;
      cursor: pointer;
      position: relative;
      z-index: 2100;
    }
    .sidebar-toggle-icon {
      width: 28px;
      height: 28px;
      display: block;
    }
    .sidebar-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.35);
      z-index: 1900;
    }
    /* uniform style for step bubbles across all create-case pages */
.steps {
  display: flex;
  justify-content: space-between;
  align-items: center;
  max-width: 700px;
  margin: 0 auto 2.5rem;
  position: relative;
}

.steps::before {
  content: "";
  position: absolute;
  top: 14px;
  left: 0;
  right: 0;
  height: 3px;
  background: var(--line);
}

.step {
  text-align: center;
  flex: 1;
  position: relative;
}

.circle {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  border: 2px solid var(--line);
  background: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 8px;
  font-size: 0.8rem;
  color: var(--muted);
  transition: all 0.3s ease;
}

.step.active .circle {
  background: var(--accent);
  border-color: var(--accent);
  color: #fff;
}

.step span {
  font-size: 0.85rem;
  color: var(--muted);
}

    /* Main */
    .main{flex:1;padding:40px;overflow-y:auto;overflow-x:hidden;scrollbar-gutter:stable;}
    .topbar{display:flex;justify-content:flex-end;align-items:flex-start;margin-bottom:0.2rem;gap:1.5rem;position:relative;min-height:0;}
    #createCaseTopbar{display:flex;align-items:center;justify-content:flex-end;gap:12px;}
    .user-profile{display:flex;align-items:center;gap:12px;padding:8px 12px;border-radius:999px;background:rgba(255,255,255,0.6);border:1px solid rgba(255,255,255,0.4);backdrop-filter:blur(14px);-webkit-backdrop-filter:blur(14px);transition:border-color 0.2s ease,box-shadow .2s ease;cursor:pointer;position:relative;}
    .user-profile img{width:44px;height:44px;border-radius:50%;border:2px solid #fff;box-shadow:0 4px 16px rgba(0,0,0,0.08);object-fit:cover;}
    .user-profile strong{display:block;font-weight:300;color:var(--ink);}
    .user-profile span{font-size:0.85rem;color:var(--muted);}
    .profile-dropdown{position:absolute;right:0;top:calc(100% + 10px);background:var(--panel,#fff);border:1px solid var(--line,rgba(0,0,0,0.08));border-radius:16px;box-shadow:0 18px 30px rgba(0,0,0,0.12);display:none;flex-direction:column;min-width:200px;z-index:45;pointer-events:auto;overflow:visible;color:var(--ink,#1a1a1a);}
    .profile-dropdown.show{display:flex;pointer-events:auto;overflow:visible;}
    .profile-dropdown button,
    .profile-dropdown a{background:none;border:none;padding:.85rem 1.1rem;text-align:left;font-size:.92rem;cursor:pointer;color:inherit;text-decoration:none;display:block;font-weight:200;border-radius:12px;margin:4px 6px;width:calc(100% - 12px);}
    .profile-dropdown button:hover,
    .profile-dropdown a:hover{background:rgba(0,0,0,0.04);}
    .profile-dropdown .logout-btn{color:#8f7240;background:rgba(182,164,122,0.14);border:1px solid rgba(182,164,122,0.35);}
    .profile-dropdown .logout-btn:hover{background:rgba(182,164,122,0.22);color:#6f552b;}
    body.theme-dark .user-profile{background:rgba(15,23,42,0.4);border-color:rgba(255,255,255,0.15);box-shadow:0 10px 25px rgba(0,0,0,0.35);}
    body.theme-dark .user-profile strong{color:#fff;}
    body.theme-dark .user-profile span{color:rgba(255,255,255,0.8);}
    body.theme-dark .profile-dropdown button:hover,
    body.theme-dark .profile-dropdown a:hover,
    body.theme-mountain-dark .profile-dropdown button:hover,
    body.theme-mountain-dark .profile-dropdown a:hover{background:rgba(255,255,255,0.06);}
    body.theme-mountain .user-profile{background:rgba(255,255,255,0.65);border-color:rgba(255,255,255,0.42);box-shadow:0 18px 34px rgba(17,22,26,0.2);}
    body.theme-mountain .user-profile strong{color:#fff;}
    body.theme-mountain .user-profile span{color:rgba(255,255,255,0.85);}
    body.theme-mountain #createCaseTopbar .user-profile strong{color:#1a1a1a;}
    body.theme-mountain #createCaseTopbar .user-profile span{color:#6b6b6b;}

    header h1{
      font-family:var(--font-serif);
      font-weight:300;
      font-size:2rem;
      margin:0 0 0.75rem;
    }
    header p{font-weight:200;color:var(--muted);margin-bottom:2rem;}

    /* Wizard steps */
    .steps{
      display:flex;
      justify-content:space-between;
      align-items:center;
      max-width:700px;
      margin:0 auto 2.5rem;
      position:relative;
    }
    .step{
      text-align:center;
      flex:1;
      position:relative;
    }
    .circle{
      position:relative;
      z-index:1;
      width:28px;
      height:28px;
      border-radius:50%;
      background:#fff;
      border:2px solid var(--line);
      margin:0 auto 8px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:0.8rem;
    }
    .active .circle{
      background:var(--accent);
      border-color:var(--accent);
      color:#fff;
    }
    .step span{font-size:0.85rem;color:var(--muted);}

    /* Form */
    .input-error{
      border-color:#c0392b !important;
      background:rgba(192,57,43,0.05);
    }
    button.input-error{
      border-color:#c0392b !important;
      box-shadow:0 0 0 1px rgba(192,57,43,0.2);
    }
    .field-error{
      color:#b91c1c;
      font-size:0.8rem;
      margin-top:6px;
    }

    form{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:2rem;
      max-width:800px;
      margin:0 auto;
      box-shadow:0 2px 6px rgba(0,0,0,0.03);
    }
    .field{margin-bottom:1.25rem;}
    .field label{
      display:block;
      margin-bottom:6px;
      font-size:0.9rem;
      color:var(--ink);
    }
    button{
      font-family:var(--font-serif);
      font-weight:300;
    }
    input,select,textarea{
      width:100%;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:6px;
      font-family:inherit;
      font-weight:200;
      font-size:0.9rem;
      transition:border-color .2s,box-shadow .2s;
    }
    textarea{resize:vertical;}
    input:focus,select:focus,textarea:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 3px rgba(182,164,122,0.15);
      outline:none;
    }
    body.theme-dark input,
    body.theme-dark select,
    body.theme-dark textarea{
      background:rgba(15,23,42,0.55);
      color:var(--ink);
      border-color:var(--line);
    }
    body.theme-dark input::placeholder,
    body.theme-dark textarea::placeholder{
      color:var(--muted);
    }
    .task-input-row{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .task-input-row input{flex:1;}
    .task-list{
      list-style:none;
      padding-left:0;
      margin:10px 0 0;
      display:grid;
      gap:8px;
    }
    .task-list li{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:6px;
      background:#fff;
      font-size:0.9rem;
    }
    body.theme-dark .task-list li{
      background:rgba(15,23,42,0.6);
      color:var(--ink);
      border-color:var(--line);
    }
    .task-list .task-empty{
      border:none;
      background:transparent;
      color:var(--muted);
      padding:0;
      justify-content:flex-start;
    }
    .task-remove{
      border:none;
      background:transparent;
      color:var(--muted);
      cursor:pointer;
      font-size:0.85rem;
    }
    .task-remove:hover{color:var(--accent);}
    .task-helper{
      font-size:0.85rem;
      color:var(--muted);
      margin-top:6px;
    }

    .btn{
      border:none;
      border-radius:6px;
      padding:0.6rem 1.1rem;
      font-size:0.9rem;
      font-family:var(--font-serif);
      font-weight:300;
      cursor:pointer;
      transition:all .2s;
    }
    .btn.secondary{background:#fff;border:1px solid var(--line);color:var(--ink);}
    .btn.secondary:hover{border-color:var(--accent);color:var(--accent);}
    .btn.primary{background:var(--accent);color:#fff;}
    .btn.primary:hover{background:#a0854d;}
    body.theme-dark .btn.secondary{
      background:transparent;
      border-color:var(--line);
      color:var(--ink);
    }
    body.theme-dark .btn.secondary:hover{
      border-color:var(--accent);
      color:var(--accent);
    }
.comp-wrapper {
  display: flex;
  align-items: center;
  gap: 8px;
  position: relative;
}

.lock-note{font-size:0.9rem;margin-top:6px;color:var(--muted);}

.dollar-sign {
  position: absolute;
  left: 12px;
  color: var(--muted);
  font-size: 0.9rem;
}

#comp {
  padding-left: 24px;
  width: 120px;
  border: 1px solid var(--line);
  border-radius: 6px;
  padding: 0.5rem 0.6rem 0.5rem 1.4rem;
  font-family: inherit;
  font-size: 0.9rem;
}
body.theme-dark #comp{
  background:rgba(15,23,42,0.55);
  color:var(--ink);
  border-color:var(--line);
}

#comp:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(182,164,122,0.15);
  outline: none;
}

#comp:disabled {
  background: #f4f1e8;
  color: #7a6f5a;
  border-color: #e0d7c4;
  cursor: not-allowed;
}

.comp-wrapper.is-locked .dollar-sign {
  color: #b1a58a;
}

.comp-type {
  display: flex;
  gap: 6px;
}

.type-btn {
  background: #fff;
  border: 1px solid var(--line);
  border-radius: 6px;
  padding: 0.4rem 0.8rem;
  font-size: 0.85rem;
  cursor: pointer;
  transition: all 0.2s;
}
body.theme-dark .type-btn{
  background:rgba(15,23,42,0.55);
  color:var(--ink);
  border-color:var(--line);
}

.type-btn.active {
  background: var(--accent);
  color: #fff;
  border-color: var(--accent);
}

.type-btn:hover:not(.active) {
  border-color: var(--accent);
  color: var(--accent);
}
.select-field .select-wrapper {
  position: relative;
}
.select-field select {
  width: 100%;
  border: 1px solid var(--line);
  border-radius: 10px;
  padding: 0.65rem 2.6rem 0.65rem 0.85rem;
  font-size: 0.95rem;
  font-family: inherit;
  background: #fff;
  appearance: none;
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
}
body.theme-dark .select-field select{
  background:rgba(15,23,42,0.55);
  color:var(--ink);
  border-color:var(--line);
}
.select-field select:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(182,164,122,0.18);
  outline: none;
}
.select-field .select-arrow {
  position: absolute;
  right: 14px;
  top: 50%;
  transform: translateY(-50%);
  pointer-events: none;
  color: var(--muted);
  font-size: 0.8rem;
}
.select-field .select-wrapper {
  position: relative;
}
.select-field select {
  width: 100%;
  border: 1px solid var(--line);
  border-radius: 10px;
  padding: 0.65rem 2.8rem 0.65rem 0.9rem;
  font-size: 0.95rem;
  font-family: inherit;
  background: #fff;
  appearance: none;
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
}
body.theme-dark .select-field select{
  background:rgba(15,23,42,0.55);
  color:var(--ink);
  border-color:var(--line);
}
.select-field select:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(182,164,122,0.18);
  outline: none;
}
.select-field .select-arrow {
  position: absolute;
  right: 14px;
  top: 50%;
  transform: translateY(-50%);
  pointer-events: none;
  color: var(--muted);
  font-size: 0.8rem;
}
.steps a {
  text-decoration: none;
  color: inherit;
  display: flex;
  flex-direction: column;
  align-items: center;
  flex: 1;
}

.steps a:hover .circle {
  background: var(--accent);
  color: #fff;
  border-color: var(--accent);
}

.steps a:hover span {
  color: var(--accent);
}

    .step-panel[hidden] {
      display: none !important;
    }

    .step-panel form{
      max-width:1000px;
      margin:0 auto;
      width:100%;
    }

    .form-wrapper{
      max-width:1000px;
      margin:0 auto;
      display:flex;
      flex-direction:column;
      gap:1.5rem;
    }

    #create-step-description .form-wrapper form{
      width:100%;
    }

    #create-step-description .form-wrapper .tips{
      width:100%;
    }

    .tips{
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:1.5rem;
      background:var(--panel);
      font-size:0.9rem;
      color:var(--muted);
    }
    .tips h3{
      font-family:var(--font-serif);
      font-size:1.15rem;
      font-weight:300;
      margin-bottom:0.75rem;
      color:var(--ink);
    }
    .tips ul{
      margin:0 0 0.75rem 1.1rem;
      padding:0;
      display:flex;
      flex-direction:column;
      gap:0.35rem;
    }

    .compliance-note{
      border:1px solid rgba(180,151,90,0.25);
      border-radius:var(--radius);
      padding:1.35rem;
      background:#f7f4ec;
      display:grid;
      gap:0.85rem;
    }

    .compliance-note h3{
      margin:0;
      font-family:var(--font-serif);
      font-size:1.1rem;
      font-weight:300;
      color:var(--ink);
    }

    .compliance-note ul{
      margin:0 0 0 1.1rem;
      padding:0;
      display:flex;
      flex-direction:column;
      gap:0.4rem;
      font-size:0.92rem;
      line-height:1.5;
      color:#5f5542;
    }
    .fee-info{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:18px;
      height:18px;
      margin-left:6px;
      border-radius:50%;
      border:1px solid rgba(26,34,48,0.25);
      color:rgba(26,34,48,0.7);
      font-size:0.75rem;
      font-weight:600;
      position:relative;
      cursor:default;
      transition:border-color 0.2s ease,color 0.2s ease,transform 0.2s ease;
    }
    .fee-info::after{
      content:attr(data-tooltip);
      position:absolute;
      left:50%;
      bottom:calc(100% + 10px);
      transform:translateX(-50%) translateY(4px);
      width:min(300px, 80vw);
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(26,34,48,0.12);
      background:#ffffff;
      color:#1a2230;
      font-size:0.78rem;
      line-height:1.4;
      box-shadow:0 16px 32px rgba(15,23,42,0.18);
      opacity:0;
      pointer-events:none;
      z-index:5;
      transition:opacity 0.2s ease,transform 0.2s ease;
    }
    .fee-info:hover,
    .fee-info:focus-visible{
      border-color:rgba(182,164,122,0.8);
      color:#1a2230;
      transform:translateY(-1px);
    }
    .fee-info:hover::after,
    .fee-info:focus-visible::after{
      opacity:1;
      transform:translateX(-50%) translateY(0);
    }

    .compliance-ack{
      display:flex;
      gap:0.65rem;
      align-items:flex-start;
      font-size:0.92rem;
      color:var(--ink);
    }

    .compliance-ack input{
      margin-top:2px;
    }

    .case-title-preview{
      display:flex;
      flex-direction:column;
      gap:0.35rem;
      margin-bottom:1rem;
      text-align:center;
      align-items:center;
    }
    .case-title-preview .label{
      text-transform:uppercase;
      letter-spacing:0.18em;
      font-size:0.7rem;
      color:var(--muted);
      font-weight:300;
      font-family:var(--font-sans);
    }
    .case-title-preview .value{
      font-family:var(--font-serif);
      font-size:1.6rem;
      font-weight:300;
      color:var(--ink);
    }

    .char-count{
      text-align:right;
      font-size:0.8rem;
      color:var(--muted);
      margin-top:6px;
    }

    .summary{
      max-width:1000px;
      margin:0 auto;
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:2.6rem 3rem;
      box-shadow:0 2px 6px rgba(0,0,0,0.03);
      display:flex;
      flex-direction:column;
      gap:1.1rem;
      line-height:1.6;
    }
    .summary h2{
      font-family:'Cormorant Garamond',serif;
      font-weight:300;
      font-size:1.5rem;
      margin-bottom:1.25rem;
    }
    .summary p{margin:0;color:var(--ink);}
    .summary small{color:var(--muted);}

    .auto-note{margin-top:1rem;font-size:0.9rem;color:var(--muted);}
    .actions{display:flex;justify-content:flex-end;gap:10px;margin-top:2rem;}
    .step-panel .actions{
      max-width:1000px;
      margin:2rem auto 0;
      width:100%;
      padding:0 2rem;
      justify-content:flex-end;
    }
    .btn{border:none;border-radius:6px;padding:0.6rem 1.1rem;font-size:0.9rem;font-family:var(--font-serif);font-weight:300;cursor:pointer;transition:all .2s;}
    .btn.secondary{background:#fff;border:1px solid var(--line);color:var(--ink);}
    .btn.secondary:hover{border-color:var(--accent);color:var(--accent);}
    .btn.primary{background:var(--accent);color:#fff;}
    .btn.primary:hover{background:#a0854d;}

    .modal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.35);
      backdrop-filter:blur(6px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:80;
    }
    .modal.active{display:flex;}
    .modal-content{
      background:#fff;
      width:min(700px,90vw);
      border-radius:18px;
      padding:2.5rem 2.75rem;
      box-shadow:0 15px 50px rgba(0,0,0,0.15);
      border:1px solid #e9e6df;
      font-family:'Sarabun',sans-serif;
      color:var(--ink);
      line-height:1.6;
    }
    body.theme-dark .modal-content,
    body.theme-mountain-dark .modal-content{
      background:var(--panel);
      border-color:rgba(255,255,255,0.08);
      box-shadow:0 18px 50px rgba(0,0,0,0.35);
      color:var(--ink);
    }
    .modal-content h3{
      font-family:'Cormorant Garamond',serif;
      font-weight:300;
      font-size:1.9rem;
      color:#1a1a1a;
      margin-bottom:2rem;
      text-align:center;
      letter-spacing:0.3px;
    }
    body.theme-dark .modal-content h3,
    body.theme-mountain-dark .modal-content h3{
      color:#f8fbff;
    }
    .modal-content hr{
      border:none;
      border-top:1px solid #e0ded8;
      margin:1.5rem 0;
    }
    body.theme-dark .modal-content hr,
    body.theme-mountain-dark .modal-content hr{
      border-top-color:rgba(255,255,255,0.12);
    }
    .modal-content p{
      margin:0.35rem 0;
      color:#2a2a2a;
      font-size:0.95rem;
      display:flex;
      align-items:baseline;
      gap:6px;
    }
    body.theme-dark .modal-content p,
    body.theme-mountain-dark .modal-content p{
      color:#e6ecf8;
    }
    .modal-content strong{
      font-family:'Cormorant Garamond',serif;
      font-weight:300;
      font-size:1rem;
      color:#111;
      min-width:130px;
      display:inline-block;
    }
    body.theme-dark .modal-content strong,
    body.theme-mountain-dark .modal-content strong{
      color:#f8fbff;
    }
    .close-btn{
      display:block;
      margin:2rem auto 0;
      background:#faf9f6;
      border:1px solid #d8d3c9;
      padding:0.55rem 1.2rem;
      border-radius:8px;
      font-size:0.9rem;
      cursor:pointer;
      color:#333;
      transition:all 0.2s ease;
      font-family:'Cormorant Garamond',serif;
    }
    body.theme-dark .close-btn,
    body.theme-mountain-dark .close-btn{
      background:rgba(255,255,255,0.08);
      border-color:rgba(255,255,255,0.2);
      color:#f8fbff;
    }
    .close-btn:hover{
      background:var(--accent);
      border-color:var(--accent);
      color:#fff;
    }
    body.modal-open{overflow:hidden;}
    .toast.inline-toast{
      position:fixed;
      bottom:-120px;
      right:32px;
      max-width:320px;
      background:rgba(182,164,122,0.95);
      color:#fff;
      padding:0.85rem 1.1rem;
      border-radius:10px;
      font-size:0.9rem;
      box-shadow:0 4px 18px rgba(0,0,0,0.18);
      gap:0.65rem;
      display:flex;
      align-items:center;
      transition:bottom .35s ease;
      z-index:85;
    }
    .toast.inline-toast.show{bottom:34px;}
    .toast.inline-toast.error{background:#c0392b;}
    .toast.inline-toast a{color:#fff;text-decoration:underline;margin-left:10px;}

    @media (max-width: 1024px) {
      body {
        flex-direction: column;
        height: auto;
        overflow: auto;
      }
      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 260px;
        height: 100vh;
        border-right: none;
        border-bottom: none;
        flex-direction: column;
        flex-wrap: nowrap;
        gap: 24px;
        padding: 24px 18px;
        padding-top: 72px;
        transform: translateX(-110%);
        transition: transform 0.25s ease;
        z-index: 2000;
        box-shadow: 18px 0 40px rgba(0, 0, 0, 0.18);
      }
      body.nav-open .sidebar {
        transform: translateX(0);
      }
      body.nav-open .sidebar-backdrop {
        display: block;
      }
      .sidebar-toggle {
        display: inline-flex;
        position: fixed;
        top: 14px;
        left: 14px;
      }
      .topbar {
        margin-bottom: 1.25rem;
        min-height: 56px;
        justify-content: flex-end;
        gap: 12px;
      }
      .logo {
        margin-bottom: 4px;
        text-align: left;
        font-size: 1.4rem;
      }
      nav {
        flex-direction: column;
        gap: 12px;
      }
      nav a {
        width: 100%;
        text-align: left;
        padding: 10px 14px;
        font-size: 0.95rem;
      }
      .sidebar-bottom {
        margin-top: auto;
        align-items: stretch;
        gap: 12px;
      }
      .sidebar-link {
        width: 100%;
        text-align: left;
        padding: 10px 14px;
        font-size: 0.95rem;
      }
      .sidebar-footer {
        text-align: left;
      }
      .main {
        padding: 28px 20px 60px;
        overflow: visible;
      }
      .user-profile {
        padding: 6px 10px;
      }
      .user-profile img {
        width: 38px;
        height: 38px;
      }
      header h1 {
        font-size: 1.7rem;
      }
      header p {
        margin-bottom: 1.5rem;
      }
      .steps {
        max-width: 100%;
        margin: 0 0 1.5rem;
      }
      .steps::before {
        left: 8px;
        right: 8px;
      }
      .circle {
        width: 24px;
        height: 24px;
        font-size: 0.75rem;
      }
      .step span {
        font-size: 0.75rem;
      }
      form {
        padding: 1.5rem;
        width: 100%;
      }
      .step-panel .actions,
      .actions {
        flex-direction: column;
        align-items: stretch;
        padding: 0;
      }
      .actions .btn {
        width: 100%;
      }
      .summary {
        padding: 1.6rem 1.4rem;
      }
      .tips {
        padding: 1.1rem;
      }
      .task-input-row {
        flex-direction: column;
        align-items: stretch;
      }
      .task-input-row button {
        width: 100%;
      }
      .comp-wrapper {
        flex-direction: column;
        align-items: stretch;
      }
      #comp {
        width: 100%;
      }
      .comp-type {
        flex-wrap: wrap;
      }
      .modal-content {
        padding: 1.8rem 1.6rem;
      }
      .modal-content h3 {
        font-size: 1.6rem;
      }
      .modal-content strong {
        min-width: 110px;
      }
      .toast.inline-toast {
        right: 16px;
        left: 16px;
        max-width: none;
      }
    }

    @media (max-width: 640px) {
      .main {
        padding: 20px 14px 48px;
      }
      .steps {
        gap: 0.4rem;
      }
      .steps::before {
        top: 12px;
      }
      .step span {
        font-size: 0.7rem;
      }
    }

  </style>
</head>
  <body>
  <script>
    (function applyStoredTheme() {
      try {
        const raw = localStorage.getItem("lpc_user");
        if (!raw) return;
        const stored = JSON.parse(raw);
        const theme = String(stored?.preferences?.theme || "").toLowerCase();
        const allowed = new Set(["light", "dark", "mountain", "mountain-dark"]);
        if (allowed.has(theme)) {
          const classes = theme === "mountain-dark" ? ["theme-mountain-dark", "theme-dark"] : [`theme-${theme}`];
          classes.forEach((cls) => document.body.classList.add(cls));
        }
        const fontKey = String(stored?.preferences?.fontSize || "").toLowerCase();
        const sizeMap = { xs: "14px", sm: "15px", md: "16px", lg: "17px", xl: "20px" };
        if (sizeMap[fontKey]) {
          document.documentElement.style.fontSize = sizeMap[fontKey];
        }
      } catch {
        /* ignore */
      }
    })();
  </script>
  <a class="skip-link" href="#main">Skip to main content</a>
  <button class="sidebar-toggle" id="sidebarToggle" type="button" aria-label="Open menu" aria-controls="sidebarNav" aria-expanded="false">
    <img class="sidebar-toggle-icon" src="sidebar-4.png" alt="" aria-hidden="true" />
  </button>
  <!-- Sidebar -->
  <aside class="sidebar" id="sidebarNav">
    <div class="logo">Dashboard</div>
    <nav>
      <a href="dashboard-attorney.html">Home</a>
      <a href="dashboard-attorney.html#cases">Cases &amp; Files</a>
      <a href="dashboard-attorney.html#billing">Payments</a>
      <a href="help.html">Help</a>
    </nav>
    <div class="sidebar-bottom">
      <button type="button" class="sidebar-link" id="logoutBtn">Log Out</button>
      <div class="sidebar-footer"><a href="index.html" style="color:inherit;text-decoration:none;">© Let’s-ParaConnect 2025</a></div>
    </div>
  </aside>
  <div class="sidebar-backdrop" id="sidebarBackdrop" aria-hidden="true"></div>

  <!-- Main -->
  <main id="main" tabindex="-1" class="main">
    <div class="topbar" id="createCaseTopbar">
      <div class="notification-wrapper" data-notification-center>
        <button class="notification-icon" id="createCaseNotifBtn" type="button" aria-label="View notifications" data-notification-toggle>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 8a6 6 0 10-12 0c0 7-3 9-3 9h18s-3-2-3-9" />
            <path d="M13.73 21a2 2 0 01-3.46 0" />
          </svg>
          <span class="notification-badge" id="createCaseNotifBadge" data-notification-badge>0</span>
        </button>
        <div class="notifications-panel hidden" role="region" aria-live="polite" data-notification-panel>
          <div class="notif-header">
            <span class="notif-header-title" aria-label="Notifications"></span>
            <button type="button" class="notif-markall" data-notification-mark>Mark All Read</button>
          </div>
          <div class="notif-scroll" data-notification-list></div>
          <div class="notif-empty" data-notification-empty>Loading...</div>
        </div>
      </div>
      <div class="user-profile" id="createCaseUserChip" role="button" tabindex="0" aria-haspopup="true" aria-expanded="false" aria-controls="createCaseProfileMenu" aria-label="Open profile menu">
        <img id="createCaseAvatar" src="assets/images/default-avatar.png" alt="Attorney avatar" />
        <div>
          <strong id="createCaseName">Attorney</strong>
          <span id="createCaseRole">Attorney</span>
        </div>
        <div class="profile-dropdown" id="createCaseProfileMenu" aria-hidden="true">
          <a href="profile-settings.html" data-account-settings>Account Settings</a>
          <button type="button" class="logout-btn" data-logout>Log Out</button>
        </div>
      </div>
    </div>

    <section class="step-panel" data-step="details" id="create-step-details">
      <header>
        <h1>Create a New Case</h1>
        <p>Provide details to post your case and invite paralegals to apply.</p>
      </header>

      <div class="steps">
        <a href="#details" class="step active" data-step-link="details">
          <div class="circle">1</div><span>Case details</span>
        </a>
        <a href="#description" class="step" data-step-link="description">
          <div class="circle">2</div><span>Description</span>
        </a>
        <a href="#review" class="step" data-step-link="review">
          <div class="circle">3</div><span>Review &amp; Post</span>
        </a>
      </div>

      <form>
        <div class="field">
          <label for="caseTitleInput">Case Title</label>
          <input id="caseTitleInput" type="text" placeholder="e.g., Draft asset purchase agreement" />
        </div>
      <div class="field">
        <label for="specialty">Field of Law</label>
        <select id="specialty">
              <option value="">Select…</option>
    <option>Administrative Law</option>
    <option>Admiralty & Maritime Law</option>
    <option>Antitrust Law</option>
    <option>Appellate Law</option>
    <option>Banking Law</option>
    <option>Bankruptcy Law</option>
    <option>Business / Corporate Law</option>
    <option>Civil Rights Law</option>
    <option>Class Action Law</option>
    <option>Commercial Law</option>
    <option>Communications Law</option>
    <option>Construction Law</option>
    <option>Consumer Protection Law</option>
    <option>Contract Law</option>
    <option>Criminal Defense Law</option>
    <option>Education Law</option>
    <option>Elder Law</option>
    <option>Election Law</option>
    <option>Employment & Labor Law</option>
    <option>Energy Law</option>
    <option>Entertainment Law</option>
    <option>Environmental Law</option>
    <option>Estate Planning & Probate</option>
    <option>Family Law</option>
    <option>Franchise Law</option>
    <option>Government Contracts Law</option>
    <option>Health Care Law</option>
    <option>Immigration Law</option>
    <option>Insurance Law</option>
    <option>Intellectual Property (IP) Law</option>
    <option>International Law</option>
    <option>Land Use & Zoning Law</option>
    <option>Litigation</option>
    <option>Media Law</option>
    <option>Medical Malpractice</option>
    <option>Military Law</option>
    <option>Municipal Law</option>
    <option>Personal Injury Law</option>
    <option>Product Liability Law</option>
    <option>Real Estate Law</option>
    <option>Securities Law</option>
    <option>Social Security / Disability Law</option>
    <option>Sports Law</option>
    <option>Tax Law</option>
    <option>Technology Law</option>
    <option>Telecommunications Law</option>
    <option>Torts</option>
    <option>Transportation Law</option>
    <option>Trusts &amp; Estates</option>
    <option>Estate Planning</option>
    <option>White Collar Crime</option>
    <option>Workers’ Compensation</option>
  </select>
</div>

      <div class="field">
  <label for="state">Location (State)</label>
  <select id="state">
    <option value="">Select…</option>
    <option>Alabama</option>
    <option>Alaska</option>
    <option>Arizona</option>
    <option>Arkansas</option>
    <option>California</option>
    <option>Colorado</option>
    <option>Connecticut</option>
    <option>Delaware</option>
    <option>District of Columbia</option>
    <option>Florida</option>
    <option>Georgia</option>
    <option>Hawaii</option>
    <option>Idaho</option>
    <option>Illinois</option>
    <option>Indiana</option>
    <option>Iowa</option>
    <option>Kansas</option>
    <option>Kentucky</option>
    <option>Louisiana</option>
    <option>Maine</option>
    <option>Maryland</option>
    <option>Massachusetts</option>
    <option>Michigan</option>
    <option>Minnesota</option>
    <option>Mississippi</option>
    <option>Missouri</option>
    <option>Montana</option>
    <option>Nebraska</option>
    <option>Nevada</option>
    <option>New Hampshire</option>
    <option>New Jersey</option>
    <option>New Mexico</option>
    <option>New York</option>
    <option>North Carolina</option>
    <option>North Dakota</option>
    <option>Ohio</option>
    <option>Oklahoma</option>
    <option>Oregon</option>
    <option>Pennsylvania</option>
    <option>Rhode Island</option>
    <option>South Carolina</option>
    <option>South Dakota</option>
    <option>Tennessee</option>
    <option>Texas</option>
    <option>Utah</option>
    <option>Vermont</option>
    <option>Virginia</option>
    <option>Washington</option>
    <option>West Virginia</option>
    <option>Wisconsin</option>
    <option>Wyoming</option>
  </select>
</div>

  <div class="field">
  <label for="comp">Compensation</label>
  <div class="comp-wrapper">
    <span class="dollar-sign">$</span>
    <input id="comp" type="number" min="0" placeholder="Amount" />
  </div>
  <p class="muted lock-note" id="compLockNotice">You may edit the case amount until the first invitation is sent or a paralegal applies. After that point, the amount is automatically locked.</p>
</div>

      <div class="field select-field">
        <label for="experience">Preferred Experience (Optional)</label>
        <div class="select-wrapper">
          <select id="experience">
            <option value="">No preference</option>
            <option value="1–3 years (Early Career)">1–3 years (Early Career)</option>
            <option value="3–7 years (Intermediate)">3–7 years (Intermediate)</option>
            <option value="7–12 years (Experienced)">7–12 years (Experienced)</option>
            <option value="12+ years (Advanced)">12+ years (Advanced)</option>
          </select>
          <span class="select-arrow">▾</span>
        </div>
      </div>

      </form>

      <div class="actions">
        <button type="button" class="btn secondary" data-nav="cancel" data-target="dashboard-attorney.html#cases">Cancel</button>
        <button type="button" class="btn primary" data-step-switch="description" id="detailsNextBtn">Next Step</button>
      </div>
    </section>

    <section class="step-panel" data-step="description" id="create-step-description" hidden>
      <header>
        <h1>Create a New Case</h1>
        <p>Step 2: Add a detailed description for your case posting.</p>
      </header>

      <div class="steps">
        <a href="#details" class="step" data-step-link="details">
          <div class="circle">1</div><span>Case details</span>
        </a>
        <a href="#description" class="step active" data-step-link="description">
          <div class="circle">2</div><span>Description</span>
        </a>
        <a href="#review" class="step" data-step-link="review">
          <div class="circle">3</div><span>Review &amp; Post</span>
        </a>
      </div>

      <div class="form-wrapper">
        <form>
          <div class="case-title-preview" id="caseTitlePreview">
            <span class="label">Matter Title</span>
            <span class="value" id="caseTitlePreviewText">Untitled Case</span>
          </div>
          <div class="field">
            <label for="caseDescription">Matter Description</label>
            <textarea id="caseDescription" placeholder="Describe your matter, goals, and expectations for the paralegal..." maxlength="4000"></textarea>
            <div class="char-count" id="descriptionCharCount">0 / 4000</div>
          </div>
          <div class="field" id="caseTasksField">
            <label for="caseTaskInput">Tasks</label>
            <div class="task-input-row">
              <input id="caseTaskInput" type="text" placeholder="e.g., Draft initial motion" />
              <button type="button" class="btn secondary" id="addCaseTaskBtn">Add</button>
            </div>
            <p class="task-helper" id="caseTaskHelper">Add at least one task. Tasks describe the overall scope of deliverables required to satisfy the matter.</p>
            <ul class="task-list" id="caseTaskList"></ul>
          </div>
          <div class="field">
            <label for="caseDeadline">Deadline</label>
            <input id="caseDeadline" type="date" placeholder="YYYY-MM-DD" />
          </div>
        </form>

        <div class="tips">
          <h3>Tips for a Great Description</h3>
          <ul>
            <li>Be clear, well-written, and detailed about your case needs.</li>
            <li>Include the scope of work, deliverables, and deadlines.</li>
            <li>Avoid sensitive or identifying details in the posting.</li>
          </ul>
        </div>

        <div class="actions">
          <button type="button" class="btn secondary" data-step-switch="details">Back</button>
          <button type="button" class="btn secondary" data-nav="cancel" data-target="dashboard-attorney.html#cases:draft" data-save-draft="true">Save and Exit</button>
          <button type="button" class="btn primary" data-step-switch="review">Next Step</button>
        </div>
      </div>
    </section>
    <section class="step-panel" data-step="review" id="create-step-review" hidden>
      <header>
        <h1>Review &amp; Post Your Case</h1>
        <p>Step 3: Confirm details before posting your case publicly.</p>
      </header>

      <div class="steps">
        <a href="#details" class="step" data-step-link="details">
          <div class="circle">1</div><span>Case details</span>
        </a>
        <a href="#description" class="step" data-step-link="description">
          <div class="circle">2</div><span>Description</span>
        </a>
        <a href="#review" class="step active" data-step-link="review">
          <div class="circle">3</div><span>Review &amp; Post</span>
        </a>
      </div>

      <section class="summary" id="reviewSummary">
        <p>Gathering your case details…</p>
      </section>

      <section class="compliance-note" aria-label="Platform disclosures">
        <h3>Platform Disclosures</h3>
        <ul>
          <li>Only attorneys and paralegals may use the platform. Communication here is attorney-to-paralegal only.</li>
          <li>Paralegal work must be supervised by the attorney. The attorney remains responsible for all work product.</li>
          <li>Let&rsquo;s-ParaConnect does not provide legal services or legal advice.</li>
          <li>Payments are processed through Stripe. Funds remain within Stripe&rsquo;s infrastructure and are released upon attorney approval.</li>
        </ul>
      </section>

      <div class="actions">
        <button type="button" class="btn secondary" data-step-switch="description">Back</button>
        <button type="button" class="btn secondary" data-nav="cancel" data-target="dashboard-attorney.html#cases:draft" data-save-draft="true">Save &amp; Exit</button>
        <button type="button" class="btn secondary" id="previewBtn">Preview Listing</button>
        <button type="button" class="btn primary" id="postBtn">Post Case</button>
      </div>
    </section>
  </main>
  <div id="toastBanner" class="toast" role="status" aria-live="polite"></div>
  <div class="modal" id="previewModal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="previewTitle">
      <h3 id="previewTitle"></h3>
      <p><strong>Field of Law:</strong> <span id="previewField">—</span></p>
      <p><strong>Location:</strong> <span id="previewState">—</span></p>
      <p><strong>Compensation:</strong> <span id="previewComp">—</span></p>
      <p><strong>Platform fee (22%):</strong> <span id="previewPlatformFee">—</span><span class="fee-info" tabindex="0" data-tooltip="Platform fee includes Stripe security, dispute support, payment processing, and vetted paralegal access.">?</span></p>
      <p><strong>Estimated total due at hire:</strong> <span id="previewTotalDue">—</span></p>
      <p><strong>Experience:</strong> <span id="previewExperience">—</span></p>
      <p id="previewDeadlineRow" hidden><strong>Deadline:</strong> <span id="previewDeadline">—</span></p>
      <hr>
      <p id="previewDescription"></p>
      <div class="preview-tasks" id="previewTasks"></div>
      <p class="auto-note" id="previewAutoNote"></p>
      <button type="button" class="close-btn" id="closePreview">Close Preview</button>
    </div>
  </div>
  <div class="toast inline-toast" id="toast">
    ✅ Your case has been successfully posted.
    <a href="dashboard-attorney.html#cases">View Posted Case</a>
  </div>
  <script src="assets/scripts/utils/toast.js?v=20260208"></script>
  <script>
    (function initCreateCaseAuthHeader() {
      function userDisplayName(user) {
        const first = String(user?.firstName || "").trim();
        const last = String(user?.lastName || "").trim();
        const full = [first, last].filter(Boolean).join(" ").trim();
        const fallbackName = String(user?.name || user?.email || "Attorney").trim();
        return full || fallbackName || "Attorney";
      }

      function userRoleLabel(user) {
        const role = String(user?.role || "attorney").toLowerCase();
        return role ? role.charAt(0).toUpperCase() + role.slice(1) : "Attorney";
      }

      function userAvatar(user) {
        return (
          user?.profileImage ||
          user?.avatarURL ||
          user?.pendingProfileImage ||
          "assets/images/default-avatar.png"
        );
      }

      function applyUser(user) {
        const nameEl = document.getElementById("createCaseName");
        const roleEl = document.getElementById("createCaseRole");
        const avatarEl = document.getElementById("createCaseAvatar");
        if (nameEl) nameEl.textContent = userDisplayName(user);
        if (roleEl) roleEl.textContent = userRoleLabel(user);
        if (avatarEl) avatarEl.src = userAvatar(user);
      }

      function formatNotifTime(value) {
        if (!value) return "";
        const parsed = new Date(value);
        if (Number.isNaN(parsed.getTime())) return "";
        return parsed.toLocaleDateString(undefined, { month: "short", day: "numeric" });
      }

      const ADMIN_NOTIFICATION_IMAGE = "/hero-mountain.jpg";
      const ADMIN_TITLE_HINT = "welcome to let's-paraconnect";
      const PLATFORM_NOTIFICATION_TYPES = new Set([
        "paralegal_welcome",
        "profile_approved",
        "profile_photo_approved",
        "profile_photo_rejected",
      ]);

      function getAvatarFallback(name = "") {
        const letter = (name || "?").trim().charAt(0).toUpperCase() || "?";
        const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect width="64" height="64" rx="32" fill="#eef1f7"/><text x="50%" y="56%" text-anchor="middle" font-family="Arial, sans-serif" font-size="26" fill="#5c6477">${letter}</text></svg>`;
        return `data:image/svg+xml,${encodeURIComponent(svg)}`;
      }

      function isAdminNotification(item = {}) {
        const actorName = String(item.actorFirstName || "").trim().toLowerCase();
        const payloadRole = String(item.payload?.actorRole || item.payload?.fromRole || "").trim().toLowerCase();
        const fromName = String(item.payload?.fromName || "").trim().toLowerCase();
        const type = String(item.type || "").trim().toLowerCase();
        if (
          actorName === "admin" ||
          payloadRole === "admin" ||
          payloadRole === "platform" ||
          payloadRole === "system" ||
          fromName === "admin"
        ) {
          return true;
        }
        if (PLATFORM_NOTIFICATION_TYPES.has(type)) return true;
        const message = String(item.message || item.payload?.message || "").trim().toLowerCase();
        const title = String(item.payload?.title || "").trim().toLowerCase();
        if (message.includes(ADMIN_TITLE_HINT) || title.includes(ADMIN_TITLE_HINT)) return true;
        return false;
      }

      function getNotificationAvatar(item = {}, actorName = "") {
        if (isAdminNotification(item)) return ADMIN_NOTIFICATION_IMAGE;
        if (item.actorProfileImage) return item.actorProfileImage;
        return getAvatarFallback(actorName);
      }

      function formatNotificationMessage(item = {}) {
        if (item.type === "paralegal_welcome") {
          const title = String(item.payload?.title || "").trim();
          const body = String(item.payload?.body || "").trim();
          if (title && body) {
            return `${title} ${body}`;
          }
          if (item.message) {
            return item.message.replace(/\.\./g, ".");
          }
        }
        if (item.message) return item.message;
        if (item.type === "message" && item.actorFirstName) {
          return `${item.actorFirstName} sent you a message.`;
        }
        return "You have a new notification.";
      }

      function formatRelativeTime(value) {
        if (!value) return "";
        const date = value instanceof Date ? value : new Date(value);
        if (Number.isNaN(date.getTime())) return "";
        const diff = Date.now() - date.getTime();
        const minutes = Math.floor(diff / 60000);
        if (minutes < 1) return "Moments ago";
        if (minutes < 60) return `${minutes}m ago`;
        const hours = Math.floor(minutes / 60);
        if (hours < 24) return `${hours}h ago`;
        const days = Math.floor(hours / 24);
        if (days < 7) return `${days}d ago`;
        return date.toLocaleDateString();
      }

      function resolveNotifLink(item = {}) {
        const payload = item.payload || {};
        const caseId =
          item.caseId || payload.caseId || payload.caseID || payload.case || payload.case_id || payload.caseRef || "";
        const type = String(item.type || "").toLowerCase();
        if (item.link) return item.link;
        if (caseId) {
          const base = `case-detail.html?caseId=${encodeURIComponent(caseId)}`;
          if (type === "message") return `${base}#case-messages`;
          return base;
        }
        return "dashboard-attorney.html";
      }

      function setNotifBadge(count) {
        const badge = document.getElementById("createCaseNotifBadge");
        const toggle = document.querySelector("[data-notification-toggle]");
        const safe = Math.max(0, Number(count) || 0);
        if (badge) {
          badge.textContent = String(safe);
          badge.classList.toggle("show", safe > 0);
        }
        if (toggle) {
          if (safe > 0) toggle.dataset.count = String(safe);
          else delete toggle.dataset.count;
        }
      }

      const CREATE_CASE_NOTIF_ENHANCED_KEY = "createCaseNotifEnhanced";
      const CREATE_CASE_NOTIF_ITEM_KEY = "createCaseNotifItemBound";

      function enhanceCreateCaseNotifScroll(list) {
        if (!list || list.dataset[CREATE_CASE_NOTIF_ENHANCED_KEY] === "true") return;
        list.dataset[CREATE_CASE_NOTIF_ENHANCED_KEY] = "true";
        const observer = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              const item = entry.target;
              if (!(item instanceof HTMLElement)) return;
              if (!entry.isIntersecting) return;
              item.classList.add("notif-fade-in");
              observer.unobserve(item);
            });
          },
          { root: list, threshold: 0.2, rootMargin: "0px 0px -4% 0px" }
        );
        const bindItems = () => {
          const items = list.querySelectorAll(".notif-item, .notif-card");
          items.forEach((item) => {
            if (!(item instanceof HTMLElement)) return;
            if (item.dataset[CREATE_CASE_NOTIF_ITEM_KEY] === "true") return;
            item.dataset[CREATE_CASE_NOTIF_ITEM_KEY] = "true";
            item.classList.add("notif-fade-ready");
            observer.observe(item);
          });
        };
        const itemObserver = new MutationObserver(() => bindItems());
        itemObserver.observe(list, { childList: true, subtree: true });
        bindItems();
      }

      function syncCreateCaseNotifViewport(list) {
        if (!list) return;
        const cards = Array.from(list.querySelectorAll(":scope > .notif-item, :scope > .notif-card"));
        if (!cards.length) {
          list.style.removeProperty("--notif-three-card-max-height");
          return;
        }
        const targetIndex = Math.min(3, cards.length) - 1;
        const targetCard = cards[targetIndex];
        if (!targetCard) return;
        const listStyles = window.getComputedStyle(list);
        const gap = parseFloat(listStyles.rowGap || listStyles.gap || "0") || 0;
        const paddingTop = parseFloat(listStyles.paddingTop || "0") || 0;
        const paddingBottom = parseFloat(listStyles.paddingBottom || "0") || 0;
        let maxHeight = paddingTop + paddingBottom;
        const visibleCards = Math.min(3, cards.length);
        for (let index = 0; index < visibleCards; index += 1) {
          maxHeight += cards[index].offsetHeight;
        }
        if (visibleCards > 1) maxHeight += gap * (visibleCards - 1);
        maxHeight = Math.round(maxHeight);
        if (maxHeight > 0) {
          list.style.setProperty("--notif-three-card-max-height", `${maxHeight}px`);
        }
      }

      let currentNotifications = [];

      async function dismissNotification(id) {
        if (!id) return false;
        try {
          await fetch(`/api/notifications/${encodeURIComponent(id)}`, {
            method: "DELETE",
            credentials: "include",
          });
        } catch (_) {}
        const targetId = String(id);
        currentNotifications = currentNotifications.filter(
          (item) => String(item?._id || item?.id) !== targetId
        );
        renderNotifList(currentNotifications);
        return true;
      }

      function renderNotifList(items = []) {
        const list = document.querySelector("[data-notification-list]");
        const empty = document.querySelector("[data-notification-empty]");
        if (!list || !empty) return;
        const notifications = Array.isArray(items) ? items : [];
        currentNotifications = notifications.slice();
        const unread = notifications.filter((item) => item?.read === false).length;
        setNotifBadge(unread);
        list.innerHTML = "";
        if (!notifications.length) {
          empty.style.display = "block";
          empty.textContent = "You're all caught up.";
          list.style.removeProperty("--notif-three-card-max-height");
          return;
        }
        empty.style.display = "none";
        notifications.forEach((item) => {
          const row = document.createElement("div");
          row.className = `notif-item ${item?.read === false ? "unread" : "read"}`;
          row.dataset.id = item?.id || item?._id || "";
          const message = String(formatNotificationMessage(item));
          const time = formatRelativeTime(item?.createdAt);
          const actorName = String(
            item?.actorFirstName ||
              item?.payload?.actorFirstName ||
              item?.payload?.fromName ||
              item?.payload?.actorName ||
              item?.payload?.paralegalName ||
              ""
          ).trim();
          const avatarSrc = getNotificationAvatar(item, actorName);

          const main = document.createElement("div");
          main.className = "notif-main";
          const avatar = document.createElement("img");
          avatar.className = "notif-avatar";
          avatar.loading = "lazy";
          avatar.alt = actorName ? `${actorName} profile photo` : "Notification profile photo";
          avatar.src = avatarSrc;
          avatar.addEventListener(
            "error",
            () => {
              avatar.src = getAvatarFallback(actorName);
            },
            { once: true }
          );
          const dot = document.createElement("span");
          dot.className = "notif-dot";
          dot.setAttribute("aria-hidden", "true");
          const copy = document.createElement("div");
          copy.className = "notif-copy";
          const title = document.createElement("div");
          title.className = "notif-title";
          title.textContent = message;
          const timeEl = document.createElement("div");
          timeEl.className = "notif-time";
          timeEl.textContent = time;
          copy.appendChild(title);
          copy.appendChild(timeEl);
          main.appendChild(avatar);
          main.appendChild(dot);
          main.appendChild(copy);

          const dismiss = document.createElement("button");
          dismiss.className = "notif-dismiss";
          dismiss.type = "button";
          dismiss.title = "Dismiss";
          dismiss.setAttribute("aria-label", "Dismiss notification");
          dismiss.textContent = "x";
          dismiss.addEventListener("click", async (event) => {
            event.stopPropagation();
            await dismissNotification(item?.id || item?._id);
          });

          row.appendChild(main);
          row.appendChild(dismiss);
          row.addEventListener("click", async () => {
            try {
              if (item?.read === false && (item?.id || item?._id)) {
                await fetch(`/api/notifications/${encodeURIComponent(item.id || item._id)}/read`, {
                  method: "POST",
                  credentials: "include",
                });
              }
            } catch (_) {}
            window.location.href = resolveNotifLink(item);
          });
          list.appendChild(row);
        });
        requestAnimationFrame(() => {
          enhanceCreateCaseNotifScroll(list);
          syncCreateCaseNotifViewport(list);
        });
      }

      async function fetchNotifications() {
        try {
          const res = await fetch("/api/notifications", {
            credentials: "include",
            headers: { Accept: "application/json" },
          });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const payload = await res.json().catch(() => []);
          renderNotifList(Array.isArray(payload) ? payload : []);
        } catch (_) {
          renderNotifList([]);
        }
      }

      function bindNotificationCenter() {
        const toggle = document.querySelector("[data-notification-toggle]");
        const panel = document.querySelector("[data-notification-panel]");
        const list = document.querySelector("[data-notification-list]");
        const markAll = document.querySelector("[data-notification-mark]");
        if (!toggle || !panel) return;
        enhanceCreateCaseNotifScroll(list);
        const setOpen = (open) => {
          panel.classList.toggle("show", open);
          panel.classList.toggle("hidden", !open);
        };
        setOpen(false);
        toggle.addEventListener("click", async (event) => {
          event.preventDefault();
          event.stopPropagation();
          const willOpen = !panel.classList.contains("show");
          setOpen(willOpen);
          if (willOpen) {
            await fetchNotifications();
            syncCreateCaseNotifViewport(list);
          }
        });
        markAll?.addEventListener("click", async (event) => {
          event.preventDefault();
          event.stopPropagation();
          try {
            await fetch("/api/notifications/read-all", {
              method: "POST",
              credentials: "include",
            });
          } catch (_) {}
          await fetchNotifications();
        });
        document.addEventListener("click", (event) => {
          if (toggle.contains(event.target) || panel.contains(event.target)) return;
          setOpen(false);
        });
        document.addEventListener("keydown", (event) => {
          if (event.key === "Escape") setOpen(false);
        });
        window.addEventListener("resize", () => {
          if (!panel.classList.contains("show")) return;
          syncCreateCaseNotifViewport(list);
        });
      }

      async function hydrateUser() {
        const session = await window.requireRole?.("attorney");
        const user = session || window.getStoredUser?.();
        if (!user) {
          window.location.href = "login.html";
          return;
        }
        applyUser(user);
        try {
          const res = await fetch("/api/users/me", {
            credentials: "include",
            headers: { Accept: "application/json" },
          });
          if (res.ok) {
            const profile = await res.json().catch(() => null);
            if (profile && typeof profile === "object") {
              applyUser(profile);
            }
          }
        } catch (_) {}
      }

      async function logoutNow(event) {
        event?.preventDefault?.();
        try {
          await fetch("/api/auth/logout", { method: "POST", credentials: "include" });
        } catch (_) {}
        window.clearStoredSession?.();
        window.location.href = "login.html";
      }

      document.addEventListener("DOMContentLoaded", () => {
        const logoutBtn = document.getElementById("logoutBtn");
        if (logoutBtn) logoutBtn.addEventListener("click", logoutNow);
        bindNotificationCenter();

        const userChip = document.getElementById("createCaseUserChip");
        const profileMenu = document.getElementById("createCaseProfileMenu");
        const menuLogoutBtn = profileMenu?.querySelector("[data-logout]");
        if (menuLogoutBtn) {
          menuLogoutBtn.addEventListener("click", logoutNow);
        }
        if (userChip && profileMenu) {
          const setProfileMenuOpen = (open) => {
            profileMenu.classList.toggle("show", open);
            profileMenu.setAttribute("aria-hidden", open ? "false" : "true");
            userChip.setAttribute("aria-expanded", open ? "true" : "false");
          };
          setProfileMenuOpen(false);
          userChip.addEventListener("click", (event) => {
            if (profileMenu.contains(event.target)) return;
            setProfileMenuOpen(!profileMenu.classList.contains("show"));
          });
          userChip.addEventListener("keydown", (event) => {
            if (event.key === "Enter" || event.key === " ") {
              event.preventDefault();
              setProfileMenuOpen(!profileMenu.classList.contains("show"));
            } else if (event.key === "Escape") {
              setProfileMenuOpen(false);
            }
          });
          document.addEventListener("click", (event) => {
            if (!profileMenu.classList.contains("show")) return;
            if (userChip.contains(event.target)) return;
            setProfileMenuOpen(false);
          });
          document.addEventListener("keydown", (event) => {
            if (event.key !== "Escape") return;
            if (!profileMenu.classList.contains("show")) return;
            setProfileMenuOpen(false);
          });
        }

        const cached = window.getStoredUser?.();
        if (cached) applyUser(cached);
        void hydrateUser();
        void fetchNotifications();
      });
    })();
  </script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const sidebarToggle = document.getElementById("sidebarToggle");
      const sidebarNav = document.getElementById("sidebarNav");
      const sidebarBackdrop = document.getElementById("sidebarBackdrop");
      const closeSidebar = () => {
        document.body.classList.remove("nav-open");
        if (sidebarToggle) sidebarToggle.setAttribute("aria-expanded", "false");
      };
      const openSidebar = () => {
        document.body.classList.add("nav-open");
        if (sidebarToggle) sidebarToggle.setAttribute("aria-expanded", "true");
      };
      if (sidebarToggle) {
        sidebarToggle.addEventListener("click", () => {
          if (document.body.classList.contains("nav-open")) closeSidebar();
          else openSidebar();
        });
      }
      if (sidebarBackdrop) {
        sidebarBackdrop.addEventListener("click", closeSidebar);
      }
      if (sidebarNav) {
        sidebarNav.addEventListener("click", (event) => {
          if (event.target.closest("a") || event.target.closest("button")) {
            closeSidebar();
          }
        });
      }
      window.addEventListener("resize", () => {
        if (window.innerWidth > 1024) closeSidebar();
      });
    });
  </script>

  <script>
  (function () {
    const params = new URLSearchParams(window.location.search);
    const editingCaseId = params.get("caseId");
    const draftIdParam = params.get("draftId");
    const isEditing = Boolean(editingCaseId);
    let currentDraftId = !isEditing ? draftIdParam : "";
    const DRAFT_AUTOSAVE_MS = 1600;
    const DRAFT_SAVE_ERROR_BACKOFF_MS = 3000;
    const EDIT_PREFILL_KEY = "lpc_case_edit_prefill";
    let draftLoaded = false;
    let draftSaveTimer = null;
    let draftSavePending = false;
    let draftSaveInFlight = false;
    let lastDraftSaveSnapshot = "";
    let draftSaveBlockedUntil = 0;
    const draftCache = {
      title: "",
      practiceArea: "",
      state: "",
      compAmount: "",
      experience: "",
      deadline: "",
      description: "",
      tasks: [],
    };

    const stepPanels = new Map();
    document.querySelectorAll(".step-panel").forEach((panel) => {
      const key = panel.dataset.step;
      if (key) stepPanels.set(key, panel);
    });
    let currentStep = null;

    const fields = {
      title: document.getElementById("caseTitleInput"),
      specialty: document.getElementById("specialty"),
      state: document.getElementById("state"),
      comp: document.getElementById("comp"),
      experience: document.getElementById("experience"),
      deadline: document.getElementById("caseDeadline"),
    };
    const taskInput = document.getElementById("caseTaskInput");
    const taskAddBtn = document.getElementById("addCaseTaskBtn");
    const taskList = document.getElementById("caseTaskList");
    const taskHelper = document.getElementById("caseTaskHelper");
    const compLockNotice = document.getElementById("compLockNotice");
    const compWrapper = fields.comp?.closest(".comp-wrapper");
    const titlePreview = document.getElementById("caseTitlePreviewText");
    const descriptionInput = document.getElementById("caseDescription");
    const descriptionCount = document.getElementById("descriptionCharCount");
    const toastHelper = window.toastUtils;
    const reviewSummary = document.getElementById("reviewSummary");
    const previewBtn = document.getElementById("previewBtn");
    const postBtn = document.getElementById("postBtn");
    const previewModal = document.getElementById("previewModal");
    const closePreviewBtn = document.getElementById("closePreview");
    const toastEl = document.getElementById("toast");
    const previewFields = {
      title: document.getElementById("previewTitle"),
      field: document.getElementById("previewField"),
      state: document.getElementById("previewState"),
      comp: document.getElementById("previewComp"),
      platformFee: document.getElementById("previewPlatformFee"),
      totalDue: document.getElementById("previewTotalDue"),
      experience: document.getElementById("previewExperience"),
      deadline: document.getElementById("previewDeadline"),
      deadlineRow: document.getElementById("previewDeadlineRow"),
      description: document.getElementById("previewDescription"),
      tasks: document.getElementById("previewTasks"),
    };
    const previewAutoNote = document.getElementById("previewAutoNote");
    const autoNoteCopy = "Applicants automatically include their résumé, cover letter (if available), and LinkedIn profile.";
    const PLATFORM_FEE_PCT = 22;
    const PLATFORM_FEE_NOTE =
      "Platform fee includes Stripe security, dispute support, payment processing, and vetted paralegal access.";
    const STRIPE_PAYMENT_METHOD_BYPASS_EMAILS = new Set([
      "samanthasider+attorney@gmail.com",
      "samanthasider+56@gmail.com",
    ]);
    let latestCaseData = null;
    let csrfToken = "";
    const tasksState = {
      items: [],
      locked: false,
    };

    const validators = [
      {
        field: fields.title,
        check: (value) => value.trim().length >= 3,
        message: "Add a descriptive case title.",
      },
      {
        field: fields.specialty,
        check: (value) => Boolean(value.trim()),
        message: "Select the primary practice area.",
      },
      {
        field: fields.state,
        check: (value) => Boolean(value.trim()),
        message: "Select the state or jurisdiction.",
      },
      {
        field: fields.comp,
        check: (value) => Number(value) >= 400,
        message: "Enter a compensation amount of at least $400.",
      },
    ];

    const stepForms = document.querySelectorAll(".step-panel form");
    stepForms.forEach((form) => {
      form.setAttribute("novalidate", "novalidate");
      form.addEventListener("submit", (event) => event.preventDefault());
    });

    function focusFirstInvalidField() {
      const firstInvalid = validators.find(({ field, check }) => field && !check(field.value || ""));
      if (!firstInvalid?.field) return;
      try {
        firstInvalid.field.focus({ preventScroll: true });
        firstInvalid.field.scrollIntoView({ block: "center" });
      } catch {}
    }

    function updateTitlePreview(value = "") {
      if (!titlePreview) return;
      const safe = value.trim();
      titlePreview.textContent = safe || "Untitled Case";
    }

    function updateDescriptionCount() {
      if (!descriptionInput || !descriptionCount) return;
      descriptionCount.textContent = `${descriptionInput.value.length} / 4000`;
    }

    const MAX_REVIEW_DESCRIPTION = 1200;
    const MAX_REVIEW_TASKS = 25;

    function normalizeTaskTitle(value) {
      return String(value || "")
        .replace(/[\u0000-\u001F\u007F]/g, "")
        .trim()
        .slice(0, 200);
    }

    function readStoredTasks() {
      if (!Array.isArray(draftCache.tasks)) return [];
      return draftCache.tasks
        .map((entry) => {
          const title = normalizeTaskTitle(typeof entry === "string" ? entry : entry?.title);
          return title ? { title } : null;
        })
        .filter(Boolean);
    }

    function persistTasks() {
      draftCache.tasks = tasksState.items.map((task) => ({ title: task.title }));
      queueDraftSave();
    }

    function getNormalizedTasks() {
      const source = tasksState.items.length ? tasksState.items : readStoredTasks();
      return source
        .map((task) => normalizeTaskTitle(typeof task === "string" ? task : task?.title))
        .filter(Boolean)
        .map((title) => ({ title }));
    }

    function validateTasks() {
      if (!taskInput) return true;
      clearFieldError(taskInput);
      const tasks = getNormalizedTasks();
      if (!tasks.length) {
        showFieldError(taskInput, "Add at least one task.");
        return false;
      }
      return true;
    }

    function renderTasks() {
      if (!taskList) return;
      taskList.innerHTML = "";
      if (!tasksState.items.length) {
        const empty = document.createElement("li");
        empty.className = "task-empty";
        empty.textContent = "";
        taskList.appendChild(empty);
        return;
      }
      tasksState.items.forEach((task, idx) => {
        const row = document.createElement("li");
        const label = document.createElement("span");
        label.textContent = task.title;
        row.appendChild(label);
        if (!tasksState.locked) {
          const removeBtn = document.createElement("button");
          removeBtn.type = "button";
          removeBtn.className = "task-remove";
          removeBtn.textContent = "Remove";
          removeBtn.addEventListener("click", () => {
            tasksState.items.splice(idx, 1);
            persistTasks();
            renderTasks();
          });
          row.appendChild(removeBtn);
        }
        taskList.appendChild(row);
      });
      if (tasksState.items.length) {
        clearFieldError(taskInput);
      }
    }

    function setTasksLocked(locked) {
      tasksState.locked = !!locked;
      if (taskInput) taskInput.disabled = tasksState.locked;
      if (taskAddBtn) taskAddBtn.disabled = tasksState.locked;
      if (taskHelper) taskHelper.style.display = tasksState.locked ? "none" : "";
      renderTasks();
    }

    const DRAFT_FIELD_MAP = {
      caseTitle: "title",
      caseSpecialty: "practiceArea",
      caseState: "state",
      caseComp: "compAmount",
      caseCompAmount: "compAmount",
      caseExperience: "experience",
      caseDeadline: "deadline",
      caseDescription: "description",
    };

    function setDraftField(key, value) {
      const mapped = DRAFT_FIELD_MAP[key] || key;
      draftCache[mapped] = String(value || "");
    }

    function getDraftField(key) {
      const mapped = DRAFT_FIELD_MAP[key] || key;
      return String(draftCache[mapped] || "");
    }

    function hydrateDeadline() {
      if (!fields.deadline) return;
      const stored = getStoredValue("caseDeadline", "case_deadline");
      if (stored) fields.deadline.value = stored;
    }

    function showStep(step, { updateHash = true } = {}) {
      if (!stepPanels.has(step)) return;
      stepPanels.forEach((panel, key) => {
        if (!panel) return;
        panel.hidden = key !== step;
      });
      currentStep = step;
      if (updateHash) {
        history.replaceState(null, "", `#${step}`);
      }
    }

    function attemptStepChange(targetStep) {
      try {
        if (!targetStep || targetStep === currentStep) return;
        if (targetStep === "description" && currentStep !== "description") {
          if (!validateDetails()) return;
          persistDraft();
        }
        if (targetStep === "review") {
          if (!ensureReviewReady()) return;
          persistDraft();
          hydrateReviewSummary();
        }
        showStep(targetStep);
      } catch (err) {
        console.warn("Step change failed", err);
        showStep("details", { updateHash: false });
        showToastBanner("Finish the required fields before moving to the next step.", "error");
      }
    }

    document.querySelectorAll("[data-step-link]").forEach((link) => {
      link.addEventListener("click", (event) => {
        const target = link.dataset.stepLink;
        if (!target) return;
        event.preventDefault();
        attemptStepChange(target);
      });
    });
    document.querySelectorAll("[data-step-switch]").forEach((btn) => {
      btn.addEventListener("click", () => {
        const target = btn.dataset.stepSwitch;
        if (!target) return;
        attemptStepChange(target);
      });
    });

    const initialHash = (window.location.hash || "").replace("#", "");
    const pendingInitialStep = initialHash && stepPanels.has(initialHash) ? initialHash : "details";
    let initialStepApplied = false;

    function applyInitialStep() {
      if (initialStepApplied) return;
      initialStepApplied = true;
      if (pendingInitialStep === "description") {
        showStep("details", { updateHash: false });
        attemptStepChange("description");
      } else if (pendingInitialStep === "review") {
        showStep("details", { updateHash: false });
        attemptStepChange("description");
        attemptStepChange("review");
      } else {
        showStep(pendingInitialStep, { updateHash: false });
      }
    }

    window.addEventListener("hashchange", () => {
      const hashed = (window.location.hash || "").replace("#", "");
      if (!hashed || hashed === currentStep) return;
      if (!stepPanels.has(hashed)) return;
      if (hashed === "description" || hashed === "review") {
        attemptStepChange(hashed);
      } else {
        showStep(hashed, { updateHash: false });
      }
    });

    Object.entries(fields).forEach(([key, field]) => {
      if (!field) return;
      const eventName = field.tagName === "SELECT" ? "change" : "input";
      field.addEventListener(eventName, () => clearFieldError(field));
      const storageKeyCamel = `case${key.charAt(0).toUpperCase() + key.slice(1)}`;
      const storedValue = isEditing ? "" : getStoredValue(storageKeyCamel, `case_${key}`);
      if (storedValue && field.value !== storedValue) {
        field.value = storedValue;
      }
      if (key === "title") {
        updateTitlePreview(field.value || storedValue || "");
      }
      field.addEventListener(eventName, () => {
        const value = field.value || "";
        setDraftField(storageKeyCamel, value);
        queueDraftSave();
        if (key === "title") {
          updateTitlePreview(value);
        }
      });
    });

    if (descriptionInput) {
      const storedDescription = isEditing
        ? ""
        : getStoredValue("caseDescription", "case_description");
      if (storedDescription) {
        descriptionInput.value = storedDescription.slice(0, 4000);
      }
      updateDescriptionCount();
      hydrateDeadline();
      descriptionInput.addEventListener("input", () => {
        if (descriptionInput.value.length > 4000) {
          descriptionInput.value = descriptionInput.value.slice(0, 4000);
        }
        setDraftField("caseDescription", descriptionInput.value);
        queueDraftSave();
        updateDescriptionCount();
      });
    }

    tasksState.items = isEditing ? [] : readStoredTasks();
    renderTasks();
    if (taskAddBtn && taskInput) {
      taskAddBtn.addEventListener("click", () => {
        if (tasksState.locked) return;
        const title = normalizeTaskTitle(taskInput.value);
        if (!title) return;
        tasksState.items.push({ title });
        taskInput.value = "";
        persistTasks();
        renderTasks();
      });
      taskInput.addEventListener("keydown", (event) => {
        if (event.key !== "Enter") return;
        event.preventDefault();
        taskAddBtn.click();
      });
    }
    async function initDraftLoad() {
      if (isEditing) {
        applyInitialStep();
        return;
      }
      if (!currentDraftId) {
        applyInitialStep();
        return;
      }
      try {
        const draft = await fetchDraftById(currentDraftId);
        if (draft) {
          draftCache.title = draft.title || "";
          draftCache.practiceArea = draft.practiceArea || "";
          draftCache.state = draft.state || "";
          draftCache.compAmount = draft.compAmount || "";
          draftCache.experience = draft.experience || "";
          draftCache.deadline = draft.deadline || "";
          draftCache.description = draft.description || "";
          draftCache.tasks = Array.isArray(draft.tasks) ? draft.tasks : [];
          if (fields.title) fields.title.value = draftCache.title;
          if (fields.specialty) fields.specialty.value = draftCache.practiceArea;
          if (fields.state) fields.state.value = draftCache.state;
          if (fields.comp) fields.comp.value = draftCache.compAmount;
          if (fields.experience) fields.experience.value = draftCache.experience;
          if (fields.deadline) fields.deadline.value = draftCache.deadline;
          if (descriptionInput) {
            descriptionInput.value = draftCache.description.slice(0, 4000);
            updateDescriptionCount();
          }
          updateTitlePreview(draftCache.title);
          tasksState.items = readStoredTasks();
          renderTasks();
          draftLoaded = true;
        }
      } catch (err) {
        console.warn("Unable to load draft", err);
      }
      applyInitialStep();
    }

    void initDraftLoad();

    function validateDetails() {
      let hasErrors = false;
      validators.forEach(({ field, check, message }) => {
        clearFieldError(field);
        if (!field) return;
        if (!check(field.value || "")) {
          showFieldError(field, message);
          hasErrors = true;
        }
      });
      if (hasErrors) {
        focusFirstInvalidField();
        return false;
      }
      return true;
    }

    function persistDraft() {
      if (isEditing) return;
      setDraftField("caseTitle", fields.title?.value?.trim() || "");
      setDraftField("caseSpecialty", fields.specialty?.value || "");
      setDraftField("caseState", fields.state?.value || "");
      setDraftField("caseComp", fields.comp?.value || "");
      setDraftField("caseCompAmount", fields.comp?.value || "");
      setDraftField("caseExperience", fields.experience?.value || "");
      setDraftField("caseDeadline", fields.deadline?.value || "");
      setDraftField("caseDescription", descriptionInput?.value || "");
      draftCache.tasks = tasksState.items.map((task) => ({ title: task.title }));
      queueDraftSave({ immediate: true });
    }

    function showFieldError(field, message) {
      if (!field) return;
      clearFieldError(field);
      field.classList.add("input-error");
      field.setAttribute("aria-invalid", "true");
      const error = document.createElement("div");
      error.className = "field-error";
      error.textContent = message;
      const wrapper = field.closest(".field") || field.closest("[data-field-wrapper]");
      if (wrapper) wrapper.appendChild(error);
      else field.insertAdjacentElement("afterend", error);
    }

    function clearFieldError(field) {
      if (!field) return;
      field.classList.remove("input-error");
      field.removeAttribute("aria-invalid");
      const wrapper = field.closest(".field") || field.closest("[data-field-wrapper]");
      if (wrapper) {
        const existing = wrapper.querySelector(".field-error");
        if (existing) existing.remove();
        return;
      }
      const next = field.nextElementSibling;
      if (next?.classList.contains("field-error")) {
        next.remove();
      }
    }

    function getStoredValue(primaryKey, legacyKey) {
      const value = getDraftField(primaryKey) || getDraftField(legacyKey);
      if (primaryKey === "caseDescription" || legacyKey === "case_description") {
        return value.slice(0, 4000);
      }
      return value;
    }

    function formatComp(amount) {
      if (!amount) return "—";
      const numeric = Number(amount);
      if (!Number.isFinite(numeric)) return `$${amount}`;
      return numeric.toLocaleString("en-US", { style: "currency", currency: "USD", maximumFractionDigits: 0 });
    }

    function formatMoney(value) {
      if (value == null || Number.isNaN(Number(value))) return "—";
      const numeric = Number(value);
      return numeric.toLocaleString("en-US", {
        style: "currency",
        currency: "USD",
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      });
    }

    function parseCompAmount(value) {
      const numeric = Number(value);
      if (!Number.isFinite(numeric) || numeric <= 0) return null;
      return numeric;
    }

    function computePlatformFee(amount) {
      const cents = Math.round(amount * 100);
      const feeCents = Math.round((cents * PLATFORM_FEE_PCT) / 100);
      const totalCents = cents + feeCents;
      return { fee: feeCents / 100, total: totalCents / 100 };
    }

    function escapeHTML(value) {
      return String(value ?? "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function collectCaseData() {
      const title = (fields.title?.value || "").trim() || getStoredValue("caseTitle", "case_title");
      const field = fields.specialty?.value || getStoredValue("caseSpecialty", "case_specialty");
      const state = fields.state?.value || getStoredValue("caseState", "case_state");
      const compRaw = fields.comp?.value || getStoredValue("caseCompAmount", "case_comp_amount");
      const experience = fields.experience?.value || getStoredValue("caseExperience", "case_experience");
      const deadline = fields.deadline?.value || getStoredValue("caseDeadline", "case_deadline");
      let description = (descriptionInput?.value || "").trim() || getStoredValue("caseDescription", "case_description").trim();
      if (description.length > 4000) {
        description = description.slice(0, 4000);
      }
      const tasks = tasksState.items.length ? tasksState.items : readStoredTasks();
      return {
        title: title || "",
        field: field || "",
        state: state || "",
        compAmount: compRaw || "",
        comp: formatComp(compRaw),
        experience: experience || "",
        deadline: deadline || "",
        description: description || "",
        tasks,
      };
    }

    function setCompLocked(locked) {
      if (!fields.comp) return;
      fields.comp.disabled = !!locked;
      fields.comp.setAttribute("aria-disabled", locked ? "true" : "false");
      compWrapper?.classList.toggle("is-locked", !!locked);
    }

    function hasDescription() {
      if ((descriptionInput?.value || "").trim()) return true;
      return Boolean(getStoredValue("caseDescription", "case_description").trim());
    }

    function ensureReviewReady() {
      if (!validateDetails()) return false;
      if (!validateTasks()) return false;
      if (!hasDescription()) {
        return false;
      }
      if (fields.deadline && fields.deadline.value) {
        const parsed = new Date(fields.deadline.value);
        if (Number.isNaN(parsed.getTime())) {
          showToastBanner("Enter a valid deadline date (YYYY-MM-DD).", "error");
          return false;
        }
      }
      return true;
    }

    function hydrateReviewSummary() {
      if (!reviewSummary) return;
      const data = collectCaseData();
      latestCaseData = data;
      const deadlineText = data.deadline
        ? new Date(data.deadline).toLocaleDateString() || data.deadline
        : "No deadline set";
      const tasks = Array.isArray(data.tasks) ? data.tasks : [];
      const visibleTasks = tasks.slice(0, MAX_REVIEW_TASKS);
      const extraTasks = tasks.length - visibleTasks.length;
      const tasksMarkup = visibleTasks.length
        ? `<ul class="task-list">${visibleTasks
            .map((task) => `<li>${escapeHTML(task.title)}</li>`)
            .join("")}</ul>`
        : `<p><strong>Tasks:</strong> Not provided</p>`;
      const safeTitle = escapeHTML(data.title || "(Untitled Case)");
      const safeField = escapeHTML(data.field || "Practice area pending");
      const safeState = escapeHTML(data.state || "Location pending");
      const safeComp = escapeHTML(data.comp || "—");
      const safeExperience = escapeHTML(data.experience || "Not specified");
      const safeDeadline = escapeHTML(deadlineText);
      const compAmount = parseCompAmount(data.compAmount);
      const feeEstimate = compAmount ? computePlatformFee(compAmount) : null;
      const feeInfoHtml = feeEstimate
        ? `<span class="fee-info" tabindex="0" data-tooltip="${escapeHTML(PLATFORM_FEE_NOTE)}">?</span>`
        : "";
      const feeLine = feeEstimate
        ? `<p><strong>Platform fee (${PLATFORM_FEE_PCT}%):</strong> ${formatMoney(
            feeEstimate.fee
          )} ${feeInfoHtml}</p>`
        : "";
      const totalLine = feeEstimate
        ? `<p><strong>Estimated total due at hire:</strong> ${formatMoney(feeEstimate.total)}</p>`
        : "";
      const estimateNoteLine = feeEstimate
        ? `<p class="auto-note">Estimated total due at hire = case amount + ${PLATFORM_FEE_PCT}% platform fee.</p>`
        : "";
      const rawDescription = data.description || "No description provided yet.";
      const safeDescription = escapeHTML(rawDescription);
      const truncated =
        safeDescription.length > MAX_REVIEW_DESCRIPTION
          ? `${safeDescription.slice(0, MAX_REVIEW_DESCRIPTION)}…`
          : safeDescription;
      const displayDescription = truncated.replace(/\n/g, "<br>");
      reviewSummary.innerHTML = `
        <h2>${safeTitle}</h2>
        <p><small>${safeField} • ${safeState}</small></p>
        <p><strong>Compensation:</strong> ${safeComp}</p>
        ${feeLine}
        ${totalLine}
        ${estimateNoteLine}
        <p><strong>Experience:</strong> ${safeExperience}</p>
        <p><strong>Deadline:</strong> ${safeDeadline}</p>
        <hr>
        <p>${displayDescription}</p>
        <div style="margin-top:12px;">
          <div class="description-label" style="margin-bottom:6px;">TASKS</div>
          ${tasksMarkup}
        </div>
        ${extraTasks > 0 ? `<p class="auto-note">+${extraTasks} more tasks will be included when you post.</p>` : ""}
        <p class="auto-note">${autoNoteCopy}</p>
      `;
    }

    function openPreviewModal() {
      if (!previewModal) return;
      const data = latestCaseData || collectCaseData();
      if (!data.title || !data.description) {
        showToastBanner("Add a case title and description before previewing.", "error");
        return;
      }
      const tasks = Array.isArray(data.tasks) ? data.tasks : [];
      const visibleTasks = tasks.slice(0, MAX_REVIEW_TASKS);
      const extraTasks = tasks.length - visibleTasks.length;
      const tasksMarkup = visibleTasks.length
        ? `<div class="description-label" style="margin-bottom:6px;">TASKS</div>
           <ul class="task-list">${visibleTasks
             .map((task) => `<li>${escapeHTML(task.title)}</li>`)
             .join("")}</ul>${extraTasks > 0 ? `<p class="auto-note">+${extraTasks} more tasks will be included when you post.</p>` : ""}`
        : `<p><strong>Tasks:</strong> Not provided</p>`;
      previewFields.title && (previewFields.title.textContent = data.title);
      previewFields.field && (previewFields.field.textContent = data.field || "—");
      previewFields.state && (previewFields.state.textContent = data.state || "—");
      previewFields.comp && (previewFields.comp.textContent = data.comp || "—");
      const previewCompAmount = parseCompAmount(data.compAmount);
      const previewFeeEstimate = previewCompAmount ? computePlatformFee(previewCompAmount) : null;
      if (previewFields.platformFee) {
        previewFields.platformFee.textContent = previewFeeEstimate
          ? formatMoney(previewFeeEstimate.fee)
          : "—";
      }
      if (previewFields.totalDue) {
        previewFields.totalDue.textContent = previewFeeEstimate
          ? formatMoney(previewFeeEstimate.total)
          : "—";
      }
      previewFields.experience && (previewFields.experience.textContent = data.experience || "—");
      previewFields.description && (previewFields.description.textContent = data.description || "No description provided yet.");
      previewFields.tasks && (previewFields.tasks.innerHTML = tasksMarkup);
      if (previewFields.deadline && previewFields.deadlineRow) {
        if (data.deadline) {
          const deadlineText = new Date(data.deadline).toLocaleDateString() || data.deadline;
          previewFields.deadline.textContent = deadlineText;
          previewFields.deadlineRow.hidden = false;
        } else {
          previewFields.deadline.textContent = "—";
          previewFields.deadlineRow.hidden = true;
        }
      }
      if (previewAutoNote) previewAutoNote.textContent = autoNoteCopy;
      previewModal.classList.add("active");
      document.body.classList.add("modal-open");
    }

    function closePreviewModal() {
      if (!previewModal) return;
      previewModal.classList.remove("active");
      document.body.classList.remove("modal-open");
    }

    function clearDraft() {
      draftCache.title = "";
      draftCache.practiceArea = "";
      draftCache.state = "";
      draftCache.compAmount = "";
      draftCache.experience = "";
      draftCache.deadline = "";
      draftCache.description = "";
      draftCache.tasks = [];
    }

    function showToast(message, href, isError = false, linkLabel = "View Case") {
      if (!toastEl) return;
      const linkHtml = href ? ` <a href="${href}">${escapeHTML(linkLabel || "View Case")}</a>` : "";
      toastEl.innerHTML = `${isError ? "⚠️" : "✅"} ${message}${linkHtml}`;
      toastEl.classList.toggle("error", Boolean(isError));
      toastEl.classList.add("show");
      setTimeout(() => toastEl.classList.remove("show"), 5000);
    }

    async function fetchCsrfToken() {
      if (csrfToken) return csrfToken;
      try {
        const res = await fetch("/api/csrf", { credentials: "include" });
        const json = await res.json().catch(() => ({}));
        csrfToken = json?.csrfToken || "";
      } catch (err) {
        console.warn("Unable to fetch CSRF token", err);
      }
      return csrfToken;
    }

    async function readResponsePayload(res) {
      const text = await res.text().catch(() => "");
      if (!text) return { data: {}, text: "" };
      try {
        return { data: JSON.parse(text), text };
      } catch {
        return { data: {}, text };
      }
    }

    function resolveAuthHeader(token) {
      if (!token || token === "__cookie_session__") return {};
      return { Authorization: `Bearer ${token}` };
    }

    async function authorizedFetch(url, options = {}) {
      const token = (window.getSessionToken && window.getSessionToken()) || "";
      if (!token) {
        window.checkSession?.("attorney");
        throw new Error("Please log in again.");
      }
      const headers = { ...(options.headers || {}), ...resolveAuthHeader(token) };
      let body = options.body;
      if (typeof body !== "undefined" && body !== null && !(body instanceof FormData)) {
        headers["Content-Type"] = headers["Content-Type"] || "application/json";
        body = JSON.stringify(body);
      }
      if (options.method && options.method !== "GET") {
        await fetchCsrfToken();
        headers["X-CSRF-Token"] = csrfToken || "";
      }
      return fetch(url, {
        credentials: "include",
        ...options,
        headers,
        body,
      });
    }

    async function fetchDraftById(draftId) {
      if (!draftId) return null;
      const res = await authorizedFetch(`/api/case-drafts/${encodeURIComponent(draftId)}`);
      const { data, text } = await readResponsePayload(res);
      if (!res.ok) {
        const message = data?.error || data?.message || text;
        throw new Error(message || "Unable to load draft.");
      }
      return data?.draft || null;
    }

    async function saveDraftRemote(payload) {
      if (!payload) return null;
      const url = currentDraftId
        ? `/api/case-drafts/${encodeURIComponent(currentDraftId)}`
        : "/api/case-drafts";
      const method = currentDraftId ? "PUT" : "POST";
      const res = await authorizedFetch(url, { method, body: payload });
      const { data, text } = await readResponsePayload(res);
      if (!res.ok) {
        const message = data?.error || data?.message || text;
        throw new Error(message || "Unable to save draft.");
      }
      return data?.draft || null;
    }

    async function deleteDraftRemote(draftId) {
      if (!draftId) return;
      const res = await authorizedFetch(`/api/case-drafts/${encodeURIComponent(draftId)}`, {
        method: "DELETE",
      });
      if (!res.ok) {
        const { data, text } = await readResponsePayload(res);
        const message = data?.error || data?.message || text;
        throw new Error(message || "Unable to delete draft.");
      }
    }

    async function submitCase(payload) {
      const token = (window.getSessionToken && window.getSessionToken()) || "";
      if (!token) {
        window.checkSession?.("attorney");
        throw new Error("Please log in again before posting.");
      }
      await fetchCsrfToken();
      const res = await fetch("/api/cases", {
        method: "POST",
        suppressToast: true,
        credentials: "include",
        headers: {
          "Content-Type": "application/json",
          ...resolveAuthHeader(token),
          "X-CSRF-Token": csrfToken || "",
          Accept: "application/json",
        },
        body: JSON.stringify(payload),
      });
      const { data, text } = await readResponsePayload(res);
      if (!res.ok) {
        const message = data?.error || data?.msg || data?.message || (text && !text.includes("<") ? text : "");
        const statusNote = res.status ? ` (HTTP ${res.status})` : "";
        throw new Error(message || `Unable to post this case right now.${statusNote}`);
      }
      return data;
    }

    async function hasDefaultPaymentMethod() {
      const storedUser = window.getStoredUser?.() || null;
      const email = String(storedUser?.email || "").toLowerCase().trim();
      if (STRIPE_PAYMENT_METHOD_BYPASS_EMAILS.has(email)) return true;
      const res = await authorizedFetch("/api/payments/payment-method/default", {
        headers: { Accept: "application/json" },
        suppressToast: true,
      });
      const { data, text } = await readResponsePayload(res);
      if (!res.ok) {
        const message = data?.error || data?.msg || data?.message || (text && !text.includes("<") ? text : "");
        throw new Error(message || "Unable to verify your payment method.");
      }
      return Boolean(data?.paymentMethod);
    }

    function mapPracticeArea(area = "") {
      // Must align exactly with backend PRACTICE_AREAS (lowercase)
      const allowed = [
        "administrative law",
        "antitrust law",
        "bankruptcy",
        "business law",
        "civil litigation",
        "commercial litigation",
        "contract law",
        "corporate law",
        "criminal defense",
        "employment law",
        "estate planning",
        "trusts & estates",
        "family law",
        "immigration",
        "intellectual property",
        "labor law",
        "personal injury",
        "real estate",
        "tax law",
        "technology",
      ];
      const aliases = {
        "admiralty & maritime law": "civil litigation",
        "competition law": "antitrust law",
        "appellate law": "civil litigation",
        "banking law": "business law",
        "bankruptcy law": "bankruptcy",
        "business / corporate law": "business law",
        "civil rights law": "civil litigation",
        "class action law": "civil litigation",
        "commercial law": "commercial litigation",
        "communications law": "technology",
        "construction law": "civil litigation",
        "consumer protection law": "civil litigation",
        "corporate law": "corporate law",
        "criminal defense law": "criminal defense",
        "education law": "administrative law",
        "elder law": "estate planning",
        "election law": "administrative law",
        "employment & labor law": "employment law",
        "energy law": "technology",
        "entertainment law": "technology",
        "environmental law": "civil litigation",
        "estate planning & probate": "estate planning",
        "franchise law": "business law",
        "government contracts law": "contract law",
        "health care law": "employment law",
        "immigration law": "immigration",
        "insurance law": "business law",
        "intellectual property (ip) law": "intellectual property",
        "international law": "business law",
        "land use & zoning law": "real estate",
        "litigation": "civil litigation",
        "media law": "technology",
        "medical malpractice": "personal injury",
        "military law": "administrative law",
        "municipal law": "administrative law",
        "personal injury law": "personal injury",
        "product liability law": "personal injury",
        "real estate law": "real estate",
        "securities law": "business law",
        "social security / disability law": "administrative law",
        "sports law": "business law",
        "technology law": "technology",
        "telecommunications law": "technology",
        "torts": "civil litigation",
        "transportation law": "business law",
        "trusts and estates": "trusts & estates",
        "white collar crime": "criminal defense",
        "workers’ compensation": "employment law",
      };

      const cleaned = area.trim().replace(/[’']/g, "'").toLowerCase();
      if (allowed.includes(cleaned)) return cleaned;
      if (aliases[cleaned]) return aliases[cleaned];
      const ampCandidate = cleaned.replace(/\band\b/g, "&").replace(/\s*&\s*/g, " & ");
      if (allowed.includes(ampCandidate)) return ampCandidate;
      if (aliases[ampCandidate]) return aliases[ampCandidate];

      // Broad keyword fallbacks
      if (cleaned.includes("contract")) return "contract law";
      if (cleaned.includes("family")) return "family law";
      if (cleaned.includes("immigration")) return "immigration";
      if (cleaned.includes("real estate") || cleaned.includes("zoning") || cleaned.includes("land use"))
        return "real estate";
      if (cleaned.includes("employment") || cleaned.includes("labor")) return "employment law";
      if (cleaned.includes("corporate") || cleaned.includes("business")) return "business law";
      if (cleaned.includes("tax")) return "tax law";
      if (cleaned.includes("technology") || cleaned.includes("telecom") || cleaned.includes("media"))
        return "technology";
      if (cleaned.includes("ip") || cleaned.includes("intellectual")) return "intellectual property";
      if (cleaned.includes("injury") || cleaned.includes("liability") || cleaned.includes("malpractice"))
        return "personal injury";
      if (cleaned.includes("estate")) return "estate planning";
      if (cleaned.includes("trust")) return "trusts & estates";
      if (cleaned.includes("antitrust")) return "antitrust law";
      if (cleaned.includes("criminal") || cleaned.includes("white collar")) return "criminal defense";
      if (cleaned.includes("bankruptcy")) return "bankruptcy";
      // Default to a safe allowed value
      return "civil litigation";
    }

    function padDescription(text = "") {
      if (text.length >= 50) return text;
      const filler = " Additional details will be provided to qualified applicants.";
      let result = text.trim();
      while (result.length < 50) {
        result += filler;
      }
      return result;
    }

    function buildPayload(data) {
      const description = data.description || "Additional details will be provided once the case is accepted.";
      const practiceArea = mapPracticeArea(data.field);
      const deadline = data.deadline || "";
      const payload = {
        title: data.title,
        practiceArea,
        state: data.state,
        compensationAmount: data.compAmount,
        experience: data.experience,
        details: description,
        deadline,
      };
      if (!tasksState.locked) {
        payload.tasks = Array.isArray(data.tasks) ? data.tasks : [];
      }
      return payload;
    }

    function hasDraftContent(payload) {
      if (!payload) return false;
      if (payload.title || payload.practiceArea || payload.state || payload.compAmount) return true;
      if (payload.experience || payload.deadline || payload.description) return true;
      return Array.isArray(payload.tasks) && payload.tasks.length > 0;
    }

    function buildDraftPayload() {
      const data = latestCaseData || collectCaseData();
      return {
        title: data.title || "",
        practiceArea: data.field || "",
        state: data.state || "",
        compAmount: data.compAmount || "",
        experience: data.experience || "",
        deadline: data.deadline || "",
        description: data.description || "",
        tasks: Array.isArray(data.tasks) ? data.tasks : [],
      };
    }

    async function flushDraftSave() {
      if (isEditing) return;
      if (draftSaveInFlight) {
        draftSavePending = true;
        return;
      }
      if (Date.now() < draftSaveBlockedUntil) return;
      const payload = buildDraftPayload();
      if (!hasDraftContent(payload)) return;
      const snapshot = JSON.stringify(payload);
      if (snapshot === lastDraftSaveSnapshot) return;
      draftSaveInFlight = true;
      try {
        const saved = await saveDraftRemote(payload);
        if (saved?.id) {
          currentDraftId = saved.id;
          draftLoaded = true;
        }
        lastDraftSaveSnapshot = snapshot;
        draftSaveBlockedUntil = 0;
      } catch (err) {
        console.warn("Draft save failed", err);
        draftSaveBlockedUntil = Date.now() + DRAFT_SAVE_ERROR_BACKOFF_MS;
      } finally {
        draftSaveInFlight = false;
        if (draftSavePending) {
          draftSavePending = false;
          if (Date.now() >= draftSaveBlockedUntil) {
            void flushDraftSave();
          }
        }
      }
    }

    function queueDraftSave({ immediate = false } = {}) {
      if (isEditing) return;
      if (immediate) {
        if (draftSaveTimer) clearTimeout(draftSaveTimer);
        draftSaveTimer = null;
        void flushDraftSave();
        return;
      }
      if (draftSaveTimer) clearTimeout(draftSaveTimer);
      draftSaveTimer = setTimeout(() => {
        draftSaveTimer = null;
        void flushDraftSave();
      }, DRAFT_AUTOSAVE_MS);
    }

    async function deleteDraftIfExists() {
      if (!currentDraftId) return;
      try {
        await deleteDraftRemote(currentDraftId);
      } catch (err) {
        console.warn("Unable to delete draft", err);
      } finally {
        currentDraftId = "";
      }
    }

    window.saveDraftAndExit = async function (targetHref) {
      await flushDraftSave();
      if (targetHref) {
        window.location.href = targetHref;
      }
    };

    async function handlePost() {
      if (!ensureReviewReady()) {
        showToastBanner("Finish the required fields before posting.", "error");
        return;
      }
      const data = latestCaseData || collectCaseData();
      if (!data.title || !data.description) {
        showToastBanner("Add a case title and description before posting.", "error");
        return;
      }
      if (postBtn) postBtn.disabled = true;
      try {
        if (!isEditing) {
          const paymentMethodReady = await hasDefaultPaymentMethod();
          if (!paymentMethodReady) {
            showToast(
              "Connect Stripe and add a payment method before posting a case.",
              "dashboard-attorney.html#billing",
              true,
              "Open Billing"
            );
            if (postBtn) postBtn.disabled = false;
            return;
          }
        }
        const payload = buildPayload(data);
        const created = isEditing && editingCaseId
          ? await updateCase(editingCaseId, payload)
          : await submitCase(payload);
        await deleteDraftIfExists();
        clearDraft();
        const caseId = created?.id || created?._id || editingCaseId;
        // Jobs are now mirrored automatically when a case is created on the backend.
        const href = caseId
          ? `dashboard-attorney.html?previewCaseId=${encodeURIComponent(caseId)}#cases`
          : "dashboard-attorney.html#cases";
        showToast(
          isEditing ? "Your changes have been saved." : "Your case has been posted and is now open to applications.",
          href,
          false,
          isEditing ? "View Details" : "View Case"
        );
      } catch (err) {
        console.error(err);
        showToast(err?.message || "Unable to post this case right now.", null, true);
        if (postBtn) postBtn.disabled = false;
      }
    }

    function showToastBanner(message, type = "info") {
      if (toastHelper?.show) {
        toastHelper.show(message, { targetId: "toastBanner", type });
      } else {
        alert(message);
      }
    }

    previewBtn?.addEventListener("click", openPreviewModal);
    closePreviewBtn?.addEventListener("click", closePreviewModal);
    previewModal?.addEventListener("click", (event) => {
      if (event.target === previewModal) closePreviewModal();
    });
    postBtn?.addEventListener("click", handlePost);

    function applyEditingCopy() {
      document.title = "Edit Case – Let’s-ParaConnect";
      const detailsHeader = document.querySelector('#create-step-details header h1');
      const detailsSub = document.querySelector('#create-step-details header p');
      const descHeader = document.querySelector('#create-step-description header h1');
      const descSub = document.querySelector('#create-step-description header p');
      const reviewHeader = document.querySelector('#create-step-review header h1');
      const reviewSub = document.querySelector('#create-step-review header p');
      const labelDetails = document.querySelectorAll('[data-step-link="details"] span');
      const labelDesc = document.querySelectorAll('[data-step-link="description"] span');
      const labelReview = document.querySelectorAll('[data-step-link="review"] span');
      detailsHeader && (detailsHeader.textContent = "Edit Case");
      detailsSub && (detailsSub.textContent = "Step 1: Update your case basics.");
      descHeader && (descHeader.textContent = "Edit Case");
      descSub && (descSub.textContent = "Step 2: Update the case description.");
      reviewHeader && (reviewHeader.textContent = "Review & Save Changes");
      reviewSub && (reviewSub.textContent = "Step 3: Confirm updates before saving.");
      labelDetails.forEach((el) => (el.textContent = "Case details"));
      labelDesc.forEach((el) => (el.textContent = "Description"));
      labelReview.forEach((el) => (el.textContent = "Review & Save"));
      if (postBtn) postBtn.textContent = "Save Changes";
      if (previewBtn) previewBtn.textContent = "Preview Updates";
    }

    function titleCaseWords(value = "") {
      return String(value)
        .toLowerCase()
        .split(/\s+/)
        .map((word) => (word ? word[0].toUpperCase() + word.slice(1) : ""))
        .join(" ")
        .trim();
    }

    function setSelectValue(select, value) {
      if (!select || !value) return;
      const raw = value.toString().trim();
      const target = raw.toLowerCase();
      const match = Array.from(select.options).find(
        (opt) => opt.value.toLowerCase() === target || opt.textContent.toLowerCase() === target
      );
      if (match) {
        select.value = match.value;
        return;
      }
      const option = document.createElement("option");
      option.value = raw;
      option.textContent = /[a-z]/i.test(raw) ? titleCaseWords(raw) : raw;
      select.appendChild(option);
      select.value = option.value;
    }

    function extractDescriptionFromCase(caseData = {}) {
      const raw = caseData.details || caseData.description || "";
      if (raw) return raw;
      const summary = String(caseData.briefSummary || "").trim();
      if (!summary) return "";
      if (/^state:/i.test(summary) || summary.includes("Engagement:") || summary.includes("Experience:")) {
        return "";
      }
      return summary;
    }

    function extractStateFromSummary(summary = "") {
      const match = String(summary).match(/State:\s*([^•]+)/i);
      if (!match) return "";
      return String(match[1] || "").trim();
    }

    function consumeEditPrefill(caseId) {
      if (!caseId) return null;
      try {
        const raw = sessionStorage.getItem(EDIT_PREFILL_KEY);
        if (!raw) return null;
        const payload = JSON.parse(raw);
        if (!payload || String(payload.caseId) !== String(caseId)) return null;
        sessionStorage.removeItem(EDIT_PREFILL_KEY);
        return payload.payload || null;
      } catch {
        return null;
      }
    }

    function mergeEditPrefill(prefill, data) {
      if (!prefill) return data;
      const summary = data?.briefSummary || prefill?.briefSummary || "";
      const merged = {
        ...prefill,
        ...data,
      };
      merged.practiceArea = data?.practiceArea || prefill?.practiceArea || "";
      const stateValue =
        data?.locationState ||
        data?.state ||
        prefill?.locationState ||
        prefill?.state ||
        extractStateFromSummary(summary);
      merged.state = stateValue;
      merged.locationState = stateValue;
      merged.details =
        data?.details ||
        data?.description ||
        prefill?.details ||
        prefill?.description ||
        "";
      merged.tasks =
        Array.isArray(data?.tasks) && data.tasks.length
          ? data.tasks
          : Array.isArray(prefill?.tasks)
          ? prefill.tasks
          : [];
      merged.totalAmount =
        typeof data?.totalAmount === "number"
          ? data.totalAmount
          : typeof prefill?.totalAmount === "number"
          ? prefill.totalAmount
          : data?.totalAmount || prefill?.totalAmount || 0;
      return merged;
    }

    function applyCaseDataToForm(caseData = {}) {
      if (fields.title) {
        fields.title.value = caseData.title || "";
        updateTitlePreview(fields.title.value);
      }
      setSelectValue(fields.specialty, caseData.practiceArea || caseData.field);
      const stateValue =
        caseData.locationState || caseData.state || extractStateFromSummary(caseData.briefSummary || "");
      setSelectValue(fields.state, stateValue);
      const amountCents = Number.isFinite(caseData.lockedTotalAmount)
        ? caseData.lockedTotalAmount
        : Number(caseData.totalAmount) || 0;
      if (fields.comp) {
        fields.comp.value = amountCents ? Math.round(amountCents / 100) : "";
      }
      const hasParalegal = !!(caseData.paralegal || caseData.paralegalId);
      const hasPendingInvites = Array.isArray(caseData.invites)
        ? caseData.invites.some((invite) => String(invite?.status || "pending").toLowerCase() === "pending")
        : false;
      const hasPendingParalegal = !!(caseData.pendingParalegal || caseData.pendingParalegalId);
      const isLocked =
        caseData.lockedTotalAmount != null || hasParalegal || hasPendingInvites || hasPendingParalegal;
      setCompLocked(isLocked);
      if (fields.experience && caseData.experience) {
        setSelectValue(fields.experience, caseData.experience);
      }
      const details = extractDescriptionFromCase(caseData);
      if (descriptionInput) {
        descriptionInput.value = details;
        updateDescriptionCount();
      }
      if (fields.deadline && caseData.deadline) {
        const iso = new Date(caseData.deadline).toISOString().slice(0, 10);
        fields.deadline.value = iso;
      }
      const incomingTasks = Array.isArray(caseData.tasks) ? caseData.tasks : [];
      tasksState.items = incomingTasks
        .map((task) => ({
          title: normalizeTaskTitle(typeof task === "string" ? task : task?.title),
        }))
        .filter((task) => task.title);
      const lockTasks = Boolean(caseData.tasksLocked || caseData.paralegal || caseData.paralegalId || caseData.hiredAt);
      setTasksLocked(lockTasks);
      latestCaseData = collectCaseData();
      hydrateReviewSummary();
      applyInitialStep();
    }

    async function loadExistingCase() {
      if (!editingCaseId) return;
      const prefill = consumeEditPrefill(editingCaseId);
      if (prefill) {
        applyCaseDataToForm(prefill);
      }
      try {
        const token = (window.getSessionToken && window.getSessionToken()) || "";
        const res = await fetch(`/api/cases/${encodeURIComponent(editingCaseId)}`, {
          headers: Object.assign({ Accept: "application/json" }, resolveAuthHeader(token)),
          credentials: "include",
        });
        const { data, text } = await readResponsePayload(res);
        if (!res.ok) {
          const message = data?.error || data?.msg || data?.message || (text && !text.includes("<") ? text : "");
          const statusNote = res.status ? ` (HTTP ${res.status})` : "";
          throw new Error(message || `Unable to load this case for editing.${statusNote}`);
        }
        const merged = mergeEditPrefill(prefill, data);
        applyCaseDataToForm(merged);
      } catch (err) {
        console.warn("Edit case load failed", err);
        if (!prefill) {
          showToastBanner(err?.message || "Unable to load this case for editing.", "error");
        }
      }
    }

    async function updateCase(caseId, payload) {
      const token = (window.getSessionToken && window.getSessionToken()) || "";
      if (!token) {
        window.checkSession?.("attorney");
        throw new Error("Please log in again before saving changes.");
      }
      await fetchCsrfToken();
      const res = await fetch(`/api/cases/${encodeURIComponent(caseId)}`, {
        method: "PATCH",
        suppressToast: true,
        credentials: "include",
        headers: {
          "Content-Type": "application/json",
          ...resolveAuthHeader(token),
          "X-CSRF-Token": csrfToken || "",
          Accept: "application/json",
        },
        body: JSON.stringify(payload),
      });
      const { data, text } = await readResponsePayload(res);
      if (!res.ok) {
        const message = data?.error || data?.msg || data?.message || (text && !text.includes("<") ? text : "");
        const statusNote = res.status ? ` (HTTP ${res.status})` : "";
        throw new Error(message || `Unable to save changes to this case.${statusNote}`);
      }
      return data;
    }

    if (isEditing) {
      clearDraft();
      applyEditingCopy();
      void loadExistingCase();
    }
  })();
  </script>
  <script src="assets/scripts/create-case-nav.js"></script>
</body>
</html>
