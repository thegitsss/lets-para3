<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Register as Attorney | Lets-ParaConnect</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;600&family=Source+Sans+Pro:wght@400;600&display=swap" rel="stylesheet" />

  <!-- reCAPTCHA (optional). If unused, you can remove this <script> and the widget div. -->
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>

  <!-- CSRF bootstrap + role helpers (this file should warm __CSRF__) -->
  <script type="module" src="assets/scripts/auth.js"></script>

  <style>
    :root{
      --navy:#27394d; --ink:#1f242b; --gold:#b4975a; --bg:#f5f2ed; --line:#e8edf3;
      --ok:#1f7a4a; --bad:#b04747;
    }
    *{ box-sizing:border-box }
    body{
      margin:0; min-height:100vh; display:flex; flex-direction:column; background:var(--bg);
      color:var(--ink); font-family:'Source Sans Pro', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    header, footer{ background:var(--navy); color:#fff; text-align:center; padding:1rem }
    header .brand{ display:inline-flex; align-items:center; gap:.6rem; font-family:'EB Garamond',serif; font-weight:600; letter-spacing:.2px }
    header img{ height:44px }
    main{ flex:1; display:grid; place-items:center; padding:2rem }

    .card{
      width:min(520px,94vw); background:rgba(39,57,77,.9); color:#fff; border-radius:14px;
      box-shadow:0 16px 40px rgba(0,0,0,.28); padding:1.5rem 1.6rem 1.25rem; animation:pop .5s ease;
    }
    .card h2{ margin:.2rem 0 1rem; font-family:'EB Garamond',serif; font-weight:600; text-align:center }

    label{ display:block; font-size:.95rem; margin:.35rem 0 .35rem; opacity:.95 }
    input, select{
      width:100%; padding:.7rem .85rem; border:1px solid rgba(255,255,255,.2); background:rgba(255,255,255,.08);
      border-radius:10px; color:#fff; outline:none; transition:border-color .2s, box-shadow .2s;
    }
    input::placeholder{ color:#d9dee6 }
    input:focus, select:focus{ border-color:#fff; box-shadow:0 0 0 3px rgba(255,255,255,.18) }

    .pw-wrap{ position:relative }
    .toggle{
      position:absolute; right:.6rem; top:50%; transform:translateY(-50%); cursor:pointer; user-select:none;
      font-size:.92rem; color:#f1f5f9; opacity:.85;
    }

    .hint{ font-size:.85rem; color:#e8e9ed; opacity:.9; margin:.15rem 0 .4rem }
    .errors{ color:#ffe4d6; background:rgba(176,71,71,.15); border:1px solid rgba(176,71,71,.35); padding:.6rem .7rem; border-radius:8px; margin:.3rem 0 .6rem; display:none }
    .ok{ color:#e6ffef; background:rgba(31,122,74,.15); border:1px solid rgba(31,122,74,.35); padding:.6rem .7rem; border-radius:8px; margin:.4rem 0 .6rem; display:none }

    .meter{ height:6px; border-radius:999px; background:rgba(255,255,255,.18); overflow:hidden; margin:.35rem 0 .2rem }
    .meter > i{ display:block; height:100%; width:0%; background:linear-gradient(90deg,#b04747,#ffb347,#1f7a4a); transition: width .25s ease }
    .meter-label{ font-size:.85rem; opacity:.9 }

    /* Dropzones */
    .drop{
      border:2px dashed rgba(255,255,255,.35); border-radius:12px; padding:1rem; text-align:center;
      background:rgba(255,255,255,.05); transition: border-color .2s ease, background .2s ease;
    }
    .drop.dragover{ border-color:#fff; background:rgba(255,255,255,.1); }
    .drop .actions { display:flex; gap:.5rem; justify-content:center; margin-top:.7rem; flex-wrap:wrap }
    .drop .btn { background:#fff; color:var(--navy); border:0; border-radius:10px; padding:.55rem .9rem; cursor:pointer; font-weight:600 }
    .drop small { display:block; opacity:.85; margin-top:.35rem }

    .file-row{ display:flex; align-items:center; justify-content:space-between; gap:.6rem; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.2); padding:.6rem .7rem; border-radius:10px; margin-top:.6rem }
    .file-row .name{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .file-row .controls{ display:flex; gap:.4rem }
    .link-btn{ background:transparent; color:#fff; border:1px solid rgba(255,255,255,.5); border-radius:8px; padding:.35rem .6rem; cursor:pointer }

    .actions{ margin-top:.8rem }
    button[type="submit"]{
      width:100%; padding:.9rem 1rem; background:#fff; color:var(--navy); border:0; border-radius:10px; font-weight:600; cursor:pointer;
      transition:transform .15s ease, box-shadow .2s ease, opacity .2s ease;
    }
    button[type="submit"]:hover{ transform:translateY(-1px); box-shadow:0 8px 18px rgba(0,0,0,.18) }
    button:disabled{ opacity:.6; cursor:not-allowed; transform:none; box-shadow:none }

    footer a{ color:#fff; text-decoration:none; margin:0 .5rem; opacity:.9 }
    footer a:hover{ opacity:1 }

    @keyframes pop{ from{ transform:translateY(6px); opacity:0 } to{ transform:none; opacity:1 } }
  </style>
</head>

<body>
  <header>
    <div class="brand">
      <img src="assets/transparant logo only.png" alt="Logo" />
      <span>Lets-ParaConnect</span>
    </div>
  </header>

  <main>
    <section class="card" role="region" aria-labelledby="title">
      <h2 id="title">Register as an Attorney</h2>

      <div class="errors" id="errors" role="alert" aria-live="polite"></div>
      <div class="ok" id="ok" aria-live="polite"></div>

      <form id="regForm" novalidate>
        <label for="name">Full Name</label>
        <input id="name" name="name" autocomplete="name" placeholder="Jordan A. Attorney" required />

        <label for="email">Email</label>
        <input id="email" name="email" type="email" inputmode="email" autocomplete="email" placeholder="you@example.com" required />

        <label for="password">Password</label>
        <div class="pw-wrap">
          <input id="password" name="password" type="password" autocomplete="new-password" placeholder="8+ chars, mix letters & numbers" required />
          <span class="toggle" id="showPw" role="button" tabindex="0" aria-controls="password" aria-label="Toggle password visibility">Show</span>
        </div>
        <div class="meter" aria-hidden="true"><i id="pwBar"></i></div>
        <div class="meter-label" id="pwLabel">Password strength: —</div>

        <label for="bar">State Bar Number</label>
        <input id="bar" name="bar" placeholder="e.g., 0123456" required />

        <!-- Resume upload -->
        <label>Resume (PDF, optional)</label>
        <div id="dropResume" class="drop" tabindex="0" aria-label="Resume upload dropzone">
          <div>Drag & drop PDF here, or</div>
          <div class="actions">
            <button type="button" class="btn" id="pickResume">Choose PDF</button>
            <small>Max 5&nbsp;MB</small>
          </div>
          <input id="fileInputResume" type="file" accept="application/pdf" hidden />
        </div>
        <div id="fileRowResume" class="file-row" style="display:none;">
          <div class="name" id="fileNameResume"></div>
          <div class="controls">
            <a class="link-btn" id="viewResume" href="#" target="_blank" rel="noopener">View</a>
            <button type="button" class="link-btn" id="removeResume">Remove</button>
          </div>
        </div>
        <div class="hint" id="uploadStatusResume" style="display:none;"></div>

        <!-- Certificate upload -->
        <label>Bar/Credential (PDF/JPG/PNG, optional)</label>
        <div id="dropCert" class="drop" tabindex="0" aria-label="Certificate upload dropzone">
          <div>Drag & drop file here, or</div>
          <div class="actions">
            <button type="button" class="btn" id="pickCert">Choose File</button>
            <small>PDF/JPG/PNG • Max 5&nbsp;MB</small>
          </div>
          <input id="fileInputCert" type="file" accept="application/pdf,image/png,image/jpeg" hidden />
        </div>
        <div id="fileRowCert" class="file-row" style="display:none;">
          <div class="name" id="fileNameCert"></div>
          <div class="controls">
            <a class="link-btn" id="viewCert" href="#" target="_blank" rel="noopener">View</a>
            <button type="button" class="link-btn" id="removeCert">Remove</button>
          </div>
        </div>
        <div class="hint" id="uploadStatusCert" style="display:none;"></div>

        <!-- Optional reCAPTCHA widget -->
        <div class="g-recaptcha" data-sitekey="<!-- paste site key or remove this div -->"></div>

        <div class="actions">
          <button id="submitBtn" type="submit">Register</button>
        </div>
        <div class="hint" style="margin-top:.6rem;">You’ll receive an email after admin review.</div>
      </form>
    </section>
  </main>

  <footer>
    <div>
      <a href="terms.html">Terms</a> • <a href="privacy.html">Privacy</a> • <a href="login.html">Login</a>
    </div>
    <div style="margin-top:.35rem; opacity:.85;">© <script>document.write(new Date().getFullYear())</script> Lets-ParaConnect</div>
  </footer>

  <script>
    // ---------- Config ----------
    const API_BASE = location.origin + '/api';
    const MAX_MB = 5;

    // Prime CSRF (auth.js should do this too; harmless to double-call)
    fetch('/api/csrf', { credentials:'include' })
      .then(r=>r.json()).then(d=> window.__CSRF__ = d.csrfToken)
      .catch(()=>{});

    // ---------- Elements ----------
    const form = document.getElementById('regForm');
    const errors = document.getElementById('errors');
    const ok = document.getElementById('ok');
    const submitBtn = document.getElementById('submitBtn');

    const nameEl = document.getElementById('name');
    const emailEl = document.getElementById('email');
    const pwEl = document.getElementById('password');
    const barEl = document.getElementById('bar');

    const pwBar = document.getElementById('pwBar');
    const pwLabel = document.getElementById('pwLabel');
    const showPwBtn = document.getElementById('showPw');

    // ---------- Password helpers ----------
    function scorePassword(pw){
      let s = 0; if (!pw) return 0;
      if (pw.length >= 8) s += 30;
      if (/[A-Z]/.test(pw)) s += 20;
      if (/[a-z]/.test(pw)) s += 20;
      if (/\d/.test(pw)) s += 20;
      if (/[^A-Za-z0-9]/.test(pw)) s += 10;
      return Math.min(100, s);
    }
    function updateMeter(){
      const n = scorePassword(pwEl.value);
      pwBar.style.width = n + '%';
      pwLabel.textContent = 'Password strength: ' + (n<35 ? 'Weak' : n<70 ? 'Okay' : 'Strong');
    }
    pwEl.addEventListener('input', updateMeter); updateMeter();

    // Toggle PW visibility (click or keyboard)
    function togglePwVis(){
      const isPw = pwEl.type === 'password';
      pwEl.type = isPw ? 'text' : 'password';
      showPwBtn.textContent = isPw ? 'Hide' : 'Show';
    }
    showPwBtn.addEventListener('click', togglePwVis);
    showPwBtn.addEventListener('keydown', (e)=>{ if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); togglePwVis(); } });

    // ---------- Messaging ----------
    function showError(msgs){
      errors.style.display = msgs ? 'block' : 'none';
      ok.style.display = 'none';
      if (!msgs) { errors.innerHTML = ''; return; }
      errors.innerHTML = Array.isArray(msgs) ? msgs.map(m=>`<div>• ${m}</div>`).join('') : msgs;
    }
    function showOk(text){
      ok.style.display = 'block';
      errors.style.display = 'none';
      ok.textContent = text || 'Submitted.';
    }
    const validEmail = (e) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e||'');

    async function maybeGetRecaptcha(){
      try {
        if (window.grecaptcha && typeof grecaptcha.getResponse === 'function') {
          return grecaptcha.getResponse() || '';
        }
      } catch {}
      return '';
    }

    // ---------- Upload helpers ----------
    async function uploadFile(file, kind){
      const fd = new FormData();
      fd.append('file', file);
      fd.append('folder', kind === 'resume' ? 'resumes' : 'certificates');

      const headers = { 'X-CSRF-Token': window.__CSRF__ || '' };
      const endpoints = [
        `${API_BASE}/uploads/${kind}`,   // /uploads/resume or /uploads/certificate
        `${API_BASE}/uploads`            // fallback
      ];

      let lastErr;
      for (const ep of endpoints) {
        try {
          const r = await fetch(ep, { method:'POST', body: fd, credentials:'include', headers });
          let data = {}; try { data = await r.json(); } catch {}
          if (r.ok) {
            return data.url || data.publicUrl || data.path || data.file?.url || data.location || null;
          }
          lastErr = new Error(data?.msg || data?.message || `Upload failed (${r.status})`);
        } catch (e) { lastErr = e; }
      }
      throw lastErr || new Error('Upload failed');
    }

    // ---------- Resume dropzone ----------
    const dropResume = document.getElementById('dropResume');
    const pickResume = document.getElementById('pickResume');
    const fileInputResume = document.getElementById('fileInputResume');
    const fileRowResume = document.getElementById('fileRowResume');
    const fileNameResume = document.getElementById('fileNameResume');
    const viewResume = document.getElementById('viewResume');
    const removeResume = document.getElementById('removeResume');
    const uploadStatusResume = document.getElementById('uploadStatusResume');

    let resumeFile = null, resumePreview = null, resumeURL = null;

    pickResume.addEventListener('click', ()=> fileInputResume.click());
    fileInputResume.addEventListener('change', ()=> handleResume(fileInputResume.files?.[0]));
    ['dragenter','dragover'].forEach(ev => dropResume.addEventListener(ev, (e)=>{ e.preventDefault(); dropResume.classList.add('dragover'); }));
    ['dragleave','drop'].forEach(ev => dropResume.addEventListener(ev, (e)=>{ e.preventDefault(); dropResume.classList.remove('dragover'); }));
    dropResume.addEventListener('drop', (e)=> {
      const f = e.dataTransfer.files && e.dataTransfer.files[0];
      if (f) handleResume(f);
    });
    // Keyboard open
    dropResume.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); fileInputResume.click(); }
    });

    function handleResume(f){
      const errs = [];
      if (!f) return;
      if (f.type !== 'application/pdf' && !/\.pdf$/i.test(f.name)) errs.push('Resume must be a PDF.');
      if (f.size > MAX_MB * 1024 * 1024) errs.push(`Resume max size is ${MAX_MB} MB.`);
      if (errs.length) { showError(errs); return; }
      showError('');

      resumeFile = f; resumeURL = null;
      if (resumePreview) URL.revokeObjectURL(resumePreview);
      resumePreview = URL.createObjectURL(f);
      fileNameResume.textContent = f.name + ` (${(f.size/1024/1024).toFixed(2)} MB)`;
      viewResume.href = resumePreview;
      fileRowResume.style.display = '';
      uploadStatusResume.style.display = 'none';
    }
    removeResume.addEventListener('click', ()=>{
      resumeFile = null; resumeURL = null;
      fileRowResume.style.display = 'none';
      fileInputResume.value = '';
      if (resumePreview) { URL.revokeObjectURL(resumePreview); resumePreview = null; }
    });

    // ---------- Certificate dropzone ----------
    const dropCert = document.getElementById('dropCert');
    const pickCert = document.getElementById('pickCert');
    const fileInputCert = document.getElementById('fileInputCert');
    const fileRowCert = document.getElementById('fileRowCert');
    const fileNameCert = document.getElementById('fileNameCert');
    const viewCert = document.getElementById('viewCert');
    const removeCert = document.getElementById('removeCert');
    const uploadStatusCert = document.getElementById('uploadStatusCert');

    let certFile = null, certPreview = null, certURL = null;

    pickCert.addEventListener('click', ()=> fileInputCert.click());
    fileInputCert.addEventListener('change', ()=> handleCert(fileInputCert.files?.[0]));
    ['dragenter','dragover'].forEach(ev => dropCert.addEventListener(ev, (e)=>{ e.preventDefault(); dropCert.classList.add('dragover'); }));
    ['dragleave','drop'].forEach(ev => dropCert.addEventListener(ev, (e)=>{ e.preventDefault(); dropCert.classList.remove('dragover'); }));
    dropCert.addEventListener('drop', (e)=> {
      const f = e.dataTransfer.files && e.dataTransfer.files[0];
      if (f) handleCert(f);
    });
    // Keyboard open
    dropCert.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); fileInputCert.click(); }
    });

    function handleCert(f){
      const errs = [];
      if (!f) return;
      const okTypes = ['application/pdf','image/png','image/jpeg'];
      if (!okTypes.includes(f.type) && !/\.(pdf|png|jpe?g)$/i.test(f.name)) errs.push('Certificate must be PDF, JPG, or PNG.');
      if (f.size > MAX_MB * 1024 * 1024) errs.push(`Certificate max size is ${MAX_MB} MB.`);
      if (errs.length) { showError(errs); return; }
      showError('');

      certFile = f; certURL = null;
      if (certPreview) URL.revokeObjectURL(certPreview);
      certPreview = URL.createObjectURL(f);
      fileNameCert.textContent = f.name + ` (${(f.size/1024/1024).toFixed(2)} MB)`;
      viewCert.href = certPreview;
      fileRowCert.style.display = '';
      uploadStatusCert.style.display = 'none';
    }
    removeCert.addEventListener('click', ()=>{
      certFile = null; certURL = null;
      fileRowCert.style.display = 'none';
      fileInputCert.value = '';
      if (certPreview) { URL.revokeObjectURL(certPreview); certPreview = null; }
    });

    // ---------- Submit flow ----------
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();

      // Normalize + validate
      const errs = [];
      const name = (nameEl.value||'').trim();
      const email = (emailEl.value||'').trim().toLowerCase();
      const password = pwEl.value||'';
      const barNumber = (barEl.value||'').trim();

      if (!name) errs.push('Full name is required.');
      if (!validEmail(email)) errs.push('Enter a valid email address.');
      if (scorePassword(password) < 35) errs.push('Use 8+ chars with a mix of letters/numbers.');
      if (!barNumber) errs.push('State Bar Number is required.');
      if (errs.length){ showError(errs); return; }

      const rcToken = await maybeGetRecaptcha();
      if (document.querySelector('.g-recaptcha') && window.grecaptcha && !rcToken) {
        showError('Please verify you are not a robot.'); return;
      }

      showError(''); ok.style.display='none';
      submitBtn.disabled = true; submitBtn.textContent = 'Submitting…';

      // 1) Upload files first (if any)
      try {
        if (resumeFile && !resumeURL) {
          uploadStatusResume.style.display='block';
          uploadStatusResume.textContent='Uploading resume…';
          resumeURL = await uploadFile(resumeFile, 'resume');
          if (!resumeURL) throw new Error('Server did not return resume URL.');
          uploadStatusResume.textContent='Resume uploaded ✓';
        }
        if (certFile && !certURL) {
          uploadStatusCert.style.display='block';
          uploadStatusCert.textContent='Uploading credential…';
          certURL = await uploadFile(certFile, 'certificate');
          if (!certURL) throw new Error('Server did not return credential URL.');
          uploadStatusCert.textContent='Credential uploaded ✓';
        }
      } catch (err) {
        submitBtn.disabled = false; submitBtn.textContent = 'Register';
        showError(err.message || 'File upload failed. You can submit without files or try again.');
        return;
      }

      // 2) Submit application
      const payload = {
        name, email, password, role:'attorney',
        barNumber,
        resumeURL: resumeURL || undefined,
        certificateURL: certURL || undefined,
        recaptchaToken: rcToken || undefined
      };

      try {
        const res = await fetch(API_BASE + '/auth/register', {
          method:'POST',
          credentials:'include',
          headers:{
            'Content-Type':'application/json',
            'X-CSRF-Token': window.__CSRF__ || ''
          },
          body: JSON.stringify(payload)
        });
        let data={}; try{ data = await res.json(); }catch{}

        if (!res.ok) {
          if (res.status === 409) throw new Error('That email is already registered.');
          if (res.status === 429) throw new Error('Too many attempts. Please wait a minute and try again.');
          throw new Error(data?.msg || data?.message || 'Registration failed.');
        }

        showOk('Application submitted. Await admin approval.');
        submitBtn.textContent = 'Submitted';
        setTimeout(()=> { window.location.href = 'login.html'; }, 1500);
      } catch (err) {
        if (err?.name === 'TypeError') {
          showError('Network error. Check your connection and try again.');
        } else {
          showError(err.message || 'Could not submit application.');
        }
        submitBtn.disabled = false; submitBtn.textContent = 'Register';
      }
    });
  </script>
</body>
</html>
```
