<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta name="theme-color" content="#0B2A4A">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Let’s-ParaConnect | Stripe Billing & Payments</title>
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png" />
  <link rel="icon" href="/favicon.ico" />
  <link rel="shortcut icon" href="/favicon.ico" />
  <link rel="manifest" href="site.webmanifest" />
  <link rel="mask-icon" href="maskable-icon.png" color="#0B2A4A" />

  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@200&family=Cormorant+Garamond:wght@300;600&display=swap" rel="stylesheet" />
  <script src="assets/scripts/utils/session.js"></script>
  <style>
    .gold{color:#b4975a;}
    :root {
      --bg: #ffffff;
      --sidebar-bg: #f5f5f5e6;
      --accent: #b6a47a;
      --ink: #1a1a1a;
      --muted: #8a8a8a;
      --line: rgba(0, 0, 0, 0.08);
      --panel: #fcfcfc;
      --radius: 14px;
      --font-serif: 'Cormorant Garamond', serif;
      --font-sans: 'Sarabun', sans-serif;
      --sidebar-text:#1a1a1a;
    }
    body.theme-dark{
      --bg:#0f172a;
      --sidebar-bg:#1c2333;
      --panel:#151b29;
      --ink:#f5f6fb;
      --muted:#9aa7c4;
      --line:rgba(255,255,255,0.08);
      --sidebar-text:#f8fbff;
    }
    body.theme-mountain{
      --bg:#f8f6f1;
      --panel:#ffffff;
      --muted:#7a736a;
      --sidebar-text:#ffffff;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-sans);
      font-weight: 200;
      background: var(--bg);
      color: var(--ink);
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 240px;
      background: var(--sidebar-bg);
      display: flex;
      flex-direction: column;
      border-right: 1px solid var(--line);
      padding: 24px 16px;
      color:var(--sidebar-text);
      position:relative;
    }
    .sidebar::before{
      content:"";
      position:absolute;
      inset:0;
      background:transparent;
      pointer-events:none;
      transition:background .3s ease;
    }
    body.theme-mountain .sidebar{
      background:url('hero-mountain.jpg') center/cover no-repeat;
    }
    body.theme-mountain .sidebar::before{
      background:rgba(0,0,0,0.45);
    }
    body.theme-mountain .sidebar > *{
      position:relative;
      z-index:1;
    }

    .logo {
      font-family: var(--font-serif);
      font-size: 1.6rem;
      font-weight: 300;
      letter-spacing: 0.5px;
      margin-bottom: 36px;
      text-align: center;
    }

    nav {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    nav a {
      text-decoration: none;
      color: var(--sidebar-text);
      font-weight: 200;
      font-size: 0.95rem;
      padding: 10px 14px;
      border-radius: var(--radius);
      transition: background 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }

    nav a.active,
    nav a:hover {
      background: rgba(0, 0, 0, 0.04);
    }
    body.theme-dark nav a.active,
    body.theme-dark nav a:hover{background:rgba(255,255,255,0.12);}
    body.theme-mountain nav a.active,
    body.theme-mountain nav a:hover{background:rgba(255,255,255,0.18);}
    body.theme-mountain nav a{color:#fff;}

    .sidebar-link {
      margin-top: 1.5rem;
      width: 100%;
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 0.6rem 1rem;
      background: transparent;
      font-size: 0.9rem;
      font-family: var(--font-sans);
      color:var(--sidebar-text);
      cursor: pointer;
      transition: background 0.2s ease, color 0.2s ease;
    }

    .sidebar-link:hover,
    .sidebar-link:focus {
      background: rgba(0, 0, 0, 0.05);
      color: var(--accent);
      outline: none;
    }
    body.theme-dark .sidebar-link:hover,
    body.theme-dark .sidebar-link:focus,
    body.theme-mountain .sidebar-link:hover,
    body.theme-mountain .sidebar-link:focus{
      color:#fff;
    }
    body.theme-mountain .sidebar-link{color:#fff;}

    .sidebar-bottom{
      margin-top:auto;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .sidebar-footer{
      font-size:0.7rem;
      color:var(--muted);
      text-align:center;
    }

    .main {
      flex: 1;
      padding: 40px;
      overflow-y: auto;
      background: var(--bg);
    }

    .topbar {
      margin-bottom: 2rem;
      display:flex;
      justify-content:flex-end;
      align-items:center;
      gap:1.5rem;
    }

    .notification-icon {
      width: 46px;
      height: 46px;
      border-radius: 50%;
      border: 1px solid var(--line);
      display: flex;
      justify-content: center;
      align-items: center;
      background: var(--panel);
      cursor: pointer;
      position: relative;
      transition: border-color 0.2s ease, transform 0.2s ease;
    }

    .notification-icon:hover {
      border-color: var(--accent);
      transform: translateY(-1px);
    }

    .notification-icon svg {
      width: 22px;
      height: 22px;
      color: var(--ink);
    }
    body.theme-dark .notification-icon svg{color:#f8fbff;}

    .notification-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      background: #c0392b;
      color: #fff;
      font-size: 0.75rem;
      border-radius: 999px;
      padding: 2px 6px;
      line-height: 1;
      display: none;
      font-weight: 600;
    }

    .notification-badge.show {
      display: inline-flex;
    }

    .user-profile{
      display:flex;
      align-items:center;
      gap:12px;
      padding:8px 12px;
      border-radius:999px;
      background:rgba(255,255,255,0.6);
      border:1px solid rgba(255,255,255,0.4);
      backdrop-filter:blur(14px);
      -webkit-backdrop-filter:blur(14px);
      transition:border-color 0.2s ease,box-shadow .2s ease;
      cursor:pointer;
      position:relative;
    }
    .user-profile img{
      width:44px;
      height:44px;
      border-radius:50%;
      border:2px solid #fff;
      box-shadow:0 4px 16px rgba(0,0,0,0.08);
      object-fit:cover;
    }
    .user-profile strong{display:block;font-weight:200;color:var(--ink);}
    .user-profile span{font-size:0.85rem;color:var(--muted);}
    body.theme-dark .user-profile{
      background:rgba(15,23,42,0.4);
      border-color:rgba(255,255,255,0.15);
      box-shadow:0 10px 25px rgba(0,0,0,0.35);
    }
    body.theme-dark .user-profile strong{color:#fff;}
    body.theme-dark .user-profile span{color:rgba(255,255,255,0.8);}
    body.theme-mountain .user-profile{
      background:rgba(255,255,255,0.65);
      border-color:rgba(255,255,255,0.42);
      box-shadow:0 18px 34px rgba(17,22,26,0.2);
    }
    body.theme-mountain .user-profile strong{color:#fff;}
    body.theme-mountain .user-profile span{color:rgba(255,255,255,0.85);}

    .page-header {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
      justify-content: space-between;
      align-items: flex-end;
      margin-bottom: 2rem;
    }

    .page-header h1 {
      font-family: var(--font-serif);
      font-weight: 300;
      font-size: 2.3rem;
      margin-bottom: 0.4rem;
    }

    .page-header p {
      color: var(--muted);
      max-width: 540px;
      font-size: 0.95rem;
    }

    .page-header .actions {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .primary-btn {
      border: none;
      border-radius: 999px;
      padding: 0.75rem 1.5rem;
      background: var(--accent);
      color: #fff;
      font-weight: 300;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
      box-shadow: 0 12px 24px rgba(0,0,0,0.12);
    }

    .primary-btn:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 16px 28px rgba(0, 0, 0, 0.15);
      background: #9c8a63;
    }

    .primary-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
    }

    .panel {
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: var(--panel);
      padding: 1.5rem;
      margin-bottom: 2rem;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 1.25rem;
    }

    .panel-header h2 {
      font-family: var(--font-serif);
      font-size: 1.6rem;
      font-weight: 300;
      margin-bottom: 0.35rem;
    }

    .panel-header p {
      color: var(--muted);
      font-size: 0.95rem;
    }

    .history-list {
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
    }

    .history-card {
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: var(--panel);
      padding: 1.25rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .history-primary {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .history-primary .case-name {
      font-family: var(--font-serif);
      font-size: 1.45rem;
      font-weight: 300;
    }

    .history-primary .job-title {
      color: var(--muted);
      font-size: 1rem;
    }

    .history-primary .paralegal-name {
      font-size: 0.95rem;
      color: var(--ink);
    }

    .history-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
    }

    .meta-item span {
      display: block;
      text-transform: uppercase;
      font-size: 0.7rem;
      color: var(--muted);
      letter-spacing: 0.08em;
      margin-bottom: 0.3rem;
    }

    .meta-item strong {
      font-size: 1.2rem;
      font-weight: 300;
    }

    .history-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
    }

    .history-actions .link-button {
      text-decoration: none;
      color: var(--accent);
      font-weight: 300;
    }

    .history-actions button {
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 0.45rem 1.25rem;
      background: var(--panel);
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .history-actions button:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.09);
    }

    .finance-alerts {
      display: flex;
      flex-direction: column;
      gap: 0.85rem;
      margin-bottom: 2rem;
    }

    .finance-alerts .finance-alert {
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: var(--panel);
      padding: 1.1rem 1.25rem;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 0.85rem;
    }

    .finance-alert .alert-title {
      font-family: var(--font-serif);
      font-size: 1.15rem;
      font-weight: 300;
      margin-bottom: 0.15rem;
    }

    .finance-alert p {
      margin: 0;
      font-size: 0.95rem;
      color: var(--muted);
    }

    .finance-alert .alert-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
    }

    .pill-btn {
      border-radius: 999px;
      border: 1px solid var(--line);
      padding: 0.45rem 1.25rem;
      background: var(--panel);
      color: var(--ink);
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 300;
      letter-spacing: 0.02em;
      transition: background 0.2s ease, border-color 0.2s ease, transform 0.15s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 120px;
    }

    .pill-btn:hover {
      transform: translateY(-1px);
      border-color: var(--accent);
      background: rgba(182, 164, 122, 0.08);
    }

    .pill-btn.primary {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }

    .pill-btn.primary:hover {
      background: #9c8a63;
      border-color: #9c8a63;
    }

    .ghost-btn {
      border: 1px solid var(--line);
      background: var(--panel);
      border-radius: 999px;
      padding: 0.4rem 1.1rem;
      cursor: pointer;
      font-size: 0.85rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .ghost-btn:hover {
      border-color: var(--accent);
      color: var(--ink);
    }

    .table-wrapper {
      overflow-x: auto;
    }

    .escrow-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 640px;
    }

    .escrow-table th,
    .escrow-table td {
      padding: 0.75rem 0.5rem;
      text-align: left;
      border-bottom: 1px solid var(--line);
      background: var(--panel);
    }

    .escrow-table th {
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.08em;
      color: var(--muted);
      background: var(--panel);
    }

    .escrow-table td .pill {
      display: inline-flex;
      align-items: center;
      padding: 0.15rem 0.65rem;
      border-radius: 999px;
      background: rgba(182, 164, 122, 0.15);
      color: var(--ink);
      font-size: 0.8rem;
    }

    .action-drawer {
      position: relative;
      display: inline-flex;
    }

    .action-toggle {
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 0.4rem 1.2rem;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      background: var(--panel);
      cursor: pointer;
      font-size: 0.85rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .action-drawer.open .action-toggle {
      border-color: var(--accent);
      color: var(--accent);
    }

    .action-menu {
      position: absolute;
      top: calc(100% + 6px);
      right: 0;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 12px;
      box-shadow: 0 15px 40px rgba(15, 23, 42, 0.15);
      padding: 0.65rem;
      display: none;
      flex-direction: column;
      min-width: 180px;
      z-index: 40;
    }

    .action-drawer.open .action-menu {
      display: flex;
    }

    .action-menu button {
      border: none;
      background: transparent;
      padding: 0.5rem 0.35rem;
      border-radius: 8px;
      font-size: 0.9rem;
      text-align: left;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .action-menu button:hover {
      background: rgba(182, 164, 122, 0.12);
    }

    .history-empty {
      text-align: center;
      color: var(--muted);
      padding: 2rem 1rem;
      border: 1px dashed var(--line);
      border-radius: var(--radius);
      background: var(--panel);
    }

    .history-empty.error {
      color: #c0392b;
      border-color: rgba(192, 57, 43, 0.4);
    }

    .muted {
      color: var(--muted);
    }

    .toast {
      position: fixed;
      left: 50%;
      bottom: 30px;
      transform: translate(-50%, 20px);
      background: rgba(17, 17, 17, 0.92);
      color: #fff;
      padding: 0.85rem 1.25rem;
      border-radius: 12px;
      font-size: 0.9rem;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease, transform 0.25s ease;
      z-index: 3000;
    }

    .toast.show {
      opacity: 1;
      transform: translate(-50%, 0);
    }

    @media (max-width: 960px) {
      body {
        flex-direction: column;
      }
      .sidebar {
        width: 100%;
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: center;
        border-right: none;
        border-bottom: 1px solid var(--line);
      }
      nav {
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: center;
      }
      .main {
        padding: 24px;
      }
      .history-meta {
        gap: 1rem;
      }
    }
  </style>
</head>
<body>
  <aside class="sidebar">
    <div class="logo">Dashboard</div>
    <nav>
      <a href="dashboard-attorney.html">Home</a>
      <a href="active-cases.html">Cases &amp; Files</a>
      <a href="billing-attorney.html" class="active">Escrow</a>
      <a href="help.html">Help</a>
    </nav>
    <div class="sidebar-bottom">
      <button type="button" class="sidebar-link" id="logoutBtn">Log Out</button>
      <div class="sidebar-footer">© Let’s‑ParaConnect 2025</div>
    </div>
  </aside>
  <main class="main">
    <div class="topbar" data-attorney-header></div>
    <header class="page-header">
      <div>
        <h1>Billing &amp; Escrow</h1>
        <p>Manage invoices, receipts, and escrow releases without leaving your dashboard.</p>
      </div>
      <div class="actions">
        <button type="button" class="primary-btn" id="openPortalBtn">Open Stripe Billing Portal</button>
      </div>
    </header>

    <section id="financeAlerts" class="finance-alerts" aria-live="polite"></section>

    <section class="panel" aria-labelledby="escrow-heading">
      <div class="panel-header">
        <div>
          <h2 id="escrow-heading">Active Escrow</h2>
          <p>Funds currently held in trust for ongoing cases.</p>
        </div>
        <button type="button" class="ghost-btn" id="refreshEscrowsBtn">Refresh</button>
      </div>
      <div class="table-wrapper">
        <table class="escrow-table" aria-describedby="escrow-heading">
          <thead>
            <tr>
              <th>Case</th>
              <th>Paralegal</th>
              <th>Held Amount</th>
              <th>Funded</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="escrowTableBody">
            <tr><td colspan="6" class="history-empty">Loading active escrows…</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <section class="panel" aria-labelledby="history-heading">
      <div class="panel-header">
        <div>
          <h2 id="history-heading">Completed Assignments</h2>
          <p>Receipts for every completed job. Click any record to jump back into its case file.</p>
        </div>
      </div>
      <div id="historyList" class="history-list">
        <div class="history-empty">Loading payment history…</div>
      </div>
    </section>
  </main>

  <div id="toastBanner" class="toast" role="status" aria-live="polite"></div>
  <script src="assets/scripts/utils/toast.js"></script>
  <script>
    window.__ATTORNEY_PAGE__ = "billing";
  </script>
  <script type="module" src="assets/scripts/attorney-tabs.js"></script>
  <script type="module">
    import { requireAuth, secureFetch } from "./assets/scripts/auth.js";

    const historyList = document.getElementById("historyList");
    const portalBtn = document.getElementById("openPortalBtn");
    const financeAlertsEl = document.getElementById("financeAlerts");
    const escrowTableBody = document.getElementById("escrowTableBody");
    const refreshEscrowsBtn = document.getElementById("refreshEscrowsBtn");
    const currencyFormatter = new Intl.NumberFormat(undefined, { style: "currency", currency: "USD" });

    let cachedEscrows = [];
    let openDrawerEl = null;

    init();

    async function init() {
      try {
        requireAuth("attorney");
      } catch (err) {
        console.warn("Auth required", err);
        return;
      }
      bindEvents();
      const activeItems = await loadActiveEscrows(true);
      await Promise.all([loadFinanceAlerts(activeItems), loadHistory()]);
    }

    function bindEvents() {
      portalBtn?.addEventListener("click", openBillingPortal);
      historyList?.addEventListener("click", (event) => {
        const btn = event.target.closest("[data-case-id]");
        if (!btn) return;
        const caseId = btn.getAttribute("data-case-id");
        if (!caseId) return;
        viewCase(caseId);
      });
      refreshEscrowsBtn?.addEventListener("click", () => {
        loadActiveEscrows(true, { syncAlerts: true });
      });
      escrowTableBody?.addEventListener("click", handleEscrowClick);
      financeAlertsEl?.addEventListener("click", handleAlertAction);
      document.addEventListener("click", handleGlobalClick);
    }

    async function loadActiveEscrows(showLoading = false, { syncAlerts = false } = {}) {
      if (!escrowTableBody) return [];
      if (showLoading) {
        escrowTableBody.innerHTML = `<tr><td colspan="6" class="history-empty">Loading active escrows…</td></tr>`;
      }
      try {
        const res = await secureFetch("/api/payments/escrow/active", { headers: { Accept: "application/json" } });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const payload = await res.json().catch(() => ({}));
        const items = Array.isArray(payload?.items) ? payload.items : [];
        cachedEscrows = items;
        if (!items.length) {
          escrowTableBody.innerHTML = `<tr><td colspan="6" class="history-empty">No funds currently held in escrow.</td></tr>`;
        } else {
          escrowTableBody.innerHTML = items.map(renderEscrowRow).join("");
        }
        if (syncAlerts) {
          await loadFinanceAlerts(items);
        }
        return items;
      } catch (err) {
        console.warn("Unable to load active escrows", err);
        escrowTableBody.innerHTML = `<tr><td colspan="6" class="history-empty error">Unable to load active escrow records.</td></tr>`;
        return [];
      }
    }

    function renderEscrowRow(entry = {}) {
      const caseName = escapeHtml(entry.caseName || entry.caseTitle || entry.title || "Case");
      const paralegal = escapeHtml(entry.paralegalName || "Paralegal pending");
      const amount = formatCurrency(entry.amountHeld ?? entry.amount ?? entry.totalAmount);
      const funded = formatDate(entry.fundedAt || entry.updatedAt);
      const statusLabel = formatStatusLabel(entry.status || "");
      const caseId = String(entry.caseId || entry.id || "");
      return `
        <tr>
          <td>${caseName}</td>
          <td>${paralegal}</td>
          <td>${amount}</td>
          <td>${funded}</td>
          <td><span class="pill">${statusLabel}</span></td>
          <td>
            <div class="action-drawer" data-case-id="${caseId}">
              <button type="button" class="action-toggle" aria-haspopup="true" aria-expanded="false">
                Actions <span aria-hidden="true">⋯</span>
              </button>
              <div class="action-menu" role="menu">
                <button type="button" data-escrow-action="view" data-case-id="${caseId}">View Case</button>
                <button type="button" data-escrow-action="release" data-case-id="${caseId}">Release Funds</button>
                <button type="button" data-escrow-action="messages" data-case-id="${caseId}">Message Paralegal</button>
              </div>
            </div>
          </td>
        </tr>
      `;
    }

    async function loadFinanceAlerts(activeItems) {
      if (!financeAlertsEl) return;
      financeAlertsEl.innerHTML = `<div class="finance-alert"><div><div class="alert-title">Checking finance alerts…</div><p>Give us a moment.</p></div></div>`;
      try {
        const [summaryRes, pendingRes] = await Promise.all([
          secureFetch("/api/payments/summary", { headers: { Accept: "application/json" } }),
          secureFetch("/api/payments/escrow/pending", { headers: { Accept: "application/json" } }),
        ]);
        if (!summaryRes.ok) throw new Error(`HTTP ${summaryRes.status}`);
        if (!pendingRes.ok) throw new Error(`HTTP ${pendingRes.status}`);
        const summary = await summaryRes.json().catch(() => ({}));
        const pendingPayload = await pendingRes.json().catch(() => ({}));
        const pendingItems = Array.isArray(pendingPayload?.items) ? pendingPayload.items : [];
        const activeList = Array.isArray(activeItems) ? activeItems : cachedEscrows;
        const alerts = buildFinanceAlerts({ summary, active: activeList, pending: pendingItems });
        renderFinanceAlerts(alerts);
      } catch (err) {
        console.warn("Unable to load finance alerts", err);
        financeAlertsEl.innerHTML = `<div class="finance-alert"><div><div class="alert-title">Finance alerts unavailable</div><p class="muted">Please refresh the page or try again shortly.</p></div></div>`;
      }
    }

    function buildFinanceAlerts({ active = [], pending = [] } = {}) {
      const alerts = [];
      if (pending.length) {
        const first = pending[0];
        const count = pending.length;
        const label = count === 1 ? first.caseName || "This case" : `${count} cases`;
        const summary = count === 1 ? `${first.paralegalName || "Your paralegal"} is ready to start.` : "Fund escrow to unblock your assignments.";
        alerts.push({
          id: `fund-${first.caseId}`,
          type: "fund",
          title: `${label} ${count === 1 ? "needs" : "need"} funding`,
          body: summary,
          actions: [
            first.checkoutUrl
              ? { type: "link", label: "Fund Now", href: first.checkoutUrl, external: true, primary: true }
              : { type: "view", label: "View Case", caseId: first.caseId, primary: true },
            { type: "view", label: "View Case", caseId: first.caseId },
          ],
        });
      }
      const releaseCandidates = active.filter((item) => isReleaseCandidate(item.status)).slice(0, 3);
      releaseCandidates.forEach((item) => {
        alerts.push({
          id: `release-${item.caseId}`,
          type: "release",
          title: `Release funds for ${item.caseName || "a case"}`,
          body: "The paralegal has wrapped. Release escrow to pay them.",
          actions: [
            { type: "release", label: "Release Funds", caseId: item.caseId, primary: true },
            { type: "view", label: "View Case", caseId: item.caseId },
            { type: "messages", label: "Message Paralegal", caseId: item.caseId },
          ],
        });
      });
      return alerts;
    }

    function renderFinanceAlerts(alerts = []) {
      if (!alerts.length) {
        financeAlertsEl.innerHTML = `
          <div class="finance-alert calm">
            <div>
              <div class="alert-title">No urgent finance actions</div>
              <p>You're caught up on escrow, funding, and payouts.</p>
            </div>
          </div>`;
        return;
      }
      financeAlertsEl.innerHTML = alerts.map(renderFinanceAlert).join("");
    }

    function renderFinanceAlert(alert) {
      const actionsHtml = (alert.actions || [])
        .map((action) => {
          if (action.type === "link" && action.href) {
            const target = action.external ? ' target="_blank" rel="noopener"' : "";
            return `<a class="pill-btn ${action.primary ? "primary" : ""}" href="${action.href}"${target}>${escapeHtml(action.label)}</a>`;
          }
          const attrs = [
            `class="pill-btn ${action.primary ? "primary" : ""}"`,
            `data-alert-action="${action.type}"`,
            action.caseId ? `data-case-id="${action.caseId}"` : "",
          ]
            .filter(Boolean)
            .join(" ");
          return `<button type="button" ${attrs}>${escapeHtml(action.label)}</button>`;
        })
        .join("");
      return `
        <article class="finance-alert ${alert.type || ""}">
          <div>
            <div class="alert-title">${escapeHtml(alert.title)}</div>
            <p>${escapeHtml(alert.body)}</p>
          </div>
          ${actionsHtml ? `<div class="alert-actions">${actionsHtml}</div>` : ""}
        </article>
      `;
    }

    function handleEscrowClick(event) {
      const toggle = event.target.closest(".action-toggle");
      if (toggle) {
        const drawer = toggle.closest(".action-drawer");
        toggleActionDrawer(drawer);
        return;
      }
      const actionBtn = event.target.closest("[data-escrow-action]");
      if (actionBtn) {
        const action = actionBtn.dataset.escrowAction;
        const caseId = actionBtn.dataset.caseId;
        closeActionDrawers();
        if (action === "view") {
          viewCase(caseId);
        } else if (action === "messages") {
          jumpToMessages(caseId);
        } else if (action === "release") {
          releaseEscrowCase(caseId, actionBtn);
        }
      }
    }

    function handleAlertAction(event) {
      const btn = event.target.closest("[data-alert-action]");
      if (!btn) return;
      const action = btn.dataset.alertAction;
      const caseId = btn.dataset.caseId;
      if (action === "view") {
        viewCase(caseId);
      } else if (action === "messages") {
        jumpToMessages(caseId);
      } else if (action === "release") {
        releaseEscrowCase(caseId, btn);
      }
    }

    function toggleActionDrawer(drawer) {
      if (!drawer) return;
      const willOpen = openDrawerEl !== drawer;
      closeActionDrawers();
      if (willOpen) {
        drawer.classList.add("open");
        drawer.querySelector(".action-toggle")?.setAttribute("aria-expanded", "true");
        openDrawerEl = drawer;
      }
    }

    function closeActionDrawers() {
      document.querySelectorAll(".action-drawer.open").forEach((drawer) => {
        drawer.classList.remove("open");
        drawer.querySelector(".action-toggle")?.setAttribute("aria-expanded", "false");
      });
      openDrawerEl = null;
    }

    function handleGlobalClick(event) {
      if (event.target.closest(".action-drawer")) return;
      closeActionDrawers();
    }

    async function loadHistory() {
      if (!historyList) return;
      historyList.innerHTML = `<div class="history-empty">Loading payment history…</div>`;
      try {
        const res = await secureFetch("/api/payments/history", { headers: { Accept: "application/json" } });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const payload = await res.json().catch(() => ({}));
        const items = Array.isArray(payload?.items)
          ? payload.items
          : Array.isArray(payload?.history)
          ? payload.history
          : Array.isArray(payload)
          ? payload
          : [];
        if (!items.length) {
          historyList.innerHTML = `<div class="history-empty">No completed payments yet.</div>`;
          return;
        }
        historyList.innerHTML = items.map(renderHistoryCard).join("");
      } catch (err) {
        console.warn("Unable to load payment history", err);
        historyList.innerHTML = `<div class="history-empty error">Unable to load payment history right now.</div>`;
      }
    }

    async function openBillingPortal() {
      if (!portalBtn) return;
      const originalText = portalBtn.textContent;
      portalBtn.disabled = true;
      portalBtn.textContent = "Opening…";
      try {
        const res = await secureFetch("/api/payments/portal", { method: "POST" });
        let data = {};
        try {
          data = await res.json();
        } catch (_) {
          data = {};
        }
        if (!res.ok || !data?.url) {
          throw new Error(data?.error || "Unable to open the Stripe portal right now.");
        }
        window.location.href = data.url;
      } catch (err) {
        console.error("Billing portal error", err);
        showToast(err.message || "Unable to open the Stripe portal.", "error");
        portalBtn.disabled = false;
        portalBtn.textContent = originalText;
      }
    }

    function renderHistoryCard(entry = {}) {
      const caseName = escapeHtml(entry.caseName || entry.caseTitle || entry.title || "Case");
      const jobTitle = escapeHtml(entry.jobTitle || caseName);
      const paralegal = escapeHtml(entry.paralegalName || "Assigned Paralegal");
      const amount = formatCurrency(entry.jobAmount ?? entry.amount ?? entry.totalAmount);
      const datePaid = formatDate(entry.releaseDate || entry.paidOutAt || entry.completedAt);
      const receipt = sanitizeUrl(entry.stripeReceiptUrl || entry.receiptUrl || entry.receipt);
      const receiptLink = receipt
        ? `<a class="link-button" href="${receipt}" target="_blank" rel="noopener">View Stripe Receipt</a>`
        : '<span class="muted">Receipt unavailable</span>';
      const caseId = String(entry.caseId || entry.id || "");
      return `
        <article class="history-card">
          <div class="history-primary">
            <div class="case-name">${caseName}</div>
            <div class="job-title">${jobTitle}</div>
            <div class="paralegal-name">Paralegal: ${paralegal}</div>
          </div>
          <div class="history-meta">
            <div class="meta-item">
              <span>Amount</span>
              <strong>${amount}</strong>
            </div>
            <div class="meta-item">
              <span>Date Paid</span>
              <strong>${datePaid}</strong>
            </div>
          </div>
          <div class="history-actions">
            ${receiptLink}
            <button type="button" data-case-id="${caseId}">View Case</button>
          </div>
        </article>
      `;
    }

    function releaseEscrowCase(caseId, trigger) {
      if (!caseId) return;
      const confirmRelease = window.confirm("Release funds for this case?");
      if (!confirmRelease) return;
      const btn = trigger;
      if (btn) {
        btn.disabled = true;
        btn.setAttribute("aria-busy", "true");
      }
      secureFetch("/api/payments/release", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ caseId }),
      })
        .then(async (res) => {
          let payload = {};
          try {
            payload = await res.json();
          } catch (_) {
            payload = {};
          }
          if (!res.ok) throw new Error(payload?.error || payload?.msg || "Unable to release funds.");
          showToast("Funds released successfully.", "success");
          await loadActiveEscrows(true, { syncAlerts: true });
        })
        .catch((err) => {
          console.error("Release escrow error", err);
          showToast(err.message || "Unable to release funds.", "error");
        })
        .finally(() => {
          if (btn) {
            btn.disabled = false;
            btn.removeAttribute("aria-busy");
          }
        });
    }

    function jumpToMessages(caseId) {
      if (!caseId) {
        showToast("Open a case to view messages.", "info");
        return;
      }
      window.location.href = `case-detail.html?caseId=${encodeURIComponent(caseId)}#messages`;
    }

    function formatCurrency(value) {
      const cents = normalizeToCents(value);
      return currencyFormatter.format(cents / 100);
    }

    function normalizeToCents(value) {
      if (typeof value === "number" && Number.isFinite(value)) {
        return Math.round(value);
      }
      if (typeof value === "string") {
        const cleaned = value.replace(/[^0-9.-]/g, "");
        if (!cleaned) return 0;
        const parsed = Number(cleaned);
        if (Number.isNaN(parsed)) return 0;
        return cleaned.includes(".") ? Math.round(parsed * 100) : Math.round(parsed);
      }
      return 0;
    }

    function isReleaseCandidate(status = "") {
      const normalized = String(status).toLowerCase();
      return ["awaiting_release", "release", "ready", "complete"].some((term) => normalized.includes(term));
    }

    function formatStatusLabel(status = "") {
      const safe = String(status || "In progress")
        .replace(/[_-]/g, " ")
        .trim();
      return safe ? safe.replace(/\b\w/g, (c) => c.toUpperCase()) : "In Progress";
    }

    function viewCase(caseId) {
      if (!caseId) return;
      window.location.href = `case-detail.html?caseId=${encodeURIComponent(caseId)}`;
    }

    function formatDate(raw) {
      if (!raw) return "—";
      const date = new Date(raw);
      if (Number.isNaN(date.getTime())) return "—";
      return date.toLocaleDateString(undefined, { month: "short", day: "numeric", year: "numeric" });
    }

    function sanitizeUrl(url = "") {
      if (!url) return "";
      const trimmed = String(url).trim();
      if (/^(https?:\/\/|\/)/i.test(trimmed)) {
        return trimmed.replace(/"/g, "%22");
      }
      return "";
    }

    function escapeHtml(value = "") {
      return String(value)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function showToast(message, type = "info") {
      const helper = window.toastUtils;
      if (helper?.show) {
        helper.show(message, { targetId: "toastBanner", type });
      }
    }
  </script>
</body>
</html>
