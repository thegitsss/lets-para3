<!DOCTYPE html>
<html lang="en">
<head>
  <style>body{opacity:1!important;visibility:visible!important}</style>
  <meta charset="UTF-8" />
  <title>Create New Case • Lets-ParaConnect</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="assets/styles.css" />
  <script type="module" src="assets/scripts/auth.js"></script>
  <script src="https://js.stripe.com/v3"></script>
  <style>
    :root{ --navy:#27394d; --brown:#8c7864; --bg:#f5f2ed; --line:#e8edf3; --ink:#5c4e3a; }
    body{ background:var(--bg); color:var(--ink); font-family:Georgia,serif; }
    header{ background:#fff; border-bottom:1px solid var(--line); padding:14px 18px; display:flex; align-items:center; justify-content:space-between; }
    header a{ color:var(--brown); text-decoration:none; font-weight:700; }
    main{ max-width:840px; margin:28px auto; padding:0 16px; }
    h1{ color:var(--navy); margin:0 0 10px; }
    .card{ background:#fff; border:1px solid var(--line); border-radius:14px; box-shadow:0 2px 10px rgba(0,0,0,.04); padding:16px; }

    .field{ display:grid; gap:6px; margin:10px 0; }
    .field input,.field textarea{ padding:.8rem; border:1px solid var(--line); border-radius:10px; font:inherit; outline:none; background:#fff; }
    .field input:focus,.field textarea:focus{ border-color:var(--brown); box-shadow:0 0 0 4px rgba(140,120,100,.15); }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .btn{ border:0; border-radius:10px; padding:.7rem 1.1rem; cursor:pointer; font-weight:600; }
    .btn.primary{ background:var(--navy); color:#fff; }
    .btn.secondary{ background:#fff; border:1px solid var(--line); }
    .hint{ color:#64748b; }
    .ok{ color:#1f7a4a; }
    .bad{ color:#b04747; }

    .fade-in{ animation:fade .25s ease; } @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

    /* Modal */
    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.35); backdrop-filter:blur(6px); }
    .modal.active{ display:flex; }
    .modal-card{ width:min(560px,92vw); background:#fff; border-radius:16px; box-shadow:0 16px 44px rgba(0,0,0,.28); padding:18px; }
    .modal-head{ display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; }
    .x{ background:transparent; border:0; font-size:20px; cursor:pointer; }
    .grid{ display:grid; gap:12px; }
    #payment-element{ margin-top:8px; }
  </style>
</head>
<body>
  <header>
    <a href="index.html">← Return</a>
    <a href="my-cases.html">My Cases</a>
  </header>

  <main>
    <h1>Create New Case</h1>
    <p class="hint" style="margin:4px 0 14px">
      Provide a clear title and concise details. You can fund escrow now or later.
    </p>

    <section class="card fade-in">
      <form id="caseForm" novalidate>
        <div class="field">
          <label for="title">Title <span class="hint">(required)</span></label>
          <input id="title" name="title" maxlength="140" required placeholder="e.g., Draft Motion for Summary Judgment" />
        </div>

        <div class="field">
          <label for="details">Details <span class="hint">(required)</span></label>
          <textarea id="details" name="details" rows="6" maxlength="4000" placeholder="Scope, key facts, deadlines, preferred experience…" required></textarea>
          <div class="hint"><span id="charCount" aria-live="polite">0</span>/4000</div>
        </div>

        <div id="msg" class="hint" role="status" aria-live="polite" style="min-height:1.2rem; margin:.25rem 0 .5rem"></div>

        <div class="row" style="justify-content:flex-end">
          <button type="button" class="btn secondary" id="resetBtn">Reset</button>
          <button type="submit" class="btn primary" id="submitBtn">Create Case</button>
        </div>
      </form>
    </section>
  </main>

  <!-- Escrow modal -->
  <div id="escrowModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head">
        <h2 style="margin:0">Fund Escrow</h2>
        <button class="x" id="closeModal" aria-label="Close">×</button>
      </div>
      <div class="grid">
        <p class="hint" id="escrowMsg" aria-live="polite">Enter the total budget to deposit for this case.</p>
        <div class="row" style="gap:8px">
          <label for="amountUsd" style="min-width:120px">Amount (USD)</label>
          <input id="amountUsd" type="number" min="1" step="1" placeholder="e.g., 500 (=$500)" style="max-width:180px" />
        </div>

        <!-- Stripe Payment Element will mount here -->
        <div id="payment-element" style="display:none"></div>

        <div class="row" style="justify-content:flex-end">
          <button class="btn secondary" id="fundLater">Fund later</button>
          <button class="btn primary" id="continuePay">Continue</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { secureFetch, fetchCSRF } from './assets/scripts/auth.js';
    import { ensureIntent, createElements, mountPaymentElement, confirmPayment } from './assets/scripts/payments.js';

    // Gate: must be authenticated via cookie session
    try {
      const r = await fetch('/api/users/me', { credentials:'include' });
      if (!r.ok) throw new Error();
      const me = await r.json();
      if (!me?.id) throw new Error();
    } catch {
      location.href = 'login.html';
    }

    // Warm CSRF
    fetchCSRF().catch(()=>{});

    // Elements
    const form       = document.getElementById('caseForm');
    const titleEl    = document.getElementById('title');
    const detailsEl  = document.getElementById('details');
    const msgEl      = document.getElementById('msg');
    const submitBtn  = document.getElementById('submitBtn');
    const resetBtn   = document.getElementById('resetBtn');
    const countEl    = document.getElementById('charCount');

    // Modal bits
    const modal      = document.getElementById('escrowModal');
    const closeModal = document.getElementById('closeModal');
    const fundLater  = document.getElementById('fundLater');
    const continueBtn= document.getElementById('continuePay');
    const amountEl   = document.getElementById('amountUsd');
    const escrowMsg  = document.getElementById('escrowMsg');
    const payHost    = document.getElementById('payment-element');

    let createdCaseId = null;
    let elements = null;

    // live counter
    const updateCount = () => { countEl.textContent = String((detailsEl.value || '').length); };
    detailsEl.addEventListener('input', updateCount); updateCount();

    resetBtn.addEventListener('click', (e)=>{
      e.preventDefault();
      form.reset(); updateCount(); msgEl.textContent=''; msgEl.className='hint';
    });

    // Create case
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const title = titleEl.value.trim();
      const details = detailsEl.value.trim();
      if (!title || !details) { msgEl.className='bad'; msgEl.textContent='Title and details are required.'; return; }

      msgEl.className='hint'; msgEl.textContent='Creating case…';
      submitBtn.disabled = true;

      try {
        await fetchCSRF().catch(()=>{});
        const res = await secureFetch('/api/cases', { method:'POST', body: { title, details }});
        const data = await res.json().catch(()=> ({}));
        if (!res.ok) throw new Error(data?.msg || 'Unable to create case');

        createdCaseId = data.id || data._id;
        msgEl.className='ok';
        msgEl.textContent = data.msg || 'Case created.';

        // Open escrow modal
        modal.classList.add('active');
        modal.setAttribute('aria-hidden','false');
      } catch (err) {
        msgEl.className='bad';
        msgEl.textContent = err?.message || 'Something went wrong.';
        submitBtn.disabled = false;
      }
    });

    // Navigation helpers
    function goToCase(){
      if (createdCaseId) {
        localStorage.setItem('openCaseId', createdCaseId);
        location.href = 'case-detail.html';
      } else {
        location.href = 'my-cases.html';
      }
    }
    closeModal.onclick = () => { modal.classList.remove('active'); modal.setAttribute('aria-hidden','true'); goToCase(); };
    fundLater.onclick  = (e) => { e.preventDefault(); modal.classList.remove('active'); goToCase(); };

    // Continue → save budget → create PI → mount Payment Element
    continueBtn.addEventListener('click', async (e)=>{
      e.preventDefault();
      if (!createdCaseId) return;

      const amt = Number(amountEl.value || 0);
      if (!amt || amt < 1) { escrowMsg.className='bad'; escrowMsg.textContent='Enter a valid USD amount (minimum $1).'; return; }

      escrowMsg.className='hint'; escrowMsg.textContent='Saving budget…';
      continueBtn.disabled = true;

      try {
        await fetchCSRF().catch(()=>{});
        // Step 1: save budget on the case
        const r1 = await secureFetch(`/api/cases/${encodeURIComponent(createdCaseId)}/budget`, {
          method:'PATCH', body: { amountUsd: amt, currency: 'usd' }
        });
        const b = await r1.json().catch(()=> ({}));
        if (!r1.ok) throw new Error(b?.msg || 'Failed to save budget');

        // Step 2: ensure a PaymentIntent and get client_secret
        const clientSecret = await ensureIntent(createdCaseId, secureFetch);

        // Step 3: mount Stripe Payment Element
        elements = await createElements(clientSecret);
        mountPaymentElement(elements, payHost);
        escrowMsg.className='hint';
        escrowMsg.textContent = 'Enter your payment details to fund escrow.';

        // Swap button action to confirm
        continueBtn.textContent = 'Fund Escrow';
        continueBtn.disabled = false;
        continueBtn.onclick = doConfirmPayment;
      } catch (err) {
        escrowMsg.className='bad';
        escrowMsg.textContent = err?.message || 'Unable to start payment.';
        continueBtn.disabled = false;
      }
    });

    async function doConfirmPayment(e){
      e.preventDefault();
      if (!elements) return;
      continueBtn.disabled = true;
      escrowMsg.className='hint';
      escrowMsg.textContent = 'Confirming payment…';

      const { error, paymentIntent } = await confirmPayment(elements);

      if (error) {
        escrowMsg.className='bad';
        escrowMsg.textContent = error.message || 'Payment failed.';
        continueBtn.disabled = false;
        return;
      }

      if (paymentIntent && paymentIntent.status === 'succeeded') {
        escrowMsg.className='ok';
        escrowMsg.textContent = 'Escrow funded. Redirecting…';
        setTimeout(goToCase, 800);
      } else {
        escrowMsg.className='hint';
        escrowMsg.textContent = `Payment status: ${paymentIntent?.status || 'processing'}. Redirecting…`;
        setTimeout(goToCase, 800);
      }
    }
  </script>
</body>
</html>
